<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economics Games Hub</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="../styles.css">
    <style>
        .hub-container {
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }
        .game-card {
            height: 100%;
            transition: transform 0.3s;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .game-card .card-img-top {
            height: 180px;
            object-fit: cover;
        }
        .game-card .card-body {
            padding: 1.25rem;
        }
        .game-card .card-title {
            font-weight: bold;
            margin-bottom: 0.75rem;
        }
        .game-card .card-text {
            color: #6c757d;
            margin-bottom: 1rem;
        }
        .game-card .btn {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .banner {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .banner h1 {
            color: #007bff;
            margin-bottom: 10px;
        }
        .banner p {
            font-size: 1.1rem;
            color: #6c757d;
        }
        .auth-container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .auth-tabs {
            margin-bottom: 20px;
        }
        .auth-form {
            display: none;
        }
        .auth-form.active {
            display: block;
        }
        .user-info {
            display: none;
            padding: 15px;
            background-color: #e9f7fe;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .join-form {
            margin-top: 15px;
            padding: 15px;
            background-color: #f0f9ff;
            border-radius: 10px;
            display: none;
        }
        .ta-actions {
            margin-top: 15px;
            padding: 15px;
            background-color: #fff8e1;
            border-radius: 10px;
            display: none;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Economics Games</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Course Home</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Games Hub</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item" id="user-nav-info" style="display: none;">
                        <span class="navbar-text mr-3">
                            Welcome, <span id="nav-user-name">User</span>
                        </span>
                    </li>
                    <li class="nav-item" id="logout-nav-btn" style="display: none;">
                        <button id="logout-btn" class="btn btn-outline-light btn-sm">Logout</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container hub-container">
        <div class="banner">
            <h1>Economics Games Hub</h1>
            <p>Interactive games for learning economic concepts</p>
        </div>
        
        <!-- Authentication Section -->
        <div id="auth-section">
            <!-- User Info (shown when logged in) -->
            <div id="user-info" class="user-info">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Welcome, <span id="user-name">User</span>!</h4>
                        <p id="user-role-info">You are logged in as a <span id="user-role">student</span>.</p>
                    </div>
                    <div class="col-md-6 text-right">
                        <button id="logout-button" class="btn btn-outline-primary">Logout</button>
                    </div>
                </div>
                
                <!-- Join Class Form (for students) -->
                <div id="join-form" class="join-form">
                    <h5>Join a Class Session</h5>
                    <form id="join-session-form" class="form-inline">
                        <div class="form-group mb-2 mr-2">
                            <label for="join-code" class="sr-only">Join Code</label>
                            <input type="text" class="form-control" id="join-code" placeholder="Enter join code">
                        </div>
                        <button type="submit" class="btn btn-primary mb-2">Join Session</button>
                    </form>
                    <div id="join-error" class="alert alert-danger mt-2" style="display: none;"></div>
                </div>
                
                <!-- TA Actions (for TAs) -->
                <div id="ta-actions" class="ta-actions">
                    <h5>TA Actions</h5>
                    <a href="ta-dashboard.html" class="btn btn-info">Go to TA Dashboard</a>
                </div>
            </div>
            
            <!-- Authentication Forms (shown when not logged in) -->
            <div id="auth-container" class="auth-container">
                <ul class="nav nav-pills auth-tabs" id="auth-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" id="student-tab" href="#student-form">Student</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="ta-tab" href="#ta-form">TA</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="guest-tab" href="#guest-form">Guest</a>
                    </li>
                </ul>
                
                <!-- Student Form -->
                <div id="student-form" class="auth-form active">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Login</h5>
                                </div>
                                <div class="card-body">
                                    <form id="student-login-form">
                                        <div class="form-group">
                                            <label for="login-email">Email</label>
                                            <input type="email" class="form-control" id="login-email" required>
                                        </div>
                                        <div id="login-error" class="alert alert-danger" style="display: none;"></div>
                                        <button type="submit" class="btn btn-primary btn-block">Login</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">Register</h5>
                                </div>
                                <div class="card-body">
                                    <form id="student-register-form">
                                        <div class="form-group">
                                            <label for="register-name">Full Name</label>
                                            <input type="text" class="form-control" id="register-name" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="register-email">Email</label>
                                            <input type="email" class="form-control" id="register-email" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="register-join-code">Join Code (Optional)</label>
                                            <input type="text" class="form-control" id="register-join-code" placeholder="Enter if joining a class session">
                                        </div>
                                        <div id="register-error" class="alert alert-danger" style="display: none;"></div>
                                        <button type="submit" class="btn btn-success btn-block">Register</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- TA Form -->
                <div id="ta-form" class="auth-form">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">TA Login</h5>
                        </div>
                        <div class="card-body">
                            <form id="ta-login-form">
                                <div class="form-group">
                                    <label for="ta-id">TA Name</label>
                                    <select class="form-control" id="ta-id" required>
                                        <option value="">Select TA</option>
                                        <option value="akshay">Akshay</option>
                                        <option value="simran">Simran</option>
                                        <option value="camilla">Camilla</option>
                                        <option value="huiyann">Hui Yann</option>
                                        <option value="lars">Lars</option>
                                        <option value="luorao">Luorao</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="ta-passcode">Passcode</label>
                                    <input type="password" class="form-control" id="ta-passcode" required>
                                </div>
                                <div id="ta-error" class="alert alert-danger" style="display: none;"></div>
                                <button type="submit" class="btn btn-info btn-block">Login</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Guest Form -->
                <div id="guest-form" class="auth-form">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">Play as Guest</h5>
                        </div>
                        <div class="card-body">
                            <p>You can play games without registering, but your progress won't be saved between sessions.</p>
                            <div class="form-group">
                                <label for="guest-name">Your Name (for Leaderboard)</label>
                                <input type="text" class="form-control" id="guest-name" placeholder="Enter your name">
                            </div>
                            <button id="guest-continue-btn" class="btn btn-secondary btn-block">Continue as Guest</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Games Section -->
        <h2 class="mb-4">Available Games</h2>
        <div class="row">
            <!-- Investment Odyssey -->
            <div class="col-md-6 mb-4">
                <div class="game-card card">
                    <img src="../images/investment-game.jpg" class="card-img-top" alt="Investment Odyssey">
                    <div class="card-body">
                        <h5 class="card-title">Investment Odyssey</h5>
                        <p class="card-text">Manage an investment portfolio and navigate market volatility to maximize returns.</p>
                        <div id="investment-odyssey-buttons">
                            <!-- Buttons will be dynamically added based on auth state -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- More games can be added here -->
            <div class="col-md-6 mb-4">
                <div class="game-card card">
                    <img src="../images/coming-soon.jpg" class="card-img-top" alt="Coming Soon">
                    <div class="card-body">
                        <h5 class="card-title">More Games Coming Soon</h5>
                        <p class="card-text">Stay tuned for more economics games to be added in the future.</p>
                        <button class="btn btn-secondary" disabled>Coming Soon</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <a href="../index.html" class="btn btn-outline-primary">Back to Course Website</a>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Other Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script>
    
    <!-- Custom Scripts -->
    <script src="js/firebase-config-new.js"></script>
    <script src="js/auth-service-new.js"></script>
    <script src="js/game-service.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize auth tabs
            initAuthTabs();
            
            // Check authentication status
            checkAuthStatus();
            
            // Set up event listeners
            setupEventListeners();
        });
        
        // Initialize authentication tabs
        function initAuthTabs() {
            document.querySelectorAll('.auth-tabs .nav-link').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all tabs and forms
                    document.querySelectorAll('.auth-tabs .nav-link').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Show corresponding form
                    const formId = this.getAttribute('href');
                    document.querySelector(formId).classList.add('active');
                });
            });
        }
        
        // Check authentication status
        function checkAuthStatus() {
            if (EconGames.Auth.isLoggedIn()) {
                // User is logged in
                const session = EconGames.Auth.getSession();
                
                // Show user info
                document.getElementById('user-info').style.display = 'block';
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('user-name').textContent = session.name;
                document.getElementById('user-role').textContent = session.role;
                
                // Show nav user info
                document.getElementById('user-nav-info').style.display = 'block';
                document.getElementById('logout-nav-btn').style.display = 'block';
                document.getElementById('nav-user-name').textContent = session.name;
                
                // Show role-specific elements
                if (session.role === 'student') {
                    document.getElementById('join-form').style.display = 'block';
                    document.getElementById('ta-actions').style.display = 'none';
                } else if (session.role === 'ta') {
                    document.getElementById('join-form').style.display = 'none';
                    document.getElementById('ta-actions').style.display = 'block';
                }
                
                // Update game buttons
                updateGameButtons(true, session.role, session.gameSession);
            } else if (localStorage.getItem('guestMode') === 'true') {
                // Guest mode
                const guestName = localStorage.getItem('guestName') || 'Guest';
                
                // Show user info
                document.getElementById('user-info').style.display = 'block';
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('user-name').textContent = guestName + ' (Guest)';
                document.getElementById('user-role').textContent = 'guest';
                document.getElementById('user-role-info').textContent = 'You are playing as a guest.';
                
                // Show nav user info
                document.getElementById('user-nav-info').style.display = 'block';
                document.getElementById('logout-nav-btn').style.display = 'block';
                document.getElementById('nav-user-name').textContent = guestName + ' (Guest)';
                
                // Hide role-specific elements
                document.getElementById('join-form').style.display = 'none';
                document.getElementById('ta-actions').style.display = 'none';
                
                // Update game buttons
                updateGameButtons(true, 'guest', null);
            } else {
                // Not logged in
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('auth-container').style.display = 'block';
                
                // Hide nav user info
                document.getElementById('user-nav-info').style.display = 'none';
                document.getElementById('logout-nav-btn').style.display = 'none';
                
                // Update game buttons
                updateGameButtons(false, null, null);
            }
        }
        
        // Update game buttons based on authentication status
        function updateGameButtons(isLoggedIn, role, gameSession) {
            const investmentButtons = document.getElementById('investment-odyssey-buttons');
            investmentButtons.innerHTML = '';
            
            if (isLoggedIn) {
                if (role === 'student' || role === 'guest') {
                    // Add single player button
                    const singlePlayerBtn = document.createElement('a');
                    singlePlayerBtn.href = 'investment-odyssey/single-player-game.html';
                    singlePlayerBtn.className = 'btn btn-primary mr-2';
                    singlePlayerBtn.textContent = 'Play Single Player';
                    investmentButtons.appendChild(singlePlayerBtn);
                    
                    // Add leaderboard button
                    const leaderboardBtn = document.createElement('a');
                    leaderboardBtn.href = 'investment-odyssey/leaderboard-new.html';
                    leaderboardBtn.className = 'btn btn-info';
                    leaderboardBtn.textContent = 'View Leaderboard';
                    investmentButtons.appendChild(leaderboardBtn);
                    
                    // Add class game button if in a session
                    if (gameSession) {
                        const classGameBtn = document.createElement('a');
                        classGameBtn.href = 'investment-odyssey/class-game.html';
                        classGameBtn.className = 'btn btn-success mt-2';
                        classGameBtn.textContent = 'Play Class Game';
                        investmentButtons.appendChild(classGameBtn);
                    }
                } else if (role === 'ta') {
                    // Add TA dashboard button
                    const dashboardBtn = document.createElement('a');
                    dashboardBtn.href = 'ta-dashboard.html';
                    dashboardBtn.className = 'btn btn-info mr-2';
                    dashboardBtn.textContent = 'Manage Sessions';
                    investmentButtons.appendChild(dashboardBtn);
                    
                    // Add leaderboard button
                    const leaderboardBtn = document.createElement('a');
                    leaderboardBtn.href = 'investment-odyssey/leaderboard-new.html';
                    leaderboardBtn.className = 'btn btn-secondary';
                    leaderboardBtn.textContent = 'View Leaderboard';
                    investmentButtons.appendChild(leaderboardBtn);
                }
            } else {
                // Not logged in - show login prompt
                const loginPrompt = document.createElement('div');
                loginPrompt.className = 'alert alert-info mb-2';
                loginPrompt.textContent = 'Please log in or continue as guest to play.';
                investmentButtons.appendChild(loginPrompt);
                
                // Add view leaderboard button
                const leaderboardBtn = document.createElement('a');
                leaderboardBtn.href = 'investment-odyssey/leaderboard-new.html';
                leaderboardBtn.className = 'btn btn-info';
                leaderboardBtn.textContent = 'View Leaderboard';
                investmentButtons.appendChild(leaderboardBtn);
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Student login form
            document.getElementById('student-login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('login-email').value;
                const errorElement = document.getElementById('login-error');
                
                try {
                    const result = await EconGames.Auth.loginStudent(email);
                    
                    if (result.success) {
                        // Refresh auth status
                        checkAuthStatus();
                    } else {
                        errorElement.textContent = result.error;
                        errorElement.style.display = 'block';
                    }
                } catch (error) {
                    errorElement.textContent = error.message;
                    errorElement.style.display = 'block';
                }
            });
            
            // Student registration form
            document.getElementById('student-register-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const joinCode = document.getElementById('register-join-code').value;
                const errorElement = document.getElementById('register-error');
                
                try {
                    const result = await EconGames.Auth.registerStudent(name, email);
                    
                    if (result.success) {
                        if (joinCode) {
                            // Join game session if join code provided
                            const joinResult = await EconGames.Auth.joinGameSession(joinCode);
                            
                            if (joinResult.success) {
                                // Redirect to game
                                window.location.href = 'investment-odyssey/class-game.html';
                            } else {
                                errorElement.textContent = joinResult.error;
                                errorElement.style.display = 'block';
                            }
                        } else {
                            // Refresh auth status
                            checkAuthStatus();
                        }
                    } else {
                        errorElement.textContent = result.error;
                        errorElement.style.display = 'block';
                    }
                } catch (error) {
                    errorElement.textContent = error.message;
                    errorElement.style.display = 'block';
                }
            });
            
            // TA login form
            document.getElementById('ta-login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const taId = document.getElementById('ta-id').value;
                const passcode = document.getElementById('ta-passcode').value;
                const errorElement = document.getElementById('ta-error');
                
                try {
                    const result = await EconGames.Auth.loginTA(taId, passcode);
                    
                    if (result.success) {
                        // Refresh auth status
                        checkAuthStatus();
                    } else {
                        errorElement.textContent = result.error;
                        errorElement.style.display = 'block';
                    }
                } catch (error) {
                    errorElement.textContent = error.message;
                    errorElement.style.display = 'block';
                }
            });
            
            // Guest continue button
            document.getElementById('guest-continue-btn').addEventListener('click', function() {
                const guestName = document.getElementById('guest-name').value || 'Guest';
                
                // Store guest name in localStorage
                localStorage.setItem('guestName', guestName);
                localStorage.setItem('guestMode', 'true');
                
                // Refresh auth status
                checkAuthStatus();
            });
            
            // Logout buttons
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Join session form
            document.getElementById('join-session-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const joinCode = document.getElementById('join-code').value;
                const errorElement = document.getElementById('join-error');
                
                if (!joinCode) {
                    errorElement.textContent = 'Please enter a join code';
                    errorElement.style.display = 'block';
                    return;
                }
                
                try {
                    const result = await EconGames.Auth.joinGameSession(joinCode);
                    
                    if (result.success) {
                        // Redirect to game
                        window.location.href = 'investment-odyssey/class-game.html';
                    } else {
                        errorElement.textContent = result.error;
                        errorElement.style.display = 'block';
                    }
                } catch (error) {
                    errorElement.textContent = error.message;
                    errorElement.style.display = 'block';
                }
            });
        }
        
        // Handle logout
        function handleLogout() {
            // Clear guest mode
            localStorage.removeItem('guestMode');
            localStorage.removeItem('guestName');
            
            // Logout
            EconGames.Auth.logout();
            
            // Refresh auth status
            checkAuthStatus();
        }
    </script>
</body>
</html>
