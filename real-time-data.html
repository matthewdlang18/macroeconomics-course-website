<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Real-Time Data - Principles of Macroeconomics</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  .banner-container {
    position: relative;
    width: 100%;
    height: 0;
    padding-bottom: 25%; /* This sets the aspect ratio of the container */
    min-height: 120px; /* Minimum height on small screens */
    max-height: 400px; /* Maximum height on large screens */
    overflow: hidden;
  }

  .banner-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .banner-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.4);
  }

  /* Mobile-first responsive text sizes */
  .page-title {
    font-size: 1.5rem;
    font-weight: bold;
  }

  .page-subtitle {
    font-size: 1rem;
    margin-top: 0.5rem;
  }

  /* Medium screens */
  @media (min-width: 640px) {
    .page-title {
      font-size: 2rem;
    }
    .page-subtitle {
      font-size: 1.25rem;
    }
  }

  /* Large screens */
  @media (min-width: 1024px) {
    .page-title {
      font-size: 2.5rem;
    }
    .page-subtitle {
      font-size: 1.5rem;
    }
  }

  /* Navigation links in banner */
  .nav-links {
    position: absolute;
    top: 1rem;
    left: 1rem;
    display: flex;
    gap: 1rem;
  }

  .nav-links a {
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    font-size: 0.875rem;
    transition: color 0.2s;
  }

  .nav-links a:hover {
    color: white;
  }

  .nav-links a.active {
    color: white;
    font-weight: 500;
  }

  /* Heatmap styles */
  .heatmap-container {
    overflow-x: auto;
  }

  /* Category selector styles */
  .category-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .category-btn {
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .category-btn.selected {
    background-color: #3b82f6;
    color: white;
  }

  .category-btn:not(.selected) {
    background-color: #f3f4f6;
    color: #374151;
  }

  .category-btn:hover:not(.selected) {
    background-color: #e5e7eb;
  }

  /* Tab styles */
  .tab-button {
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }

  .tab-button.active {
    border-bottom-color: #3b82f6;
    color: #3b82f6;
  }

  .tab-button:not(.active) {
    color: #6b7280;
  }

  .tab-button:hover:not(.active) {
    color: #3b82f6;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }
</style>
</head>
<body class="bg-gray-50">
<!-- Header -->
<header>
  <div class="banner-container">
    <img src="./images/banner19.png" alt="Real-Time Data Banner" class="banner-image">
    <div class="banner-overlay">
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="materials.html">Materials</a>
        <a href="real-time-data.html" class="active">Real-Time Data</a>
        <a href="faq.html">FAQ</a>
      </div>
      <div class="text-center text-white px-4">
        <h1 class="page-title">Real-Time Economic Data</h1>
        <p class="page-subtitle">Interactive Visualizations of Key Economic Indicators</p>
      </div>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="container mx-auto py-8 px-4">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-semibold">Economic Data Dashboard</h2>
    <a href="materials.html" class="inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">← Back to Materials</a>
  </div>

  <!-- Tabs Navigation -->
  <div class="border-b border-gray-200 mb-6">
    <div class="flex">
      <button id="tab-cpi" class="tab-button active">Consumer Price Index (CPI)</button>
      <button id="tab-gdp" class="tab-button">GDP</button>
      <button id="tab-unemployment" class="tab-button">Unemployment</button>
    </div>
  </div>

  <!-- CPI Tab Content -->
  <div id="content-cpi" class="tab-content active">
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
      <h3 class="text-xl font-bold text-blue-700 mb-4">Consumer Price Index (CPI) Analysis</h3>
      <p class="mb-4">Explore 12-month percentage changes in the Consumer Price Index by category since 2005. Use the controls below to customize your view.</p>



      <!-- Heatmap Visualization -->
      <div class="mb-8">
        <h4 class="text-lg font-semibold mb-3">CPI Heatmap by Category</h4>
        <p class="text-sm text-gray-600 mb-4">This heatmap shows the intensity of 12-month percentage changes in CPI across different categories. Red indicates inflation, blue indicates deflation.</p>

        <!-- Heatmap Date Selector -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div>
            <label for="heatmap-month" class="block text-sm font-medium text-gray-700 mb-1">Starting Month</label>
            <select id="heatmap-month" class="w-full p-2 border border-gray-300 rounded-md">
              <option value="0">January</option>
              <option value="1">February</option>
              <option value="2">March</option>
              <option value="3">April</option>
              <option value="4">May</option>
              <option value="5">June</option>
              <option value="6">July</option>
              <option value="7">August</option>
              <option value="8">September</option>
              <option value="9">October</option>
              <option value="10">November</option>
              <option value="11">December</option>
            </select>
          </div>
          <div>
            <label for="heatmap-year" class="block text-sm font-medium text-gray-700 mb-1">Starting Year</label>
            <select id="heatmap-year" class="w-full p-2 border border-gray-300 rounded-md">
              <option value="2005">2005</option>
              <option value="2006">2006</option>
              <option value="2007">2007</option>
              <option value="2008">2008</option>
              <option value="2009">2009</option>
              <option value="2010">2010</option>
              <option value="2011">2011</option>
              <option value="2012">2012</option>
              <option value="2013">2013</option>
              <option value="2014">2014</option>
              <option value="2015">2015</option>
              <option value="2016">2016</option>
              <option value="2017">2017</option>
              <option value="2018">2018</option>
              <option value="2019">2019</option>
              <option value="2020">2020</option>
              <option value="2021">2021</option>
              <option value="2022">2022</option>
              <option value="2023">2023</option>
              <option value="2024" selected>2024</option>
              <option value="2025">2025</option>
            </select>
          </div>
          <div>
            <label for="heatmap-months" class="block text-sm font-medium text-gray-700 mb-1">Number of Months</label>
            <select id="heatmap-months" class="w-full p-2 border border-gray-300 rounded-md">
              <option value="6">6 months</option>
              <option value="12" selected>12 months</option>
              <option value="18">18 months</option>
              <option value="24">24 months</option>
              <option value="36">36 months</option>
            </select>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table id="cpi-heatmap-table" class="min-w-full border-collapse">
            <thead>
              <tr>
                <th class="p-2 border bg-gray-100 text-left">US CPI Heatmap</th>
                <th class="p-2 border bg-gray-100 text-center" colspan="36" id="month-header">12-month percentage change (%)</th>
              </tr>
              <tr id="month-row">
                <th class="p-2 border bg-gray-100"></th>
                <!-- Month columns will be added dynamically -->
              </tr>
            </thead>
            <tbody id="heatmap-body">
              <!-- Categories and values will be added dynamically -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Category Line Chart -->
      <div>
        <h4 class="text-lg font-semibold mb-3">12-month percentage change, Consumer Price Index, selected categories</h4>
        <p class="text-sm text-gray-600 mb-4">Select categories below to compare their inflation trends over time. Hover over the chart to view data.</p>

        <!-- Category Selector -->
        <div class="category-selector mb-4" id="category-selector">
          <!-- Will be populated by JavaScript -->
        </div>

        <!-- Line Chart -->
        <div class="border p-4 bg-white">
          <div class="mb-2">
            <strong>Percent</strong>
          </div>
          <div style="height: 800px;">
            <canvas id="cpi-line-chart"></canvas>
          </div>
          <div class="mt-4 text-sm text-gray-600">
            <p>Note: Shaded areas represent recessions, as determined by the National Bureau of Economic Research.</p>
            <p>Source: U.S. Bureau of Labor Statistics.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- GDP Tab Content -->
  <div id="content-gdp" class="tab-content">
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
      <h3 class="text-xl font-bold text-blue-700 mb-4">Gross Domestic Product (GDP) Analysis</h3>
      <p class="mb-4">Explore U.S. GDP data from 1947 to present, including components, growth rates, and industry breakdowns.</p>

      <!-- GDP Dashboard Controls -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div>
          <label for="gdp-view-type" class="block text-sm font-medium text-gray-700 mb-1">View Type</label>
          <select id="gdp-view-type" class="w-full p-2 border border-gray-300 rounded-md">
            <option value="levels">GDP Levels</option>
            <option value="growth">Growth Rates</option>
            <option value="components">Component Breakdown</option>
          </select>
        </div>
        <div>
          <label for="gdp-data-type" class="block text-sm font-medium text-gray-700 mb-1">Data Type</label>
          <select id="gdp-data-type" class="w-full p-2 border border-gray-300 rounded-md">
            <option value="real">Real GDP (2017 Dollars)</option>
            <option value="nominal">Nominal GDP</option>
            <option value="both">Compare Real & Nominal</option>
          </select>
        </div>
        <div>
          <label for="gdp-time-period" class="block text-sm font-medium text-gray-700 mb-1">Time Period</label>
          <select id="gdp-time-period" class="w-full p-2 border border-gray-300 rounded-md">
            <option value="5years">Last 5 Years</option>
            <option value="10years">Last 10 Years</option>
            <option value="20years">Last 20 Years</option>
            <option value="all" selected>All Available Data</option>
          </select>
        </div>
      </div>



      <!-- GDP Key Statistics Panel -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-5 rounded-lg border border-blue-200 shadow-md hover:shadow-lg transition-shadow duration-300">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold text-blue-800">Current GDP</h4>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
            </svg>
          </div>
          <p id="current-gdp" class="text-3xl font-bold text-blue-700">$--.- trillion</p>
          <div class="flex items-center mt-2">
            <p id="current-gdp-date" class="text-xs text-gray-600">As of Q-, 20--</p>
            <div class="ml-auto flex items-center text-xs">
              <span id="gdp-rank" class="px-2 py-1 rounded bg-blue-200 text-blue-800 font-medium">Rank: #1 globally</span>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-br from-green-50 to-green-100 p-5 rounded-lg border border-green-200 shadow-md hover:shadow-lg transition-shadow duration-300">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold text-green-800">Latest Growth Rate</h4>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd" />
            </svg>
          </div>
          <p id="latest-growth" class="text-3xl font-bold text-green-700">-.--%</p>
          <div class="flex items-center mt-2">
            <p class="text-xs text-gray-600">Quarter-over-Quarter (Annualized)</p>
            <div class="ml-auto flex items-center text-xs">
              <span id="growth-comparison" class="px-2 py-1 rounded bg-green-200 text-green-800 font-medium">vs -.-% avg</span>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-5 rounded-lg border border-purple-200 shadow-md hover:shadow-lg transition-shadow duration-300">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold text-purple-800">Year-Over-Year Growth</h4>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-500" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
            </svg>
          </div>
          <p id="yoy-growth" class="text-3xl font-bold text-purple-700">-.--%</p>
          <div class="flex items-center mt-2">
            <p class="text-xs text-gray-600">Compared to same quarter last year</p>
            <div class="ml-auto flex items-center text-xs">
              <span id="yoy-trend" class="px-2 py-1 rounded bg-purple-200 text-purple-800 font-medium">Trend: ↗</span>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-5 rounded-lg border border-amber-200 shadow-md hover:shadow-lg transition-shadow duration-300">
          <div class="flex items-center justify-between mb-2">
            <h4 class="text-sm font-semibold text-amber-800">Top Contributing Component</h4>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-500" viewBox="0 0 20 20" fill="currentColor">
              <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
            </svg>
          </div>
          <p id="top-component" class="text-3xl font-bold text-amber-700">--</p>
          <div class="flex items-center mt-2">
            <p id="top-component-value" class="text-xs text-gray-600">Contributing -.--%</p>
            <div class="ml-auto flex items-center text-xs">
              <span id="component-share" class="px-2 py-1 rounded bg-amber-200 text-amber-800 font-medium">--% of GDP</span>
            </div>
          </div>
        </div>
      </div>

      <!-- GDP Main Chart -->
      <div class="mb-8">
        <h4 id="gdp-chart-title" class="text-lg font-semibold mb-3">U.S. Real Gross Domestic Product</h4>
        <div class="border p-4 bg-white">
          <div style="height: 500px;">
            <canvas id="gdp-main-chart"></canvas>
          </div>
          <div class="mt-4 text-sm text-gray-600">
            <p>Note: Shaded areas represent recessions, as determined by the National Bureau of Economic Research.</p>
            <p>Source: U.S. Bureau of Economic Analysis.</p>
          </div>
        </div>
      </div>

      <!-- GDP Components Breakdown -->
      <div class="mb-8">
        <div class="flex justify-between items-center mb-3">
          <h4 class="text-lg font-semibold">GDP Components Breakdown</h4>
          <div class="flex items-center space-x-4">
            <div class="flex items-center">
              <label for="components-year" class="mr-2 text-sm font-medium text-gray-700">Year:</label>
              <select id="components-year" class="p-2 border border-gray-300 rounded-md">
                <!-- Will be populated by JavaScript -->
              </select>
            </div>
            <div class="flex items-center">
              <label for="components-quarter" class="mr-2 text-sm font-medium text-gray-700">Quarter:</label>
              <select id="components-quarter" class="p-2 border border-gray-300 rounded-md">
                <!-- Will be populated by JavaScript -->
              </select>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Components Chart -->
          <div class="border p-4 bg-white">
            <div style="height: 400px;">
              <canvas id="gdp-components-chart"></canvas>
            </div>
          </div>
          <!-- Components Table -->
          <div class="border p-4 bg-white overflow-auto">
            <table id="gdp-components-table" class="min-w-full border-collapse">
              <thead>
                <tr>
                  <th class="p-2 border bg-gray-100 text-left">Component</th>
                  <th class="p-2 border bg-gray-100 text-right">Value (Billions)</th>
                  <th class="p-2 border bg-gray-100 text-right">% of GDP</th>
                  <th class="p-2 border bg-gray-100 text-right">Change</th>
                </tr>
              </thead>
              <tbody id="gdp-components-body">
                <!-- Will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- GDP by Industry Section -->
      <div class="mb-8">
        <h4 class="text-lg font-semibold mb-3">GDP by Industry</h4>
        <p class="text-sm text-gray-600 mb-4">Explore the contribution of different industries to the U.S. economy.</p>

        <!-- Industry Visualization Controls -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div>
            <label for="industry-year" class="block text-sm font-medium text-gray-700 mb-1">Select Year</label>
            <select id="industry-year" class="w-full p-2 border border-gray-300 rounded-md">
              <!-- Will be populated by JavaScript -->
            </select>
          </div>
          <div>
            <label for="industry-view-type" class="block text-sm font-medium text-gray-700 mb-1">View Type</label>
            <select id="industry-view-type" class="w-full p-2 border border-gray-300 rounded-md">
              <option value="bar" selected>Bar Chart</option>
              <option value="pie">Pie Chart</option>
            </select>
          </div>
          <div>
            <label for="industry-detail-level" class="block text-sm font-medium text-gray-700 mb-1">Detail Level</label>
            <select id="industry-detail-level" class="w-full p-2 border border-gray-300 rounded-md">
              <option value="high">High (All Industries)</option>
              <option value="medium" selected>Medium (Major Sectors)</option>
              <option value="low">Low (Aggregated Sectors)</option>
            </select>
          </div>
        </div>

        <!-- Industry Visualization -->
        <div class="border p-4 bg-white">
          <div style="height: 800px;">
            <canvas id="gdp-industry-chart"></canvas>
          </div>
          <div class="mt-4 text-sm text-gray-600">
            <p>Source: U.S. Bureau of Economic Analysis, Gross Output by Industry.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Unemployment Tab Content -->
  <div id="content-unemployment" class="tab-content">
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h3 class="text-xl font-bold text-blue-700 mb-4">Unemployment Data Analysis</h3>
      <p class="mb-4">Unemployment data visualizations coming soon. This section will include interactive charts for exploring unemployment rates, labor force participation, and related metrics.</p>
      <div class="p-12 text-center text-gray-500">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <p class="text-lg font-medium">Unemployment data visualizations coming soon</p>
        <p class="mt-2">Check back later for interactive unemployment charts and analysis tools</p>
      </div>
    </div>
  </div>
</main>

<!-- Footer -->
<footer class="bg-gray-100 border-t mt-12 py-6 px-4">
  <div class="container mx-auto">
    <p class="text-gray-600">© 2025 Economics Department</p>
  </div>
</footer>

<!-- JavaScript for Data Visualization -->
<script>
  // No need to manually register the annotation plugin as it registers itself

  // Global variables
  // CPI variables
  let cpiData = [];
  let categories = [];
  let years = [];
  let months = [];
  let lineChart = null;
  let selectedCategories = ['All items', 'Food', 'Energy', 'Shelter'];
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const recessionPeriods = [
    { start: new Date(1953, 6), end: new Date(1954, 4) },   // Jul 1953 - May 1954
    { start: new Date(1957, 7), end: new Date(1958, 3) },   // Aug 1957 - Apr 1958
    { start: new Date(1960, 3), end: new Date(1961, 1) },   // Apr 1960 - Feb 1961
    { start: new Date(1969, 11), end: new Date(1970, 10) }, // Dec 1969 - Nov 1970
    { start: new Date(1973, 10), end: new Date(1975, 2) },  // Nov 1973 - Mar 1975
    { start: new Date(1980, 0), end: new Date(1980, 6) },   // Jan 1980 - Jul 1980
    { start: new Date(1981, 6), end: new Date(1982, 10) },  // Jul 1981 - Nov 1982
    { start: new Date(1990, 6), end: new Date(1991, 2) },   // Jul 1990 - Mar 1991
    { start: new Date(2001, 2), end: new Date(2001, 10) },  // Mar 2001 - Nov 2001
    { start: new Date(2007, 11), end: new Date(2009, 5) },  // Dec 2007 - Jun 2009
    { start: new Date(2020, 1), end: new Date(2020, 3) }    // Feb 2020 - Apr 2020
  ];

  // GDP variables
  let gdpData = { nominal: [], real: [] };
  let gdpQuarters = [];
  let industryData = [];
  let industryYears = [];
  let gdpMainChart = null;
  let gdpComponentsChart = null;
  let gdpIndustryChart = null;

  // Initialize the page
  document.addEventListener('DOMContentLoaded', async function() {
    // Set up tab navigation
    setupTabs();

    // Load data
    try {
      await Promise.all([
        loadCPIData(),
        loadGDPData(),
        loadIndustryData()
      ]);
      console.log('All data loaded successfully');
    } catch (error) {
      console.error('Error loading data:', error);
      alert('There was an error loading the data. Please try refreshing the page.');
    }

    // Initialize CPI visualizations
    initializeCategorySelector();
    createHeatmapTable();
    createLineChart();

    // Initialize GDP visualizations
    initializeGDPVisualizations();

    // Set up event listeners
    setupEventListeners();
  });

  // Set up tab navigation
  function setupTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Remove active class from all buttons and contents
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));

        // Add active class to clicked button and corresponding content
        button.classList.add('active');
        const contentId = 'content-' + button.id.split('-')[1];
        const contentElement = document.getElementById(contentId);
        contentElement.classList.add('active');

        // Initialize visualizations for the selected tab if needed
        if (contentId === 'content-gdp') {
          // GDP tab selected - placeholder for future implementation
          console.log('GDP tab selected - visualizations not yet implemented');
        } else if (contentId === 'content-cpi') {
          // Refresh CPI charts when CPI tab is selected
          setTimeout(() => {
            console.log('Refreshing CPI charts');
            if (lineChart) lineChart.update();
          }, 100);
        }
      });
    });

    // Set default active tab if none is active
    if (tabButtons.length > 0 && !document.querySelector('.tab-button.active')) {
      tabButtons[0].click();
    }
  }

  // Load CPI data from Excel file
  async function loadCPIData() {
    try {
      console.log('Attempting to load CPI data...');
      const response = await fetch('course_materials/cpi.xlsx');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const arrayBuffer = await response.arrayBuffer();
      const data = new Uint8Array(arrayBuffer);
      const workbook = XLSX.read(data, { type: 'array' });

      // Get the first sheet
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];

      // Convert to JSON with raw values to ensure proper number parsing
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true });
      console.log('Raw data loaded:', jsonData.length, 'rows');
      console.log('Sample row:', jsonData[0]);

      // Process the data
      cpiData = jsonData.map(row => {
        // Ensure Month is properly parsed as a date
        let date;
        if (row.Month instanceof Date) {
          date = row.Month;
        } else if (typeof row.Month === 'string') {
          // Parse date string (format: YYYY-MM-DD)
          date = new Date(row.Month);
        } else if (typeof row.Month === 'number') {
          // Excel stores dates as numbers, convert to JS date
          date = new Date(Math.round((row.Month - 25569) * 86400 * 1000));
        } else {
          // Fallback if date parsing fails
          console.warn('Invalid date format:', row.Month);
          return null;
        }

        // Create a new object with the date and numeric values
        const processedRow = {
          date: date,
          year: date.getFullYear(),
          month: date.getMonth(),
          Month: row.Month
        };

        // Convert all category values to numbers
        Object.keys(row).forEach(key => {
          if (key !== 'Month') {
            processedRow[key] = typeof row[key] === 'number' ? row[key] : parseFloat(row[key]);
          }
        });

        return processedRow;
      }).filter(item => item !== null); // Remove any null entries

      // Extract categories (column names except 'Month')
      categories = Object.keys(jsonData[0]).filter(key => key !== 'Month');
      console.log('Categories:', categories);

      // Extract unique years and months
      years = [...new Set(cpiData.map(row => row.year))].sort();
      months = [...Array(12).keys()];
      console.log('Years available:', years);

      console.log('CPI data loaded successfully:', cpiData.length, 'rows');
      console.log('First 3 processed rows:', cpiData.slice(0, 3));
    } catch (error) {
      console.error('Error loading CPI data:', error);
      alert('Failed to load CPI data: ' + error.message + '. Please try refreshing the page.');
    }
  }

  // Initialize year selectors
  function initializeYearSelectors() {
    const startYearSelect = document.getElementById('start-year');
    const endYearSelect = document.getElementById('end-year');

    // Clear existing options
    startYearSelect.innerHTML = '';
    endYearSelect.innerHTML = '';

    if (!years || years.length === 0) {
      console.error('No years data available for selectors');
      return;
    }

    console.log('Populating year selectors with years:', years);

    // Add options for each year
    years.forEach(year => {
      startYearSelect.add(new Option(year, year));
      endYearSelect.add(new Option(year, year));
    });

    // Set default values (last 5 years)
    if (years.length > 0) {
      // Default to showing the last 5 years of data
      const endYear = years[years.length - 1]; // Most recent year
      let startYear = endYear - 5;

      // Find the closest available start year
      startYear = years.reduce((prev, curr) =>
        Math.abs(curr - startYear) < Math.abs(prev - startYear) ? curr : prev
      );

      console.log(`Setting default year range: ${startYear} to ${endYear}`);
      startYearSelect.value = startYear;
      endYearSelect.value = endYear;
    }
  }

  // Initialize category selector
  function initializeCategorySelector() {
    const categorySelector = document.getElementById('category-selector');
    categorySelector.innerHTML = '';

    // Create a button for each category
    categories.forEach(category => {
      const button = document.createElement('button');
      button.textContent = category;
      button.className = 'category-btn';
      button.dataset.category = category;

      // Set selected state
      if (selectedCategories.includes(category)) {
        button.classList.add('selected');
      }

      // Add click event
      button.addEventListener('click', () => {
        toggleCategory(category, button);
      });

      categorySelector.appendChild(button);
    });
  }

  // Toggle category selection
  function toggleCategory(category, button) {
    const index = selectedCategories.indexOf(category);

    if (index === -1) {
      // Add category if not already selected
      selectedCategories.push(category);
      button.classList.add('selected');
    } else {
      // Remove category if already selected (but keep at least one)
      if (selectedCategories.length > 1) {
        selectedCategories.splice(index, 1);
        button.classList.remove('selected');
      }
    }

    // Update line chart
    updateLineChart();
  }

  // Create heatmap table visualization
  function createHeatmapTable() {
    try {
      console.log('Creating heatmap table...');
      if (!cpiData || cpiData.length === 0) {
        console.error('No CPI data available for heatmap');
        return;
      }

      // Get selected month, year, and number of months
      const startMonth = parseInt(document.getElementById('heatmap-month').value);
      const startYear = parseInt(document.getElementById('heatmap-year').value);
      const numMonths = parseInt(document.getElementById('heatmap-months').value);

      // Get data starting from selected month/year for the specified number of months
      const heatmapData = getHeatmapData(startYear, startMonth, numMonths);
      console.log('Heatmap data:', heatmapData.length, 'months');

      if (heatmapData.length === 0) {
        console.error('No data available for selected period');
        return;
      }

      // Populate month headers
      const monthRow = document.getElementById('month-row');
      monthRow.innerHTML = '<th class="p-2 border bg-gray-100"></th>'; // Clear and add first cell

      heatmapData.forEach(monthData => {
        const th = document.createElement('th');
        th.className = 'p-2 border bg-gray-100 text-center';
        th.textContent = `${monthNames[monthData.month]}-${String(monthData.year).slice(2)}`;
        monthRow.appendChild(th);
      });

      // Populate category rows
      const heatmapBody = document.getElementById('heatmap-body');
      heatmapBody.innerHTML = ''; // Clear existing content

      // Create a row for each category
      categories.forEach(category => {
        const tr = document.createElement('tr');

        // Category name cell
        const th = document.createElement('th');
        th.className = 'p-2 border text-left';
        th.textContent = category;
        tr.appendChild(th);

        // Value cells
        heatmapData.forEach(monthData => {
          const td = document.createElement('td');
          td.className = 'p-2 border text-center';

          // Get the value for this category and month
          const value = parseFloat(monthData[category]);

          if (!isNaN(value)) {
            // Format the value
            td.textContent = (value * 100).toFixed(1);

            // Apply color based on value
            if (value < -0.01) {
              // Blue for deflation
              const intensity = Math.min(Math.abs(value) * 10, 1);
              td.style.backgroundColor = `rgba(59, 130, 246, ${intensity})`;
            } else if (value > 0.01) {
              // Red for inflation
              const intensity = Math.min(value * 10, 1);
              td.style.backgroundColor = `rgba(239, 68, 68, ${intensity})`;
            }
          } else {
            td.textContent = '0.0';
          }

          tr.appendChild(td);
        });

        heatmapBody.appendChild(tr);
      });

      console.log('Heatmap table created successfully');
    } catch (error) {
      console.error('Error creating heatmap table:', error);
    }
  }

  // Get data for a specific time period
  function getHeatmapData(startYear, startMonth, numMonths) {
    try {
      console.log(`Getting heatmap data starting from ${startMonth}/${startYear} for ${numMonths} months...`);
      if (!cpiData || cpiData.length === 0) {
        console.error('No CPI data available');
        return [];
      }

      // Find the exact starting date for the selected month/year
      const startDate = new Date(startYear, startMonth, 1);
      console.log('Looking for data starting from:', startDate.toISOString().slice(0, 10));

      // Sort data by date (oldest first)
      const sortedData = [...cpiData].sort((a, b) => {
        // Ensure we have valid dates
        if (!a.date || !b.date) return 0;
        return a.date - b.date;
      });

      // Find data points that match or are after our target start date
      const eligibleData = sortedData.filter(item => {
        return item.date >= startDate;
      });

      if (eligibleData.length === 0) {
        console.error('No data available on or after the selected date');
        return [];
      }

      // Take the first numMonths items from the eligible data
      const heatmapData = eligibleData.slice(0, numMonths);

      if (heatmapData.length < numMonths) {
        console.warn(`Only found ${heatmapData.length} months of data, less than requested ${numMonths}`);
      }

      console.log(`Heatmap data: ${heatmapData.length} months, from ${heatmapData[0]?.date?.toISOString().slice(0, 10)} to ${heatmapData[heatmapData.length-1]?.date?.toISOString().slice(0, 10)}`);

      return heatmapData;
    } catch (error) {
      console.error('Error getting heatmap data:', error);
      return [];
    }
  }

  // Create line chart visualization
  function createLineChart() {
    try {
      console.log('Creating line chart...');
      if (!cpiData || cpiData.length === 0) {
        console.error('No CPI data available for line chart');
        return;
      }

      // Destroy existing chart if it exists
      if (lineChart) {
        console.log('Destroying existing line chart');
        lineChart.destroy();
        lineChart = null;
      }

      const ctx = document.getElementById('cpi-line-chart').getContext('2d');

      // Prepare data for line chart
      const data = prepareLineChartData();
      console.log('Line chart data prepared:', data.datasets.length, 'datasets');

      // Create chart
      lineChart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.9)',
              titleColor: '#000',
              bodyColor: '#000',
              borderColor: '#ddd',
              borderWidth: 1,
              padding: 12,
              titleFont: {
                size: 16,
                weight: 'bold'
              },
              bodyFont: {
                size: 14
              },
              callbacks: {
                title(tooltipItems) {
                  const date = new Date(tooltipItems[0].parsed.x);
                  return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                },
                label(context) {
                  return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                }
              }
            },
            legend: {
              position: 'top',
              labels: {
                boxWidth: 20,
                padding: 15,
                font: {
                  size: 16
                }
              }
            },
            annotation: {
              annotations: {
                recession2008: {
                  type: 'box',
                  xMin: new Date(2007, 11, 1),
                  xMax: new Date(2009, 5, 30),
                  backgroundColor: 'rgba(200, 200, 200, 0.2)',
                  borderWidth: 0
                },
                recession2020: {
                  type: 'box',
                  xMin: new Date(2020, 1, 1),
                  xMax: new Date(2020, 3, 30),
                  backgroundColor: 'rgba(200, 200, 200, 0.2)',
                  borderWidth: 0
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'year',
                displayFormats: {
                  year: 'yyyy'
                },
                tooltipFormat: 'MMM yyyy'
              },
              grid: {
                display: true,
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                source: 'auto',
                maxRotation: 0,
                autoSkip: true,
                font: {
                  size: 14
                }
              },
              title: {
                display: true,
                text: 'Year',
                font: {
                  size: 18,
                  weight: 'bold'
                },
                padding: {top: 10, bottom: 0}
              }
            },
            y: {
              // Auto-adjust based on data
              ticks: {
                callback: function(value) {
                  return value.toFixed(0) + '%';
                },
                font: {
                  size: 14
                }
              },
              grid: {
                display: true,
                color: 'rgba(0, 0, 0, 0.05)',
                drawBorder: false
              },
              title: {
                display: true,
                text: 'Percent Change',
                font: {
                  size: 18,
                  weight: 'bold'
                },
                padding: {top: 0, bottom: 10}
              }
            }
          },
          layout: {
            padding: {
              top: 10,
              right: 20,
              bottom: 10,
              left: 10
            }
          }
        }
      });

      console.log('Line chart created successfully');
    } catch (error) {
      console.error('Error creating line chart:', error);
    }
  }

  // Generate recession annotations for the chart
  function generateRecessionAnnotations() {
    return {
      type: 'box',
      drawTime: 'beforeDatasetsDraw',
      xScaleID: 'x',
      yScaleID: 'y',
      xMin: recessionPeriods[0].start,
      xMax: recessionPeriods[0].end,
      backgroundColor: 'rgba(200, 200, 200, 0.2)',
      borderWidth: 0
    };
  }

  // Prepare data for line chart
  function prepareLineChartData() {
    try {
      console.log('Preparing line chart data...');

      // Always use full date range from 2005 to present
      const startYear = 2005;
      const endYear = 2025; // Maximum year in our dataset

      console.log(`Using full data range from ${startYear} to ${endYear}`);

      // Filter data by year range
      const filteredData = cpiData.filter(row => {
        return row.year >= startYear && row.year <= endYear;
      });

      console.log(`Filtered data: ${filteredData.length} rows`);

      if (filteredData.length === 0) {
        console.warn('No data available');
        return { datasets: [] };
      }

      // Sort data by date
      filteredData.sort((a, b) => a.date - b.date);

      // Create datasets for selected categories
      const datasets = selectedCategories.map((category, index) => {
        // Define colors for specific categories
        let color;
        if (category === 'All items') {
          color = 'rgb(128, 0, 0)'; // Dark red for All items
        } else if (category === 'Food') {
          color = 'rgb(0, 128, 0)'; // Green for Food
        } else if (category === 'Energy') {
          color = 'rgb(0, 0, 128)'; // Dark blue for Energy
        } else if (category === 'Shelter') {
          color = 'rgb(128, 0, 128)'; // Purple for Shelter
        } else {
          // Other colors for remaining categories
          const colors = [
            'rgb(255, 99, 132)',  // Pink
            'rgb(54, 162, 235)',  // Blue
            'rgb(255, 206, 86)',  // Yellow
            'rgb(75, 192, 192)',  // Teal
            'rgb(153, 102, 255)', // Purple
            'rgb(255, 159, 64)',  // Orange
            'rgb(199, 199, 199)'  // Gray
          ];
          color = colors[index % colors.length];
        }

        // Create data points for this category
        const dataPoints = filteredData.map(row => {
          // Ensure the value exists and is a number
          const value = row[category];
          if (value === undefined || value === null || isNaN(value)) {
            console.warn(`Missing or invalid value for ${category} at ${row.date}`);
            return null;
          }

          return {
            x: row.date,
            y: value * 100 // Convert to percentage
          };
        }).filter(point => point !== null); // Remove any null points

        return {
          label: category,
          data: dataPoints,
          borderColor: color,
          backgroundColor: color,
          borderWidth: category === 'All items' ? 3 : 2,
          pointRadius: 0,
          tension: 0.2,
          fill: false
        };
      });

      return { datasets };
    } catch (error) {
      console.error('Error preparing line chart data:', error);
      return { datasets: [] };
    }
  }

  // Update line chart with new data
  function updateLineChart() {
    if (lineChart) {
      lineChart.data = prepareLineChartData();
      lineChart.update();
    }
  }

  // Load GDP data from Excel file
  async function loadGDPData() {
    try {
      console.log('Loading GDP data...');
      const response = await fetch('course_materials/GDP.xlsx');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const arrayBuffer = await response.arrayBuffer();
      const data = new Uint8Array(arrayBuffer);
      const workbook = XLSX.read(data, { type: 'array' });

      // Process both Nominal and Real GDP sheets
      const nominalSheet = workbook.Sheets['Nominal GDP'];
      const realSheet = workbook.Sheets['Real GDP'];

      if (!nominalSheet || !realSheet) {
        throw new Error('Required sheets not found in GDP.xlsx');
      }

      // Convert to JSON with raw values
      const nominalData = XLSX.utils.sheet_to_json(nominalSheet, { raw: true });
      const realData = XLSX.utils.sheet_to_json(realSheet, { raw: true });

      console.log('GDP data loaded:', nominalData.length, 'nominal rows,', realData.length, 'real rows');

      // Process the data
      const processedNominalData = processGDPData(nominalData, 'nominal');
      const processedRealData = processGDPData(realData, 'real');

      // Store the processed data
      gdpData = {
        nominal: processedNominalData,
        real: processedRealData
      };

      // Extract available quarters for date selectors
      gdpQuarters = processedRealData.map(row => row.quarter);

      console.log('GDP data processed successfully');
      return gdpData;
    } catch (error) {
      console.error('Error loading GDP data:', error);
      alert('Failed to load GDP data: ' + error.message);
      return { nominal: [], real: [] };
    }
  }

  // Process GDP data from raw Excel format
  function processGDPData(rawData, type) {
    return rawData.map(row => {
      // Parse the quarter (e.g., "1947Q1")
      const dateStr = row.Date;
      const year = parseInt(dateStr.substring(0, 4));
      const quarter = parseInt(dateStr.substring(5, 6));

      // Create a processed row with date information
      const processedRow = {
        date: dateStr,
        year: year,
        quarter: quarter,
        fullQuarter: dateStr, // e.g., "1947Q1"
        type: type // 'nominal' or 'real'
      };

      // Add all GDP components to the processed row
      Object.keys(row).forEach(key => {
        if (key !== 'Date') {
          // Convert to number and from millions to billions for easier display
          processedRow[key] = typeof row[key] === 'number' ? row[key] / 1000 : parseFloat(row[key]) / 1000;
        }
      });

      return processedRow;
    });
  }

  // Load Industry Value Added GDP data from Excel file
  async function loadIndustryData() {
    try {
      console.log('Loading Industry Value Added GDP data...');
      const response = await fetch('course_materials/valueaddedindustryGDP.xlsx');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const arrayBuffer = await response.arrayBuffer();
      const data = new Uint8Array(arrayBuffer);
      const workbook = XLSX.read(data, { type: 'array' });

      // Get the Sheet1 sheet
      const worksheet = workbook.Sheets['Sheet1'];
      if (!worksheet) {
        throw new Error('Sheet1 not found in valueaddedindustryGDP.xlsx');
      }

      // Convert to JSON with raw values
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true });
      console.log('Industry GDP data loaded:', jsonData.length, 'rows');

      // Process the data
      industryData = jsonData.map(row => {
        // Get the year
        const year = row.Year;

        // Create a processed row with date information
        const processedRow = {
          year: year,
          fullYear: year.toString() // For consistency with the quarter format in the UI
        };

        // Add all industry values to the processed row
        Object.keys(row).forEach(key => {
          if (key !== 'Year') {
            // Values are already in billions, so no need to convert
            processedRow[key] = typeof row[key] === 'number' ? row[key] : parseFloat(row[key]);
          }
        });

        return processedRow;
      });

      // Extract available years for industry date selector
      industryYears = industryData.map(row => row.fullYear);

      console.log('Industry GDP data processed successfully');
      return industryData;
    } catch (error) {
      console.error('Error loading Industry GDP data:', error);
      alert('Failed to load Industry GDP data: ' + error.message);
      return [];
    }
  }

  // Initialize GDP visualizations
  function initializeGDPVisualizations() {
    if (!gdpData || (!gdpData.nominal.length && !gdpData.real.length)) {
      console.warn('No GDP data available for visualizations');
      return;
    }

    // Initialize date selectors
    initializeGDPDateSelectors();

    // Initialize industry date selector
    initializeIndustryDateSelector();

    // Update key statistics
    updateGDPKeyStatistics();

    // Create charts
    createGDPMainChart();
    createGDPComponentsChart();
    createGDPIndustryChart();

    // Update components table
    updateGDPComponentsTable();

    // Set up event listeners for GDP controls
    setupGDPEventListeners();
  }

  // Initialize GDP date selectors
  function initializeGDPDateSelectors() {
    // Initialize components year and quarter selectors
    const componentsYearSelect = document.getElementById('components-year');
    const componentsQuarterSelect = document.getElementById('components-quarter');

    // Clear existing options
    componentsYearSelect.innerHTML = '';
    componentsQuarterSelect.innerHTML = '';

    if (!gdpData || (!gdpData.nominal.length && !gdpData.real.length)) {
      console.error('No GDP data available for date selectors');
      return;
    }

    // Extract unique years from the data
    const years = [...new Set(gdpData.real.map(row => row.year))].sort((a, b) => a - b);

    // Add options for each year
    years.forEach(year => {
      componentsYearSelect.add(new Option(year, year));
    });

    // Set default value to the most recent year
    if (years.length > 0) {
      componentsYearSelect.value = years[years.length - 1];
    }

    // Update quarters based on selected year
    updateComponentsQuarters();

    // Add event listener to update quarters when year changes
    componentsYearSelect.addEventListener('change', updateComponentsQuarters);
  }

  // Update quarters dropdown based on selected year
  function updateComponentsQuarters() {
    const componentsYearSelect = document.getElementById('components-year');
    const componentsQuarterSelect = document.getElementById('components-quarter');
    const selectedYear = parseInt(componentsYearSelect.value);

    // Clear existing options
    componentsQuarterSelect.innerHTML = '';

    // Filter quarters for the selected year
    const quartersForYear = gdpData.real
      .filter(row => row.year === selectedYear)
      .map(row => row.quarter)
      .sort((a, b) => a - b);

    // Add options for each quarter
    quartersForYear.forEach(quarter => {
      const quarterLabel = `Q${quarter}`;
      const quarterValue = `${selectedYear}Q${quarter}`;
      componentsQuarterSelect.add(new Option(quarterLabel, quarterValue));
    });

    // Set default value to the most recent quarter of the selected year
    if (quartersForYear.length > 0) {
      const latestQuarter = `${selectedYear}Q${quartersForYear[quartersForYear.length - 1]}`;
      componentsQuarterSelect.value = latestQuarter;
    }
  }

  // Initialize industry year selector
  function initializeIndustryDateSelector() {
    const industryYearSelect = document.getElementById('industry-year');

    // Clear existing options
    industryYearSelect.innerHTML = '';

    if (!industryYears || industryYears.length === 0) {
      console.error('No industry years available for date selector');
      return;
    }

    // Get unique years in chronological order
    const uniqueYears = [...new Set(industryYears)].sort((a, b) => parseInt(a) - parseInt(b));

    // Add options for each year
    uniqueYears.forEach(year => {
      industryYearSelect.add(new Option(year, year));
    });

    // Set default value to the most recent year
    if (uniqueYears.length > 0) {
      industryYearSelect.value = uniqueYears[uniqueYears.length - 1];
    }
  }

  // Create GDP Industry Chart
  function createGDPIndustryChart() {
    try {
      console.log('Creating GDP Industry chart...');
      if (!industryData || industryData.length === 0) {
        console.error('No industry data available for chart');
        return;
      }

      // Destroy existing chart if it exists
      if (gdpIndustryChart) {
        gdpIndustryChart.destroy();
        gdpIndustryChart = null;
      }

      const ctx = document.getElementById('gdp-industry-chart').getContext('2d');

      // Get selected view type and detail level
      const viewType = document.getElementById('industry-view-type').value;
      const detailLevel = document.getElementById('industry-detail-level').value;
      const selectedYear = document.getElementById('industry-year').value;

      // Prepare data for the selected chart type
      const chartData = prepareIndustryChartData(selectedYear, detailLevel);

      // Create the appropriate chart based on view type
      if (viewType === 'bar') {
        createIndustryBarChart(ctx, chartData);
      } else if (viewType === 'pie') {
        createIndustryPieChart(ctx, chartData);
      }

      console.log('GDP Industry chart created successfully');
    } catch (error) {
      console.error('Error creating GDP Industry chart:', error);
    }
  }

  // Update GDP Industry Chart
  function updateGDPIndustryChart() {
    // Simply recreate the chart with new settings
    createGDPIndustryChart();
  }

  // Set up event listeners
  function setupEventListeners() {
    // CPI Heatmap selectors
    document.getElementById('heatmap-month').addEventListener('change', () => {
      console.log('Heatmap month changed, updating heatmap...');
      createHeatmapTable();
    });

    document.getElementById('heatmap-year').addEventListener('change', () => {
      console.log('Heatmap year changed, updating heatmap...');
      createHeatmapTable();
    });

    document.getElementById('heatmap-months').addEventListener('change', () => {
      console.log('Number of months changed, updating heatmap...');
      createHeatmapTable();
    });

    // Set up GDP event listeners
    setupGDPEventListeners();

    // Trigger initial updates to ensure visualizations are rendered with default values
    console.log('Triggering initial visualization updates...');
    setTimeout(() => {
      // Initialize year selectors for CPI
      initializeYearSelectors();

      // CPI visualizations
      createHeatmapTable();
      createLineChart(); // Create the line chart once with full date range

      // GDP visualizations will be initialized after data is loaded
    }, 500); // Small delay to ensure everything is loaded
  }

  // Set up GDP-specific event listeners
  function setupGDPEventListeners() {
    try {
      console.log('Setting up GDP event listeners...');

      // GDP view type selector
      const viewTypeSelect = document.getElementById('gdp-view-type');
      if (viewTypeSelect) {
        viewTypeSelect.addEventListener('change', () => {
          console.log('GDP view type changed, updating charts...');
          createGDPMainChart();
          updateGDPChartTitle(viewTypeSelect.value, document.getElementById('gdp-data-type').value);
        });
      }

      // GDP data type selector
      const dataTypeSelect = document.getElementById('gdp-data-type');
      if (dataTypeSelect) {
        dataTypeSelect.addEventListener('change', () => {
          console.log('GDP data type changed, updating charts...');
          createGDPMainChart();
          createGDPComponentsChart();
          updateGDPComponentsTable();
          updateGDPChartTitle(document.getElementById('gdp-view-type').value, dataTypeSelect.value);
        });
      }

      // GDP time period selector
      const timePeriodSelect = document.getElementById('gdp-time-period');
      if (timePeriodSelect) {
        timePeriodSelect.addEventListener('change', () => {
          console.log('GDP time period changed, updating charts...');
          createGDPMainChart();
        });
      }

      // GDP components year and quarter selectors
      const componentsYearSelect = document.getElementById('components-year');
      const componentsQuarterSelect = document.getElementById('components-quarter');

      if (componentsYearSelect) {
        componentsYearSelect.addEventListener('change', () => {
          console.log('Components year changed, updating quarters...');
          // updateComponentsQuarters is already called in the initializeGDPDateSelectors function
          // After quarters are updated, update the components
          setTimeout(() => {
            createGDPComponentsChart();
            updateGDPComponentsTable();
          }, 100);
        });
      }

      if (componentsQuarterSelect) {
        componentsQuarterSelect.addEventListener('change', () => {
          console.log('Components quarter changed, updating components...');
          createGDPComponentsChart();
          updateGDPComponentsTable();
        });
      }

      // Industry visualization controls
      const industryYearSelect = document.getElementById('industry-year');
      if (industryYearSelect) {
        industryYearSelect.addEventListener('change', () => {
          console.log('Industry year changed, updating chart...');
          updateGDPIndustryChart();
        });
      }

      const industryViewTypeSelect = document.getElementById('industry-view-type');
      if (industryViewTypeSelect) {
        industryViewTypeSelect.addEventListener('change', () => {
          console.log('Industry view type changed, updating chart...');
          updateGDPIndustryChart();
        });
      }

      const industryDetailLevelSelect = document.getElementById('industry-detail-level');
      if (industryDetailLevelSelect) {
        industryDetailLevelSelect.addEventListener('change', () => {
          console.log('Industry detail level changed, updating chart...');
          updateGDPIndustryChart();
        });
      }

      console.log('GDP event listeners set up successfully');
    } catch (error) {
      console.error('Error setting up GDP event listeners:', error);
    }
  }

  // Prepare industry chart data
  function prepareIndustryChartData(selectedYear, detailLevel) {
    try {
      console.log(`Preparing industry data for ${selectedYear} with detail level ${detailLevel}...`);

      // Find the data for the selected year
      const yearData = industryData.find(row => row.fullYear === selectedYear);

      if (!yearData) {
        console.error(`No data found for year ${selectedYear}`);
        return { labels: [], values: [], backgroundColors: [], year: '' };
      }

      // Define industry categories based on detail level
      let categories = [];

      if (detailLevel === 'low') {
        // Low detail: Major sectors only
        categories = [
          { name: 'Agriculture & Mining', keys: ['    Agriculture, forestry, fishing, and hunting', '    Mining'] },
          { name: 'Manufacturing', keys: ['    Manufacturing'] },
          { name: 'Construction & Utilities', keys: ['    Construction', '    Utilities'] },
          { name: 'Trade', keys: ['    Wholesale trade', '    Retail trade'] },
          { name: 'Transportation', keys: ['    Transportation and warehousing'] },
          { name: 'Information', keys: ['    Information'] },
          { name: 'Finance & Real Estate', keys: ['    Finance, insurance, real estate, rental, and leasing'] },
          { name: 'Professional Services', keys: ['    Professional and business services'] },
          { name: 'Education & Health', keys: ['    Educational services, health care, and social assistance'] },
          { name: 'Entertainment & Hospitality', keys: ['    Arts, entertainment, recreation, accommodation, and food services'] },
          { name: 'Other Services', keys: ['    Other services, except government'] },
          { name: 'Government', keys: ['Government'] }
        ];
      } else if (detailLevel === 'medium') {
        // Medium detail: More granular sectors
        categories = [
          { name: 'Agriculture & Forestry', keys: ['    Agriculture, forestry, fishing, and hunting'] },
          { name: 'Mining', keys: ['    Mining'] },
          { name: 'Utilities', keys: ['    Utilities'] },
          { name: 'Construction', keys: ['    Construction'] },
          { name: 'Manufacturing - Durable', keys: ['        Durable goods'] },
          { name: 'Manufacturing - Nondurable', keys: ['        Nondurable goods'] },
          { name: 'Wholesale Trade', keys: ['    Wholesale trade'] },
          { name: 'Retail Trade', keys: ['    Retail trade'] },
          { name: 'Transportation', keys: ['    Transportation and warehousing'] },
          { name: 'Information', keys: ['    Information'] },
          { name: 'Finance & Insurance', keys: ['        Finance and insurance'] },
          { name: 'Real Estate', keys: ['        Real estate and rental and leasing'] },
          { name: 'Professional Services', keys: ['        Professional, scientific, and technical services'] },
          { name: 'Management', keys: ['        Management of companies and enterprises'] },
          { name: 'Administrative Services', keys: ['        Administrative and waste management services'] },
          { name: 'Education', keys: ['        Educational services'] },
          { name: 'Health Care', keys: ['        Health care and social assistance'] },
          { name: 'Arts & Entertainment', keys: ['        Arts, entertainment, and recreation'] },
          { name: 'Accommodation & Food', keys: ['        Accommodation and food services'] },
          { name: 'Other Services', keys: ['    Other services, except government'] },
          { name: 'Government - Federal', keys: ['    Federal'] },
          { name: 'Government - State & Local', keys: ['    State and local'] }
        ];
      } else if (detailLevel === 'high') {
        // High detail: All available industries
        // Get all industry columns (excluding Year and aggregates)
        const allKeys = Object.keys(yearData).filter(key => {
          return key !== 'Year' &&
                 key !== 'year' &&
                 key !== 'fullYear' &&
                 key !== '        Gross domestic product' &&
                 key !== 'Private industries';
        });

        // Create a category for each industry
        categories = allKeys.map(key => ({
          name: key.trim(),
          keys: [key]
        }));
      }

      // Calculate values for each category
      const industryValues = categories.map(category => {
        // Sum values for all keys in this category
        const value = category.keys.reduce((sum, key) => {
          return sum + (yearData[key] || 0);
        }, 0);

        return {
          name: category.name,
          value: value
        };
      });

      // Sort by value (descending)
      industryValues.sort((a, b) => b.value - a.value);

      // Prepare chart data
      const labels = industryValues.map(industry => industry.name);
      const values = industryValues.map(industry => industry.value);

      // Generate colors
      const backgroundColors = generateColorPalette(industryValues.length);

      return {
        labels,
        values,
        backgroundColors,
        year: selectedYear
      };
    } catch (error) {
      console.error('Error preparing industry chart data:', error);
      return { labels: [], values: [], backgroundColors: [], year: '' };
    }
  }

  // Create industry bar chart
  function createIndustryBarChart(ctx, chartData) {
    try {
      gdpIndustryChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: 'Industry Output',
            data: chartData.values,
            backgroundColor: chartData.backgroundColors,
            borderColor: 'rgba(255, 255, 255, 0.8)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `Industry Value Added GDP - ${chartData.year}`,
              font: {
                size: 16,
                weight: 'bold'
              }
            },
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const total = chartData.values.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `$${value.toFixed(1)} billion (${percentage}%)`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                display: true,
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value.toFixed(0) + ' B';
                }
              },
              title: {
                display: true,
                text: 'Billions of Dollars (Value Added)',
                font: {
                  weight: 'bold'
                }
              }
            }
          }
        }
      });
    } catch (error) {
      console.error('Error creating industry bar chart:', error);
    }
  }

  // Create industry pie chart
  function createIndustryPieChart(ctx, chartData) {
    try {
      gdpIndustryChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: 'Industry Output',
            data: chartData.values,
            backgroundColor: chartData.backgroundColors,
            borderColor: 'rgba(255, 255, 255, 0.8)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `Industry Value Added GDP - ${chartData.year}`,
              font: {
                size: 16,
                weight: 'bold'
              }
            },
            legend: {
              position: 'right',
              labels: {
                font: {
                  size: 11
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const total = chartData.values.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${context.label}: $${value.toFixed(1)} billion (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    } catch (error) {
      console.error('Error creating industry pie chart:', error);
    }
  }

  // Generate a color palette for charts
  function generateColorPalette(count) {
    try {
      // Base colors
      const baseColors = [
        'rgba(54, 162, 235, 0.7)',   // Blue
        'rgba(255, 99, 132, 0.7)',   // Red
        'rgba(255, 206, 86, 0.7)',   // Yellow
        'rgba(75, 192, 192, 0.7)',   // Teal
        'rgba(153, 102, 255, 0.7)',  // Purple
        'rgba(255, 159, 64, 0.7)',   // Orange
        'rgba(199, 199, 199, 0.7)',  // Gray
        'rgba(83, 102, 255, 0.7)',   // Indigo
        'rgba(255, 99, 71, 0.7)',    // Tomato
        'rgba(50, 205, 50, 0.7)',    // Lime Green
        'rgba(255, 165, 0, 0.7)',    // Orange
        'rgba(138, 43, 226, 0.7)'    // Blue Violet
      ];

      // If we need more colors than in our base set, generate variations
      if (count <= baseColors.length) {
        return baseColors.slice(0, count);
      }

      // Generate additional colors by varying opacity and saturation
      const colors = [...baseColors];

      while (colors.length < count) {
        // Take a base color and create a variation
        const baseColor = baseColors[colors.length % baseColors.length];
        const opacity = 0.4 + (Math.random() * 0.4); // Random opacity between 0.4 and 0.8

        // Create a variation by changing the opacity
        const newColor = baseColor.replace(/[\d\.]+\)$/, `${opacity})`);
        colors.push(newColor);
      }

      return colors;
    } catch (error) {
      console.error('Error generating color palette:', error);
      return Array(count).fill('rgba(200, 200, 200, 0.7)'); // Fallback to gray
    }
  }

  // Generate recession annotations for charts
  function generateRecessionAnnotations() {
    try {
      // Define recession periods (based on NBER dates)
      const recessions = [
        { start: '1948Q4', end: '1949Q4' },
        { start: '1953Q2', end: '1954Q2' },
        { start: '1957Q3', end: '1958Q2' },
        { start: '1960Q2', end: '1961Q1' },
        { start: '1969Q4', end: '1970Q4' },
        { start: '1973Q4', end: '1975Q1' },
        { start: '1980Q1', end: '1980Q3' },
        { start: '1981Q3', end: '1982Q4' },
        { start: '1990Q3', end: '1991Q1' },
        { start: '2001Q1', end: '2001Q4' },
        { start: '2007Q4', end: '2009Q2' },
        { start: '2020Q1', end: '2020Q2' }
      ];

      // Get the selected time period to filter recessions
      const timePeriod = document.getElementById('gdp-time-period').value;
      const dates = calculateDateRange(timePeriod);
      const startDate = dates.startDate;
      const endDate = dates.endDate;

      // Parse start and end dates
      let startYear = 1900;
      let startQuarter = 1;
      let endYear = 2100;
      let endQuarter = 4;

      if (startDate) {
        startYear = parseInt(startDate.substring(0, 4));
        startQuarter = parseInt(startDate.substring(5, 6));
      }

      if (endDate) {
        endYear = parseInt(endDate.substring(0, 4));
        endQuarter = parseInt(endDate.substring(5, 6));
      }

      // Create annotation objects for each recession that falls within the selected time period
      const annotations = {};

      recessions.forEach((recession, index) => {
        // Parse recession start and end dates
        const recStartYear = parseInt(recession.start.substring(0, 4));
        const recStartQuarter = parseInt(recession.start.substring(5, 6));
        const recEndYear = parseInt(recession.end.substring(0, 4));
        const recEndQuarter = parseInt(recession.end.substring(5, 6));

        // Check if recession is within the selected time period
        const isAfterStart = (recEndYear > startYear) ||
                            (recEndYear === startYear && recEndQuarter >= startQuarter);
        const isBeforeEnd = (recStartYear < endYear) ||
                           (recStartYear === endYear && recStartQuarter <= endQuarter);

        if (isAfterStart && isBeforeEnd) {
          annotations[`recession${index}`] = {
            type: 'box',
            xMin: recession.start,
            xMax: recession.end,
            backgroundColor: 'rgba(200, 200, 200, 0.2)',
            borderWidth: 0,
            yScaleID: 'y',
            yMin: 'bottom',
            yMax: 'top',
            drawTime: 'beforeDatasetsDraw'
          };
        }
      });

      return annotations;
    } catch (error) {
      console.error('Error generating recession annotations:', error);
      return {};
    }
  }

  // Update GDP chart title based on selected view and data type
  function updateGDPChartTitle(viewType, dataType) {
    try {
      const titleElement = document.getElementById('gdp-chart-title');

      if (!titleElement) return;

      let title = 'U.S. ';

      // Add data type
      if (dataType === 'real') {
        title += 'Real ';
      } else if (dataType === 'nominal') {
        title += 'Nominal ';
      } else if (dataType === 'both') {
        title += 'Real & Nominal ';
      }

      // Add view type
      if (viewType === 'levels') {
        title += 'Gross Domestic Product';
      } else if (viewType === 'growth') {
        title += 'GDP Growth Rate';
      } else if (viewType === 'components') {
        title += 'GDP Components';
      }

      titleElement.textContent = title;
    } catch (error) {
      console.error('Error updating GDP chart title:', error);
    }
  }

  // Calculate date range based on selected time period
  function calculateDateRange(timePeriod) {
    try {
      // Get the most recent quarter's data
      const sortedData = [...gdpData.real].sort((a, b) => {
        if (a.year !== b.year) return b.year - a.year;
        return b.quarter - a.quarter;
      });

      const latestData = sortedData[0];

      if (!latestData) {
        console.error('No data available for date range calculation');
        return { startDate: null, endDate: null };
      }

      const endDate = latestData.fullQuarter;
      let startDate;

      // Calculate start date based on time period
      if (timePeriod === '5years') {
        // Find the quarter 5 years before the end date
        const targetYear = latestData.year - 5;
        const targetQuarter = latestData.quarter;

        // Find the closest matching quarter
        const matchingData = gdpData.real.find(row => {
          return row.year === targetYear && row.quarter === targetQuarter;
        }) || gdpData.real.find(row => row.year === targetYear);

        startDate = matchingData ? matchingData.fullQuarter : gdpData.real[0].fullQuarter;
      } else if (timePeriod === '10years') {
        // Find the quarter 10 years before the end date
        const targetYear = latestData.year - 10;
        const targetQuarter = latestData.quarter;

        // Find the closest matching quarter
        const matchingData = gdpData.real.find(row => {
          return row.year === targetYear && row.quarter === targetQuarter;
        }) || gdpData.real.find(row => row.year === targetYear);

        startDate = matchingData ? matchingData.fullQuarter : gdpData.real[0].fullQuarter;
      } else if (timePeriod === '20years') {
        // Find the quarter 20 years before the end date
        const targetYear = latestData.year - 20;
        const targetQuarter = latestData.quarter;

        // Find the closest matching quarter
        const matchingData = gdpData.real.find(row => {
          return row.year === targetYear && row.quarter === targetQuarter;
        }) || gdpData.real.find(row => row.year === targetYear);

        startDate = matchingData ? matchingData.fullQuarter : gdpData.real[0].fullQuarter;
      } else if (timePeriod === 'all') {
        // Use the earliest available quarter
        const earliestData = [...gdpData.real].sort((a, b) => {
          if (a.year !== b.year) return a.year - b.year;
          return a.quarter - b.quarter;
        })[0];

        startDate = earliestData ? earliestData.fullQuarter : gdpData.real[0].fullQuarter;
      } else {
        // Default to all data
        startDate = gdpData.real[0].fullQuarter;
      }

      return { startDate, endDate };
    } catch (error) {
      console.error('Error calculating date range:', error);
      return { startDate: null, endDate: null };
    }
  }

  // Filter GDP data by date range
  function filterGDPDataByDateRange(data, startDate, endDate) {
    try {
      if (!startDate || !endDate) {
        return data;
      }

      // Parse start and end dates
      const startYear = parseInt(startDate.substring(0, 4));
      const startQuarter = parseInt(startDate.substring(5, 6));
      const endYear = parseInt(endDate.substring(0, 4));
      const endQuarter = parseInt(endDate.substring(5, 6));

      // Filter data by date range
      return data.filter(row => {
        // Check if the row's date is within the range
        if (row.year < startYear) return false;
        if (row.year > endYear) return false;
        if (row.year === startYear && row.quarter < startQuarter) return false;
        if (row.year === endYear && row.quarter > endQuarter) return false;

        return true;
      });
    } catch (error) {
      console.error('Error filtering GDP data by date range:', error);
      return data;
    }
  }

  // Calculate GDP growth rates
  function calculateGDPGrowthRates(data) {
    try {
      if (!data || data.length < 2) {
        return [];
      }

      // Sort data by date (oldest first)
      const sortedData = [...data].sort((a, b) => {
        if (a.year !== b.year) return a.year - b.year;
        return a.quarter - b.quarter;
      });

      // Calculate quarter-over-quarter growth rates
      const growthData = [];

      for (let i = 1; i < sortedData.length; i++) {
        const currentGDP = sortedData[i]['    Gross domestic product'];
        const previousGDP = sortedData[i-1]['    Gross domestic product'];

        // Calculate annualized growth rate: ((current/previous)^4 - 1) * 100
        const growthRate = (Math.pow(currentGDP / previousGDP, 4) - 1) * 100;

        growthData.push({
          ...sortedData[i],
          growthRate: growthRate
        });
      }

      return growthData;
    } catch (error) {
      console.error('Error calculating GDP growth rates:', error);
      return [];
    }
  }

  // Update GDP key statistics
  function updateGDPKeyStatistics() {
    try {
      console.log('Updating GDP key statistics...');

      // Get the most recent quarter's data
      const sortedRealData = [...gdpData.real].sort((a, b) => {
        if (a.year !== b.year) return b.year - a.year;
        return b.quarter - a.quarter;
      });

      const latestData = sortedRealData[0];
      const previousQuarterData = sortedRealData[1];
      const yearAgoIndex = sortedRealData.findIndex(row => {
        return row.year === latestData.year - 1 && row.quarter === latestData.quarter;
      });
      const yearAgoData = yearAgoIndex >= 0 ? sortedRealData[yearAgoIndex] : null;

      if (!latestData || !previousQuarterData) {
        console.error('Insufficient data for GDP statistics');
        return;
      }

      // Update current GDP
      const currentGDP = document.getElementById('current-gdp');
      const currentGDPDate = document.getElementById('current-gdp-date');
      const gdpRank = document.getElementById('gdp-rank');

      if (currentGDP && currentGDPDate) {
        const gdpValue = latestData['    Gross domestic product'];
        currentGDP.textContent = `$${gdpValue.toFixed(2)} trillion`;
        currentGDPDate.textContent = `As of ${latestData.fullQuarter}`;

        // Update GDP rank
        if (gdpRank) {
          gdpRank.textContent = 'Rank: #1 globally';
        }
      }

      // Update latest growth rate
      const latestGrowth = document.getElementById('latest-growth');
      const growthComparison = document.getElementById('growth-comparison');

      if (latestGrowth) {
        const currentGDP = latestData['    Gross domestic product'];
        const previousGDP = previousQuarterData['    Gross domestic product'];
        const growthRate = (Math.pow(currentGDP / previousGDP, 4) - 1) * 100;

        latestGrowth.textContent = `${growthRate.toFixed(2)}%`;

        // Add color based on growth rate
        if (growthRate > 0) {
          latestGrowth.className = 'text-3xl font-bold text-green-700';
        } else if (growthRate < 0) {
          latestGrowth.className = 'text-3xl font-bold text-red-700';
        } else {
          latestGrowth.className = 'text-3xl font-bold text-gray-700';
        }

        // Update growth comparison
        if (growthComparison) {
          // Calculate average growth rate over the last 10 years (40 quarters)
          const last40Quarters = sortedRealData.slice(0, 40);
          let totalGrowth = 0;
          let count = 0;

          for (let i = 0; i < last40Quarters.length - 1; i++) {
            const current = last40Quarters[i]['    Gross domestic product'];
            const previous = last40Quarters[i+1]['    Gross domestic product'];
            const quarterGrowth = (Math.pow(current / previous, 4) - 1) * 100;
            totalGrowth += quarterGrowth;
            count++;
          }

          const avgGrowth = totalGrowth / count;
          growthComparison.textContent = `vs ${avgGrowth.toFixed(1)}% avg`;

          // Add color based on comparison
          if (growthRate > avgGrowth) {
            growthComparison.className = 'px-2 py-1 rounded bg-green-200 text-green-800 font-medium';
          } else {
            growthComparison.className = 'px-2 py-1 rounded bg-red-200 text-red-800 font-medium';
          }
        }
      }

      // Update year-over-year growth
      const yoyGrowth = document.getElementById('yoy-growth');
      const yoyTrend = document.getElementById('yoy-trend');

      if (yoyGrowth && yearAgoData) {
        const currentGDP = latestData['    Gross domestic product'];
        const yearAgoGDP = yearAgoData['    Gross domestic product'];
        const growthRate = ((currentGDP / yearAgoGDP) - 1) * 100;

        yoyGrowth.textContent = `${growthRate.toFixed(2)}%`;

        // Add color based on growth rate
        if (growthRate > 0) {
          yoyGrowth.className = 'text-3xl font-bold text-green-700';
        } else if (growthRate < 0) {
          yoyGrowth.className = 'text-3xl font-bold text-red-700';
        } else {
          yoyGrowth.className = 'text-3xl font-bold text-gray-700';
        }

        // Update YoY trend
        if (yoyTrend) {
          // Get data from 2 years ago for trend
          const twoYearsAgoIndex = sortedRealData.findIndex(row => {
            return row.year === latestData.year - 2 && row.quarter === latestData.quarter;
          });

          if (twoYearsAgoIndex >= 0) {
            const twoYearsAgoData = sortedRealData[twoYearsAgoIndex];
            const previousYoYGrowth = ((yearAgoGDP / twoYearsAgoData['    Gross domestic product']) - 1) * 100;

            // Determine trend
            let trendText = 'Trend: ';
            if (growthRate > previousYoYGrowth + 0.5) {
              trendText += '↗ Up';
              yoyTrend.className = 'px-2 py-1 rounded bg-green-200 text-green-800 font-medium';
            } else if (growthRate < previousYoYGrowth - 0.5) {
              trendText += '↘ Down';
              yoyTrend.className = 'px-2 py-1 rounded bg-red-200 text-red-800 font-medium';
            } else {
              trendText += '→ Stable';
              yoyTrend.className = 'px-2 py-1 rounded bg-blue-200 text-blue-800 font-medium';
            }

            yoyTrend.textContent = trendText;
          } else {
            yoyTrend.textContent = 'Trend: N/A';
          }
        }
      }

      // Update top contributing component
      const topComponent = document.getElementById('top-component');
      const topComponentValue = document.getElementById('top-component-value');
      const componentShare = document.getElementById('component-share');

      if (topComponent && topComponentValue) {
        // Calculate component contributions to growth
        const components = [
          { name: 'Consumption', key: 'Personal consumption expenditures' },
          { name: 'Investment', key: 'Gross private domestic investment' },
          { name: 'Government', key: 'Government consumption expenditures and gross investment' },
          { name: 'Net Exports', key: null, value: latestData['  Exports'] - latestData['  Imports'], prevValue: previousQuarterData['  Exports'] - previousQuarterData['  Imports'] }
        ];

        // Calculate contribution to growth for each component
        components.forEach(component => {
          if (component.key) {
            component.value = latestData[component.key];
            component.prevValue = previousQuarterData[component.key];
          }

          component.change = component.value - component.prevValue;
          component.contribution = (component.change / previousQuarterData['    Gross domestic product']) * 100;
          component.shareOfGDP = (component.value / latestData['    Gross domestic product']) * 100;
        });

        // Sort by absolute contribution (to show the largest contributor, positive or negative)
        components.sort((a, b) => Math.abs(b.contribution) - Math.abs(a.contribution));

        const leadingComponent = components[0];

        topComponent.textContent = leadingComponent.name;

        // Format contribution with sign
        const contributionText = leadingComponent.contribution > 0
          ? `+${leadingComponent.contribution.toFixed(2)}%`
          : `${leadingComponent.contribution.toFixed(2)}%`;

        topComponentValue.textContent = `Contributing ${contributionText}`;

        // Add color based on contribution
        if (leadingComponent.contribution > 0) {
          topComponent.className = 'text-3xl font-bold text-green-700';
        } else if (leadingComponent.contribution < 0) {
          topComponent.className = 'text-3xl font-bold text-red-700';
        } else {
          topComponent.className = 'text-3xl font-bold text-gray-700';
        }

        // Update component share
        if (componentShare) {
          componentShare.textContent = `${leadingComponent.shareOfGDP.toFixed(1)}% of GDP`;
        }
      }

      console.log('GDP key statistics updated successfully');
    } catch (error) {
      console.error('Error updating GDP key statistics:', error);
    }
  }

  // Create the main GDP chart
  function createGDPMainChart() {
    try {
      console.log('Creating main GDP chart...');
      if (!gdpData || (!gdpData.nominal.length && !gdpData.real.length)) {
        console.error('No GDP data available for main chart');
        return;
      }

      // Destroy existing chart if it exists
      if (gdpMainChart) {
        gdpMainChart.destroy();
        gdpMainChart = null;
      }

      const ctx = document.getElementById('gdp-main-chart').getContext('2d');

      // Get selected view type and data type
      const viewType = document.getElementById('gdp-view-type').value;
      const dataType = document.getElementById('gdp-data-type').value;

      // Update chart title based on selections
      updateGDPChartTitle(viewType, dataType);

      // Prepare data based on view type
      let chartData;
      if (viewType === 'levels') {
        chartData = prepareGDPLevelsData(dataType);
      } else if (viewType === 'growth') {
        chartData = prepareGDPGrowthData(dataType);
      } else if (viewType === 'components') {
        // For component view, we'll use the components chart instead
        document.getElementById('gdp-view-type').value = 'levels';
        chartData = prepareGDPLevelsData(dataType);
      }

      // Create chart configuration
      const chartConfig = {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.9)',
              titleColor: '#000',
              bodyColor: '#000',
              borderColor: '#ddd',
              borderWidth: 1,
              padding: 12,
              titleFont: {
                size: 16,
                weight: 'bold'
              },
              bodyFont: {
                size: 14
              },
              callbacks: {
                title(tooltipItems) {
                  return tooltipItems[0].label;
                },
                label(context) {
                  const label = context.dataset.label || '';
                  const value = context.parsed.y;
                  if (viewType === 'levels') {
                    return `${label}: $${value.toFixed(2)} trillion`;
                  } else if (viewType === 'growth') {
                    return `${label}: ${value.toFixed(2)}%`;
                  }
                  return `${label}: ${value}`;
                }
              }
            },
            legend: {
              position: 'top',
              labels: {
                boxWidth: 20,
                padding: 15,
                font: {
                  size: 14
                }
              }
            },
            annotation: {
              annotations: generateRecessionAnnotations()
            }
          },
          scales: {
            x: {
              type: 'category',
              grid: {
                display: true,
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                maxRotation: 0,
                autoSkip: true,
                font: {
                  size: 12
                }
              },
              title: {
                display: true,
                text: 'Quarter',
                font: {
                  size: 16,
                  weight: 'bold'
                },
                padding: {top: 10, bottom: 0}
              }
            },
            y: {
              beginAtZero: viewType === 'growth',
              ticks: {
                callback: function(value) {
                  if (viewType === 'levels') {
                    return '$' + value.toFixed(1) + ' T';
                  } else if (viewType === 'growth') {
                    return value.toFixed(1) + '%';
                  }
                  return value;
                },
                font: {
                  size: 12
                }
              },
              grid: {
                display: true,
                color: 'rgba(0, 0, 0, 0.05)',
                drawBorder: false
              },
              title: {
                display: true,
                text: viewType === 'levels' ? 'GDP (Trillions of Dollars)' : 'Percent Change',
                font: {
                  size: 16,
                  weight: 'bold'
                },
                padding: {top: 0, bottom: 10}
              }
            }
          },
          layout: {
            padding: {
              top: 10,
              right: 20,
              bottom: 10,
              left: 10
            }
          }
        }
      };

      // Add time period to chart title
      const timePeriod = document.getElementById('gdp-time-period').value;
      let timePeriodText = '';
      if (timePeriod === '5years') {
        timePeriodText = ' (Last 5 Years)';
      } else if (timePeriod === '10years') {
        timePeriodText = ' (Last 10 Years)';
      } else if (timePeriod === '20years') {
        timePeriodText = ' (Last 20 Years)';
      }

      if (timePeriodText) {
        chartConfig.options.plugins.title = {
          display: true,
          text: document.getElementById('gdp-chart-title').textContent + timePeriodText,
          font: {
            size: 18,
            weight: 'bold'
          },
          padding: {top: 10, bottom: 20}
        };
      }

      // Create the chart
      gdpMainChart = new Chart(ctx, chartConfig);

      console.log('Main GDP chart created successfully');
    } catch (error) {
      console.error('Error creating main GDP chart:', error);
    }
  }

  // Prepare GDP levels data for the main chart
  function prepareGDPLevelsData(dataType) {
    try {
      console.log('Preparing GDP levels data...');

      // Get the selected time period
      const timePeriod = document.getElementById('gdp-time-period').value;
      let startDate, endDate;

      // Calculate start and end dates based on selected time period
      const dates = calculateDateRange(timePeriod);
      startDate = dates.startDate;
      endDate = dates.endDate;

      // Filter data by date range
      let nominalData = [];
      let realData = [];

      if (dataType === 'nominal' || dataType === 'both') {
        nominalData = filterGDPDataByDateRange(gdpData.nominal, startDate, endDate);
      }

      if (dataType === 'real' || dataType === 'both') {
        realData = filterGDPDataByDateRange(gdpData.real, startDate, endDate);
      }

      // Prepare datasets
      const datasets = [];
      let labels = [];

      // For 'both' view, we need to align the quarters
      if (dataType === 'both') {
        // Get common quarters between nominal and real data
        const nominalQuarters = nominalData.map(row => row.fullQuarter);
        const realQuarters = realData.map(row => row.fullQuarter);
        const commonQuarters = nominalQuarters.filter(q => realQuarters.includes(q));

        // Filter data to only include common quarters
        nominalData = nominalData.filter(row => commonQuarters.includes(row.fullQuarter));
        realData = realData.filter(row => commonQuarters.includes(row.fullQuarter));

        // Sort by date
        nominalData.sort((a, b) => a.year - b.year || a.quarter - b.quarter);
        realData.sort((a, b) => a.year - b.year || a.quarter - b.quarter);

        // Extract labels (quarters)
        labels = nominalData.map(row => row.fullQuarter);
      } else if (dataType === 'nominal') {
        // Sort by date
        nominalData.sort((a, b) => a.year - b.year || a.quarter - b.quarter);

        // Extract labels (quarters)
        labels = nominalData.map(row => row.fullQuarter);
      } else if (dataType === 'real') {
        // Sort by date
        realData.sort((a, b) => a.year - b.year || a.quarter - b.quarter);

        // Extract labels (quarters)
        labels = realData.map(row => row.fullQuarter);
      }

      // Filter labels to show only every 4th quarter for better readability
      // when there are many data points
      if (labels.length > 40) {
        // Create a map of all data points
        const allDataMap = {};

        // For nominal data
        if (dataType === 'nominal' || dataType === 'both') {
          nominalData.forEach((row, index) => {
            allDataMap[row.fullQuarter] = {
              ...allDataMap[row.fullQuarter] || {},
              nominalIndex: index,
              nominalValue: row['    Gross domestic product']
            };
          });
        }

        // For real data
        if (dataType === 'real' || dataType === 'both') {
          realData.forEach((row, index) => {
            allDataMap[row.fullQuarter] = {
              ...allDataMap[row.fullQuarter] || {},
              realIndex: index,
              realValue: row['    Gross domestic product']
            };
          });
        }

        // Create filtered datasets that include all data points but only show labels for Q4
        const filteredLabels = labels.map(quarter => {
          // Show label only for Q4 of each year (or every 8th quarter for very large datasets)
          if (quarter.endsWith('Q4')) {
            return quarter;
          }
          return ''; // Empty string for quarters we don't want to show
        });

        labels = filteredLabels;
      }

      // Create datasets
      if (dataType === 'nominal' || dataType === 'both') {
        datasets.push({
          label: 'Nominal GDP',
          data: nominalData.map(row => row['    Gross domestic product']),
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.5)',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.1
        });
      }

      if (dataType === 'real' || dataType === 'both') {
        datasets.push({
          label: 'Real GDP (2017 Dollars)',
          data: realData.map(row => row['    Gross domestic product']),
          borderColor: 'rgb(255, 99, 132)',
          backgroundColor: 'rgba(255, 99, 132, 0.5)',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.1
        });
      }

      return { labels, datasets };
    } catch (error) {
      console.error('Error preparing GDP levels data:', error);
      return { labels: [], datasets: [] };
    }
  }

  // Prepare GDP growth rate data for the main chart
  function prepareGDPGrowthData(dataType) {
    try {
      console.log('Preparing GDP growth data...');

      // Get the selected time period
      const timePeriod = document.getElementById('gdp-time-period').value;
      let startDate, endDate;

      if (timePeriod === 'custom') {
        startDate = document.getElementById('gdp-start-date').value;
        endDate = document.getElementById('gdp-end-date').value;
      } else {
        // Calculate start and end dates based on selected time period
        const dates = calculateDateRange(timePeriod);
        startDate = dates.startDate;
        endDate = dates.endDate;
      }

      // Filter data by date range
      let nominalData = [];
      let realData = [];

      if (dataType === 'nominal' || dataType === 'both') {
        nominalData = filterGDPDataByDateRange(gdpData.nominal, startDate, endDate);
      }

      if (dataType === 'real' || dataType === 'both') {
        realData = filterGDPDataByDateRange(gdpData.real, startDate, endDate);
      }

      // Calculate growth rates
      const nominalGrowthData = calculateGDPGrowthRates(nominalData);
      const realGrowthData = calculateGDPGrowthRates(realData);

      // Prepare datasets
      const datasets = [];
      const labels = [];

      // For 'both' view, we need to align the quarters
      if (dataType === 'both') {
        // Get common quarters between nominal and real growth data
        const nominalQuarters = nominalGrowthData.map(row => row.fullQuarter);
        const realQuarters = realGrowthData.map(row => row.fullQuarter);
        const commonQuarters = nominalQuarters.filter(q => realQuarters.includes(q));

        // Filter data to only include common quarters
        const filteredNominalGrowth = nominalGrowthData.filter(row => commonQuarters.includes(row.fullQuarter));
        const filteredRealGrowth = realGrowthData.filter(row => commonQuarters.includes(row.fullQuarter));

        // Sort by date
        filteredNominalGrowth.sort((a, b) => a.year - b.year || a.quarter - b.quarter);
        filteredRealGrowth.sort((a, b) => a.year - b.year || a.quarter - b.quarter);

        // Extract labels (quarters)
        labels.push(...filteredNominalGrowth.map(row => row.fullQuarter));

        // Create datasets
        datasets.push({
          label: 'Nominal GDP Growth',
          data: filteredNominalGrowth.map(row => row.growthRate),
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.5)',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.1
        });

        datasets.push({
          label: 'Real GDP Growth',
          data: filteredRealGrowth.map(row => row.growthRate),
          borderColor: 'rgb(255, 99, 132)',
          backgroundColor: 'rgba(255, 99, 132, 0.5)',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.1
        });
      } else if (dataType === 'nominal') {
        // Sort by date
        nominalGrowthData.sort((a, b) => a.year - b.year || a.quarter - b.quarter);

        // Extract labels (quarters)
        labels.push(...nominalGrowthData.map(row => row.fullQuarter));

        // Create dataset
        datasets.push({
          label: 'Nominal GDP Growth',
          data: nominalGrowthData.map(row => row.growthRate),
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.5)',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.1
        });
      } else if (dataType === 'real') {
        // Sort by date
        realGrowthData.sort((a, b) => a.year - b.year || a.quarter - b.quarter);

        // Extract labels (quarters)
        labels.push(...realGrowthData.map(row => row.fullQuarter));

        // Create dataset
        datasets.push({
          label: 'Real GDP Growth',
          data: realGrowthData.map(row => row.growthRate),
          borderColor: 'rgb(255, 99, 132)',
          backgroundColor: 'rgba(255, 99, 132, 0.5)',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.1
        });
      }

      return { labels, datasets };
    } catch (error) {
      console.error('Error preparing GDP growth data:', error);
      return { labels: [], datasets: [] };
    }
  }

  // Create the GDP components chart
  function createGDPComponentsChart() {
    try {
      console.log('Creating GDP components chart...');
      if (!gdpData || (!gdpData.nominal.length && !gdpData.real.length)) {
        console.error('No GDP data available for components chart');
        return;
      }

      // Destroy existing chart if it exists
      if (gdpComponentsChart) {
        gdpComponentsChart.destroy();
        gdpComponentsChart = null;
      }

      const ctx = document.getElementById('gdp-components-chart').getContext('2d');

      // Get selected data type
      const dataType = document.getElementById('gdp-data-type').value;

      // Prepare data for the components chart
      const chartData = prepareGDPComponentsData(dataType);

      // Create chart configuration
      const chartConfig = {
        type: 'bar',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.9)',
              titleColor: '#000',
              bodyColor: '#000',
              borderColor: '#ddd',
              borderWidth: 1,
              padding: 12,
              titleFont: {
                size: 14,
                weight: 'bold'
              },
              bodyFont: {
                size: 12
              },
              callbacks: {
                label(context) {
                  const label = context.dataset.label || '';
                  const value = context.parsed.x;
                  return `${label}: $${value.toFixed(2)} trillion (${(value / chartData.totalGDP * 100).toFixed(1)}%)`;
                }
              }
            },
            legend: {
              display: false
            },
            title: {
              display: true,
              text: `GDP Components (${dataType === 'real' ? 'Real' : 'Nominal'}) - ${chartData.quarter}`,
              font: {
                size: 16,
                weight: 'bold'
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              grid: {
                display: true,
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value.toFixed(0) + ' B';
                },
                font: {
                  size: 12
                }
              },
              title: {
                display: true,
                text: 'Trillions of Dollars',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              }
            },
            y: {
              grid: {
                display: false
              },
              ticks: {
                font: {
                  size: 12
                }
              }
            }
          }
        }
      };

      // Create the chart
      gdpComponentsChart = new Chart(ctx, chartConfig);

      console.log('GDP components chart created successfully');
    } catch (error) {
      console.error('Error creating GDP components chart:', error);
    }
  }

  // Prepare data for the GDP components chart
  function prepareGDPComponentsData(dataType) {
    try {
      console.log('Preparing GDP components data...');

      // Use real or nominal data based on selection
      const data = dataType === 'real' ? gdpData.real : gdpData.nominal;

      // Get the selected quarter
      const selectedQuarter = document.getElementById('components-quarter').value;

      // Find the data for the selected quarter
      let quarterData = data.find(row => row.fullQuarter === selectedQuarter);

      // If no data found for the selected quarter, use the most recent quarter
      if (!quarterData) {
        console.warn(`No data found for quarter ${selectedQuarter}, using most recent quarter instead`);
        const sortedData = [...data].sort((a, b) => {
          if (a.year !== b.year) return b.year - a.year;
          return b.quarter - a.quarter;
        });

        quarterData = sortedData[0];
      }

      if (!quarterData) {
        console.error('No data available for GDP components');
        return { labels: [], datasets: [], totalGDP: 0, quarter: '' };
      }

      // Define the main GDP components to display
      const components = [
        { name: 'Personal Consumption', value: quarterData['Personal consumption expenditures'] },
        { name: 'Gross Private Investment', value: quarterData['Gross private domestic investment'] },
        { name: 'Government Expenditures', value: quarterData['Government consumption expenditures and gross investment'] },
        { name: 'Net Exports', value: quarterData['  Exports'] - quarterData['  Imports'] }
      ];

      // Sort components by value (descending)
      components.sort((a, b) => b.value - a.value);

      // Prepare chart data
      const labels = components.map(comp => comp.name);
      const values = components.map(comp => comp.value);

      // Generate colors for each component
      const backgroundColors = [
        'rgba(54, 162, 235, 0.7)',  // Blue
        'rgba(255, 99, 132, 0.7)',  // Red
        'rgba(255, 206, 86, 0.7)',  // Yellow
        'rgba(75, 192, 192, 0.7)',  // Teal
        'rgba(153, 102, 255, 0.7)', // Purple
        'rgba(255, 159, 64, 0.7)'   // Orange
      ];

      // Create dataset
      const datasets = [{
        label: 'Value',
        data: values,
        backgroundColor: backgroundColors.slice(0, components.length),
        borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
        borderWidth: 1
      }];

      return {
        labels,
        datasets,
        totalGDP: quarterData['    Gross domestic product'],
        quarter: quarterData.fullQuarter
      };
    } catch (error) {
      console.error('Error preparing GDP components data:', error);
      return { labels: [], datasets: [], totalGDP: 0, quarter: '' };
    }
  }

  // Update the GDP components table
  function updateGDPComponentsTable() {
    try {
      console.log('Updating GDP components table...');

      // Get selected data type
      const dataType = document.getElementById('gdp-data-type').value;

      // Use real or nominal data based on selection
      const data = dataType === 'real' ? gdpData.real : gdpData.nominal;

      // Get the selected quarter
      const selectedQuarter = document.getElementById('components-quarter').value;

      // Find the data for the selected quarter
      let quarterData = data.find(row => row.fullQuarter === selectedQuarter);

      // If no data found for the selected quarter, use the most recent quarter
      if (!quarterData) {
        console.warn(`No data found for quarter ${selectedQuarter}, using most recent quarter instead`);
        const sortedData = [...data].sort((a, b) => {
          if (a.year !== b.year) return b.year - a.year;
          return b.quarter - a.quarter;
        });

        quarterData = sortedData[0];
      }

      if (!quarterData) {
        console.error('No data available for GDP components table');
        return;
      }

      // Find the previous quarter's data
      const currentYear = quarterData.year;
      const currentQuarter = quarterData.quarter;

      let previousYear = currentYear;
      let previousQuarter = currentQuarter - 1;

      if (previousQuarter === 0) {
        previousYear = currentYear - 1;
        previousQuarter = 4;
      }

      const previousQuarterData = data.find(row => {
        return row.year === previousYear && row.quarter === previousQuarter;
      }) || quarterData; // Fallback to current quarter if previous not found

      // Define the main GDP components to display
      const components = [
        { name: 'Gross Domestic Product', value: quarterData['    Gross domestic product'], prevValue: previousQuarterData['    Gross domestic product'] },
        { name: 'Personal Consumption', value: quarterData['Personal consumption expenditures'], prevValue: previousQuarterData['Personal consumption expenditures'] },
        { name: 'Gross Private Investment', value: quarterData['Gross private domestic investment'], prevValue: previousQuarterData['Gross private domestic investment'] },
        { name: 'Government Expenditures', value: quarterData['Government consumption expenditures and gross investment'], prevValue: previousQuarterData['Government consumption expenditures and gross investment'] },
        { name: 'Exports', value: quarterData['  Exports'], prevValue: previousQuarterData['  Exports'] },
        { name: 'Imports', value: quarterData['  Imports'], prevValue: previousQuarterData['  Imports'] },
        { name: 'Net Exports', value: quarterData['  Exports'] - quarterData['  Imports'], prevValue: previousQuarterData['  Exports'] - previousQuarterData['  Imports'] }
      ];

      // Get the table body
      const tableBody = document.getElementById('gdp-components-body');
      tableBody.innerHTML = ''; // Clear existing content

      // Add rows for each component
      components.forEach(component => {
        const row = document.createElement('tr');

        // Component name
        const nameCell = document.createElement('td');
        nameCell.className = 'p-2 border';
        nameCell.textContent = component.name;
        row.appendChild(nameCell);

        // Value
        const valueCell = document.createElement('td');
        valueCell.className = 'p-2 border text-right';
        valueCell.textContent = `$${component.value.toFixed(2)}`;
        row.appendChild(valueCell);

        // Percentage of GDP
        const percentCell = document.createElement('td');
        percentCell.className = 'p-2 border text-right';
        const percentOfGDP = (component.value / quarterData['    Gross domestic product']) * 100;
        percentCell.textContent = `${percentOfGDP.toFixed(1)}%`;
        row.appendChild(percentCell);

        // Change from previous quarter
        const changeCell = document.createElement('td');
        changeCell.className = 'p-2 border text-right';
        const change = component.value - component.prevValue;
        const changePercent = (change / component.prevValue) * 100;

        // Format change with color
        if (change > 0) {
          changeCell.innerHTML = `<span class="text-green-600">+${changePercent.toFixed(1)}%</span>`;
        } else if (change < 0) {
          changeCell.innerHTML = `<span class="text-red-600">${changePercent.toFixed(1)}%</span>`;
        } else {
          changeCell.textContent = '0.0%';
        }

        row.appendChild(changeCell);

        // Add row to table
        tableBody.appendChild(row);
      });

      console.log('GDP components table updated successfully');
    } catch (error) {
      console.error('Error updating GDP components table:', error);
    }
  }
</script>
</body>
</html>
