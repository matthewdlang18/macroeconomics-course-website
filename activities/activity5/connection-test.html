<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity 5 Connection Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2.38.4/dist/umd/supabase.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #cce7ff; color: #004085; border: 1px solid #b8daff; }
        .loading { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Activity 5 Supabase Connection Test</h1>
    
    <div id="test-results"></div>
    
    <h2>Debug Information</h2>
    <pre id="debug-info"></pre>
    
    <script src="../../js/env.js"></script>
    <script>
        const testResults = document.getElementById('test-results');
        const debugInfo = document.getElementById('debug-info');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            testResults.appendChild(div);
        }
        
        function addDebugInfo(key, value) {
            debugInfo.textContent += `${key}: ${JSON.stringify(value, null, 2)}\n`;
        }
        
        async function runTests() {
            addResult('Starting connection tests...', 'loading');
            
            // Test 1: Check if environment variables are loaded
            addResult('Test 1: Environment Variables', 'info');
            if (typeof supabaseUrl !== 'undefined' && typeof supabaseKey !== 'undefined') {
                addResult('✓ Environment variables loaded successfully', 'success');
                addDebugInfo('supabaseUrl', supabaseUrl);
                addDebugInfo('supabaseKey exists', !!supabaseKey);
            } else {
                addResult('✗ Environment variables not loaded', 'error');
                return;
            }
            
            // Test 2: Check if Supabase library is available
            addResult('Test 2: Supabase Library', 'info');
            if (typeof supabase !== 'undefined') {
                addResult('✓ Supabase library loaded', 'success');
            } else {
                addResult('✗ Supabase library not loaded', 'error');
                return;
            }
            
            // Test 3: Initialize Supabase client
            addResult('Test 3: Initialize Client', 'info');
            let client;
            try {
                client = supabase.createClient(supabaseUrl, supabaseKey);
                addResult('✓ Supabase client created', 'success');
                addDebugInfo('client', 'Created successfully');
            } catch (error) {
                addResult('✗ Failed to create Supabase client: ' + error.message, 'error');
                addDebugInfo('client error', error);
                return;
            }
            
            // Test 4: Test database connection
            addResult('Test 4: Database Connection', 'info');
            try {
                const { data, error } = await client
                    .from('profiles')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    addResult('✗ Database connection failed: ' + error.message, 'error');
                    addDebugInfo('connection error', error);
                } else {
                    addResult('✓ Database connection successful', 'success');
                    addDebugInfo('connection test', 'Success');
                }
            } catch (error) {
                addResult('✗ Database connection error: ' + error.message, 'error');
                addDebugInfo('connection exception', error);
            }
            
            // Test 5: Test sections query
            addResult('Test 5: Sections Query', 'info');
            try {
                const { data: sections, error } = await client
                    .from('sections')
                    .select(`
                        id,
                        day,
                        time,
                        location,
                        profiles!fk_ta (
                            name
                        )
                    `)
                    .limit(5);
                
                if (error) {
                    addResult('✗ Sections query failed: ' + error.message, 'error');
                    addDebugInfo('sections error', error);
                } else {
                    addResult(`✓ Sections query successful (${sections.length} sections)`, 'success');
                    addDebugInfo('sections sample', sections);
                }
            } catch (error) {
                addResult('✗ Sections query error: ' + error.message, 'error');
                addDebugInfo('sections exception', error);
            }
            
            // Test 6: Test student validation
            addResult('Test 6: Student Validation', 'info');
            try {
                const { data: student, error } = await client
                    .from('profiles')
                    .select('*')
                    .eq('name', 'tpurdy')
                    .eq('passcode', '100729')
                    .eq('role', 'student')
                    .single();
                
                if (error) {
                    addResult('✗ Student validation failed: ' + error.message, 'error');
                    addDebugInfo('student error', error);
                } else {
                    addResult('✓ Student validation successful', 'success');
                    addDebugInfo('student found', { name: student.name, role: student.role });
                }
            } catch (error) {
                addResult('✗ Student validation error: ' + error.message, 'error');
                addDebugInfo('student exception', error);
            }
            
            addResult('All tests completed!', 'info');
        }
        
        // Wait for DOM to load, then run tests
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runTests);
        } else {
            runTests();
        }
    </script>
</body>
</html>
