<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity 5 Auth Debug</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2.38.4/dist/umd/supabase.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #cce7ff; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        button { margin: 5px; padding: 8px 15px; }
    </style>
</head>
<body>
    <h1>Activity 5 Authentication Debug</h1>
    
    <div class="debug-section info">
        <h3>Current State</h3>
        <div id="currentState">Loading...</div>
    </div>
    
    <div class="debug-section">
        <h3>LocalStorage Contents</h3>
        <pre id="localStorageContents"></pre>
        <button onclick="clearStorage()">Clear All LocalStorage</button>
    </div>
    
    <div class="debug-section">
        <h3>Auth Flow Test</h3>
        <button onclick="testAuthFlow()">Test Auth Initialization</button>
        <div id="authFlowResults"></div>
    </div>
    
    <div class="debug-section">
        <h3>DOM Element Check</h3>
        <div id="domCheck"></div>
    </div>

    <script src="../../js/env.js"></script>
    <script src="../../js/supabase-init.js"></script>
    
    <script>
        function updateCurrentState() {
            const state = {
                windowAuthService: !!window.authService,
                authServiceInitialized: window.authService ? window.authService.initialized : false,
                currentUser: window.authService ? window.authService.getCurrentUser() : null,
                currentSection: window.authService ? window.authService.getCurrentSection() : null,
                isAuthenticated: window.authService ? window.authService.isAuthenticated() : false
            };
            
            document.getElementById('currentState').innerHTML = '<pre>' + JSON.stringify(state, null, 2) + '</pre>';
        }
        
        function updateLocalStorage() {
            const storage = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('activity5')) {
                    storage[key] = localStorage.getItem(key);
                }
            }
            document.getElementById('localStorageContents').textContent = JSON.stringify(storage, null, 2);
        }
        
        function clearStorage() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('activity5')) {
                    keys.push(key);
                }
            }
            keys.forEach(key => localStorage.removeItem(key));
            updateLocalStorage();
            updateCurrentState();
            alert('Activity 5 localStorage cleared!');
        }
        
        async function testAuthFlow() {
            const results = document.getElementById('authFlowResults');
            results.innerHTML = '<p>Testing auth flow...</p>';
            
            try {
                // Simulate the auth initialization process
                console.log('=== AUTH FLOW DEBUG ===');
                
                // Check if auth elements exist (they won't on this page, but we can check)
                const authContainer = document.getElementById('authContainer');
                const activityContent = document.getElementById('activityContent');
                
                results.innerHTML += `<p>authContainer exists: ${!!authContainer}</p>`;
                results.innerHTML += `<p>activityContent exists: ${!!activityContent}</p>`;
                
                // Check saved data
                const savedUser = localStorage.getItem('activity5_user');
                const savedSection = localStorage.getItem('activity5_section');
                
                results.innerHTML += `<p>Saved user data: ${savedUser ? 'YES' : 'NO'}</p>`;
                results.innerHTML += `<p>Saved section data: ${savedSection ? 'YES' : 'NO'}</p>`;
                
                if (savedUser && savedSection) {
                    results.innerHTML += `<p style="color: red;"><strong>FOUND SAVED DATA - This is why login form disappears!</strong></p>`;
                    results.innerHTML += `<p>User: ${savedUser}</p>`;
                    results.innerHTML += `<p>Section: ${savedSection}</p>`;
                }
                
            } catch (error) {
                results.innerHTML += `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        function checkDOM() {
            const domCheck = document.getElementById('domCheck');
            const elements = [
                'authContainer',
                'activityContent', 
                'loginForm',
                'studentId',
                'passcode',
                'sectionSelect'
            ];
            
            let html = '<ul>';
            elements.forEach(id => {
                const exists = !!document.getElementById(id);
                html += `<li>${id}: ${exists ? '✅' : '❌'}</li>`;
            });
            html += '</ul>';
            domCheck.innerHTML = html;
        }
        
        // Run initial checks
        document.addEventListener('DOMContentLoaded', () => {
            updateCurrentState();
            updateLocalStorage();
            checkDOM();
            
            // Update state every 2 seconds to catch changes
            setInterval(() => {
                updateCurrentState();
            }, 2000);
        });
    </script>
</body>
</html>
