<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Housing Values Dashboard</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3.1.0/dist/topojson-client.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        #map {
            width: 100%;
            height: 600px;
        }
        .chart {
            width: 100%;
            height: 400px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-blue-700 text-white">
        <div class="container mx-auto py-6 px-4">
            <div class="flex items-center mb-2">
                <a href="../index.html" class="text-blue-100 hover:text-white mr-2">‚Üê Back to Home</a>
            </div>
            <h1 class="text-3xl font-bold">Housing Values Dashboard</h1>
            <p class="mt-2 text-blue-100">Interactive Visualization of US Housing Market Metrics</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto py-8 px-4">
        <!-- File Upload Section -->
        <section class="mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Upload Housing Data</h2>
                <input type="file" id="dataUpload" accept=".xlsx,.xls" class="w-full p-2 border rounded">
                <p id="fileStatus" class="mt-2 text-gray-600"></p>
            </div>
        </section>

        <!-- Map Section -->
        <section class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Total Weighted Housing Values Map</h2>
            <div id="map" class="border rounded-lg shadow-md"></div>
        </section>

        <!-- Interactive Graphs Section -->
        <section>
            <h2 class="text-2xl font-semibold mb-4">Detailed Metrics</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="metricSelect" class="block mb-2 font-medium">Select Metric:</label>
                    <select id="metricSelect" class="w-full p-2 border rounded">
                        <!-- Metrics will be dynamically populated -->
                    </select>
                    <div id="metricChart" class="chart mt-4"></div>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">Metric Description</h3>
                    <div id="metricDescription" class="bg-white p-4 rounded-lg shadow-md">
                        Select a metric to view its description and distribution.
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Global variables to store data
        let housingData = null;
        let geoData = null;

        // Load GeoJSON on page load
        d3.json('data/us-states.geojson').then(data => {
            geoData = data;
        });

        // File upload handler
        document.getElementById('dataUpload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            const fileStatus = document.getElementById('fileStatus');
            
            if (file) {
                fileStatus.textContent = 'Processing file...';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        // Read the file using SheetJS with more robust options
                        const workbook = XLSX.read(e.target.result, {
                            type: 'binary',
                            cellDates: true,
                            cellNF: true,
                            cellStyles: true
                        });
                        
                        // Get the first sheet
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // Convert sheet to JSON with options to handle different formats
                        housingData = XLSX.utils.sheet_to_json(worksheet, {
                            raw: false,
                            defval: null
                        });
                        
                        // Validate data
                        if (!housingData || housingData.length === 0) {
                            throw new Error('No data found in the Excel file');
                        }
                        
                        // Log first few rows for debugging
                        console.log('Parsed data:', housingData.slice(0, 3));
                        
                        // Check required columns
                        const requiredColumns = [
                            'State', 
                            'Median Sale Price Weight', 
                            'Median Sale Price Value', 
                            'Months Supply Weight', 
                            'Months Supply Value', 
                            'Days on Market Weight', 
                            'Days on Market Value', 
                            'Sale-to-List Weight', 
                            'Sale-to-List Value', 
                            'Total Weighted Value'
                        ];
                        
                        const missingColumns = requiredColumns.filter(col => 
                            !Object.keys(housingData[0]).includes(col)
                        );
                        
                        if (missingColumns.length > 0) {
                            throw new Error(`Missing columns: ${missingColumns.join(', ')}`);
                        }
                        
                        // Process the uploaded data
                        processUploadedData(housingData);
                        
                        fileStatus.textContent = `File uploaded successfully: ${file.name}`;
                    } catch (error) {
                        fileStatus.textContent = `Error processing file: ${error.message}`;
                        console.error('Excel parsing error:', error);
                        alert(`Error parsing Excel file: ${error.message}`);
                    }
                };
                
                reader.readAsBinaryString(file);
            }
        });

        function processUploadedData(data) {
            // Validate data structure
            if (!data || !Array.isArray(data) || data.length === 0) {
                alert('Invalid data format. Please upload a valid Excel file.');
                return;
            }

            // Dynamically populate metric selection
            const metricSelect = document.getElementById('metricSelect');
            metricSelect.innerHTML = ''; // Clear existing options
            
            // Find all numeric columns (excluding State)
            const metrics = Object.keys(data[0])
                .filter(key => 
                    key !== 'State' && 
                    typeof data[0][key] === 'number'
                );

            // Populate metric dropdown
            metrics.forEach(metric => {
                const option = document.createElement('option');
                option.value = metric;
                option.textContent = metric;
                metricSelect.appendChild(option);
            });

            // Create map
            createMap(data);

            // Initial chart (use first numeric column or 'Total Weighted Value' if exists)
            const initialMetric = metrics.find(m => m === 'Total Weighted Value') || metrics[0];
            updateMetricChart(initialMetric);

            // Metric selection event listener
            metricSelect.addEventListener('change', (e) => {
                updateMetricChart(e.target.value);
            });
        }

        function createMap(data) {
            // Prepare data for mapping
            const dataByState = {};
            data.forEach(item => {
                // Try to find a total or weighted value column
                const totalValue = item['Total Weighted Value'] || 
                                   item['Total Value'] || 
                                   Object.values(item).find(val => 
                                       typeof val === 'number' && 
                                       !val.toString().includes('.') // Avoid percentage columns
                                   ) || 0;
                dataByState[item.State] = totalValue;
            });

            // Clear previous map
            d3.select("#map").html("");

            // Create map
            const width = document.getElementById('map').clientWidth;
            const height = 600;

            const svg = d3.select("#map")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            const projection = d3.geoAlbersUsa()
                .fitSize([width, height], geoData);

            const path = d3.geoPath().projection(projection);

            // Color scale
            const colorScale = d3.scaleSequential(d3.interpolateBlues)
                .domain([
                    d3.min(Object.values(dataByState)) || 0, 
                    d3.max(Object.values(dataByState)) || 100
                ]);

            // Draw states
            svg.selectAll("path")
                .data(geoData.features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("fill", d => {
                    const stateName = d.properties.name;
                    return colorScale(dataByState[stateName] || 0);
                })
                .attr("stroke", "#fff")
                .attr("stroke-width", 1)
                .append("title", d => {
                    const stateName = d.properties.name;
                    return `${stateName}: ${(dataByState[stateName] || 0).toFixed(2)}`;
                });
        }

        function updateMetricChart(metric) {
            if (!housingData) return;

            const metricData = housingData.map(item => ({
                state: item.State,
                value: item[metric]
            })).sort((a, b) => b.value - a.value);

            // Update description
            document.getElementById('metricDescription').innerHTML = `
                <p class="font-bold mb-2">${metric}</p>
                <p>Detailed view of ${metric} across different states.</p>
                <p class="mt-2">Top States: ${metricData.slice(0,3).map(d => `${d.state} (${d.value.toFixed(2)})`).join(', ')}</p>
            `;

            // Create bar chart
            Plotly.newPlot('metricChart', [{
                x: metricData.map(d => d.state),
                y: metricData.map(d => d.value),
                type: 'bar',
                marker: {
                    color: '#3B82F6',
                    opacity: 0.7
                }
            }], {
                title: `${metric} Across States`,
                xaxis: { 
                    title: 'State',
                    tickangle: -45
                },
                yaxis: { title: 'Value' },
                margin: { b: 100, l: 50, r: 50, t: 50 }
            });
        }
    </script>
</body>
</html>