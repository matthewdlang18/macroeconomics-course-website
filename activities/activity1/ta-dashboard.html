<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Housing Market Analysis Map</title>
    <link rel="stylesheet" href="../../css/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <!-- SheetJS for Excel Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- D3.js for Color Scales -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        .map-container {
            height: 600px;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        
        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }

        /* Add some table styling for the Excel preview */
        .excel-preview table {
            border-collapse: collapse;
            width: 100%;
        }
        
        .excel-preview th, .excel-preview td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .excel-preview th {
            background-color: #f2f2f2;
        }
        
        .excel-preview tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body class="bg-gray-50">
    <header class="bg-blue-700 text-white py-6 px-4">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold">Housing Market Analysis Map</h1>
        </div>
    </header>

    <main class="container mx-auto py-8 px-4">
        <!-- File Upload Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-bold mb-3 text-blue-800">Upload Housing Market Data</h2>
            
            <div class="mb-4">
                <label for="fileUpload" class="block text-sm font-medium text-gray-700 mb-2">Upload Excel file:</label>
                <input type="file" id="fileUpload" accept=".xlsx,.xls" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100
                ">
            </div>
            
            <div id="status" class="mt-4 p-3 rounded-md hidden"></div>
        </div>

        <!-- Column Mapping (appears after upload) -->
        <div id="columnMappingSection" class="bg-white rounded-lg shadow p-6 mb-8 hidden">
            <h2 class="text-xl font-bold mb-3 text-blue-800">Column Mapping</h2>
            <p class="mb-4 text-gray-700">Select which columns contain your data:</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">State Column:</label>
                    <select id="stateColumn" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Select column...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Value Column:</label>
                    <select id="valueColumn" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Select column...</option>
                    </select>
                </div>
            </div>
            
            <button id="applyMapping" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Apply Mapping</button>
            

        <!-- Map Container -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-bold mb-3 text-blue-800">Housing Market Map</h2>
            <div id="mapContainer" class="map-container"></div>
            
            <!-- Legend -->
            <div class="mt-4 flex justify-center">
                <div id="legend" class="inline-block text-sm"></div>
            </div>
        </div>
        
        <!-- Summary Stats -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4 text-blue-800">Summary Statistics</h2>
            <div id="summaryStats" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="text-center text-gray-500">
                    Upload data to view statistics
                </div>
            </div>
        </div>
    </main>

        <script>
            // Global variables
            let map;
            let info;
            let geojsonLayer;
            let rawExcelData = null;
            let processedMapData = null;
            let columnMapping = {
                state: '',
                value: ''
            };
            let statesData = null; // Will hold the GeoJSON data
        
            // Color scale for the map
            const colorScale = d3.scaleThreshold()
                .domain([15, 25, 35, 45, 55, 65, 75, 85]) // Score ranges
                .range([
                    "#1E3F66", // Dark Blue for 0-15
                    "#2B6EBF", // Medium Blue for 15-25
                    "#85C1E9", // Light Blue for 25-35
                    "#ABEBC6", // Light Green for 35-45
                    "#239B56", // Dark Green for 45-55
                    "#F7DC6F", // Yellow for 55-65
                    "#F39C12", // Orange for 65-75
                    "#E74C3C", // Red for 75-85
                    "#8B0000"  // Dark Red for above
                ]);
                
            // Function to get color based on value
            function getColor(value) {
                return value === undefined ? '#cccccc' : colorScale(value);
            }
            
            // Function to load the GeoJSON file
            // Function to load the GeoJSON file
async function loadGeoJSON() {
    try {
        // Log to see what's happening
        console.log('Loading GeoJSON file...');
        
        // Try multiple relative paths to find the correct one
        const possiblePaths = [
            './data/us-states.geojson',
            '../data/us-states.geojson',
            '../../data/us-states.geojson',
            '/data/us-states.geojson',
            'us-states.geojson'
        ];
        
        let response = null;
        let loadedPath = '';
        
        // Try each path until one works
        for (const path of possiblePaths) {
            try {
                console.log(`Trying to load from: ${path}`);
                response = await fetch(path);
                if (response.ok) {
                    console.log(`Successfully loaded from: ${path}`);
                    loadedPath = path;
                    break;
                }
            } catch (e) {
                console.log(`Failed to load from ${path}: ${e.message}`);
            }
        }
        
        if (!response || !response.ok) {
            throw new Error(`Failed to load GeoJSON from any path. Last attempt status: ${response?.status} ${response?.statusText}`);
        }
        
        // Parse the JSON response
        statesData = await response.json();
        
        console.log('GeoJSON parsed successfully!');
        
        // Initialize the map once the GeoJSON is loaded
        initMap();
    } catch (error) {
        console.error('Error loading GeoJSON file:', error);
        showStatus(`Error loading map data: ${error.message}. Please check the console for details.`, 'error');
    }
}
            
            // Initialize the map
            function initMap() {
                // Only proceed if GeoJSON data is loaded
                if (!statesData) {
                    console.error('GeoJSON data not loaded');
                    showStatus('Error: Map data not loaded. Please refresh the page.', 'error');
                    return;
                }
                
                // Create the map
                map = L.map('mapContainer').setView([37.8, -96], 4);
                
                // Add OpenStreetMap tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
                
                // Add info control
                info = L.control();
                info.onAdd = function() {
                    this._div = L.DomUtil.create('div', 'info');
                    this.update();
                    return this._div;
                };
                
                info.update = function(props) {
                    this._div.innerHTML = '<h4>Housing Market Assessment</h4>' + 
                        (props ? 
                            `<b>${props.name}</b><br>Value: ${props.value !== undefined ? props.value.toFixed(1) : 'No data'}` :
                            'Hover over a state');
                };
                
                info.addTo(map);
                
                // Add legend
                const legend = L.control({position: 'bottomright'});
                legend.onAdd = function() {
                    const div = L.DomUtil.create('div', 'legend');
                    const grades = [0, 15, 25, 35, 45, 55, 65, 75, 85];
                    const labels = ['Strong Buyer\'s', 'Buyer\'s', 'Slight Buyer\'s', 'Balanced', 
                                   'Slight Seller\'s', 'Seller\'s', 'Strong Seller\'s', 'Extreme Seller\'s'];
                    
                    div.innerHTML = '<h4>Market Type</h4>';
                    
                    for (let i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                            (labels[i] ? labels[i] + '<br>' : '+');
                    }
                    
                    return div;
                };
                
                legend.addTo(map);
                
                // Add blank states to the map
                L.geoJson(statesData, {
                    style: {
                        fillColor: '#cccccc',
                        weight: 1,
                        opacity: 1,
                        color: 'white',
                        dashArray: '3',
                        fillOpacity: 0.7
                    }
                }).addTo(map);
            }
            
            // Show status message
            function showStatus(message, type = 'info') {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = 'mt-4 p-3 rounded-md';
                
                if (type === 'error') {
                    statusEl.classList.add('bg-red-50', 'text-red-700');
                } else if (type === 'success') {
                    statusEl.classList.add('bg-green-50', 'text-green-700');
                } else {
                    statusEl.classList.add('bg-blue-50', 'text-blue-700');
                }
                
                statusEl.classList.remove('hidden');
            }
            
            // Parse Excel file
            function parseExcel(data) {
                try {
                    // Read the Excel file
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheet];
                    
                    // Convert to JSON
                    return XLSX.utils.sheet_to_json(worksheet);
                } catch (error) {
                    console.error("Error parsing Excel file:", error);
                    return null;
                }
            }
            
            // Show Excel preview and column selection
            function showColumnSelection(data) {
                if (!data || data.length === 0) {
                    showStatus('No data found in the Excel file.', 'error');
                    return;
                }
                
                // Show the column mapping section
                document.getElementById('columnMappingSection').classList.remove('hidden');
                
                // Get all column names
                const columns = Object.keys(data[0]);
                
                // Populate the select elements
                const stateSelect = document.getElementById('stateColumn');
                const valueSelect = document.getElementById('valueColumn');
                
                // Clear existing options
                stateSelect.innerHTML = '<option value="">Select column...</option>';
                valueSelect.innerHTML = '<option value="">Select column...</option>';
                
                // Add options for each column
                columns.forEach(column => {
                    stateSelect.innerHTML += `<option value="${column}">${column}</option>`;
                    valueSelect.innerHTML += `<option value="${column}">${column}</option>`;
                });
                
                // Try to auto-select columns based on name
                const stateColumns = ['State', 'state', 'STATE', 'StateName', 'state_name'];
                const valueColumns = ['Value', 'value', 'StudentValue', 'Score', 'Total', 'Final'];
                
                // Auto-select state column if found
                for (const col of stateColumns) {
                    if (columns.includes(col)) {
                        stateSelect.value = col;
                        break;
                    }
                }
                
                // Auto-select value column if found
                for (const col of valueColumns) {
                    if (columns.includes(col)) {
                        valueSelect.value = col;
                        break;
                    }
                }
                
                // Generate Excel preview
                const previewTable = document.getElementById('excelPreview');
                let previewHTML = '<thead><tr>';
                
                // Add headers
                columns.forEach(column => {
                    previewHTML += `<th>${column}</th>`;
                });
                
                previewHTML += '</tr></thead><tbody>';
                
                // Add rows (limit to first 5)
                const previewRows = Math.min(data.length, 5);
                for (let i = 0; i < previewRows; i++) {
                    previewHTML += '<tr>';
                    columns.forEach(column => {
                        previewHTML += `<td>${data[i][column] !== undefined ? data[i][column] : ''}</td>`;
                    });
                    previewHTML += '</tr>';
                }
                
                previewHTML += '</tbody>';
                previewTable.innerHTML = previewHTML;
            }
            
            // Process data using the selected columns
            function processData() {
                if (!rawExcelData || !columnMapping.state || !columnMapping.value) {
                    showStatus('Please select both state and value columns.', 'error');
                    return;
                }
                
                // Create processed data with standardized format
                processedMapData = rawExcelData.map(row => {
                    const stateValue = row[columnMapping.state];
                    const numericValue = row[columnMapping.value];
                    
                    let parsedValue = null;
                    if (numericValue !== undefined && numericValue !== null) {
                        parsedValue = parseFloat(numericValue);
                        if (isNaN(parsedValue)) parsedValue = null;
                    }
                    
                    return {
                        state: stateValue,
                        value: parsedValue
                    };
                }).filter(item => item.state && item.value !== null);
                
                showStatus(`Processed ${processedMapData.length} states with valid data.`, 'success');
                updateMap();
            }
            
            // Update map with data
            function updateMap() {
                if (!statesData || !processedMapData) return;
                
                // Clear existing GeoJSON layer
                if (geojsonLayer) {
                    map.removeLayer(geojsonLayer);
                }
                
                // Create a state data lookup object
                const stateDataLookup = {};
                processedMapData.forEach(item => {
                    // Store by state name (both original and normalized)
                    stateDataLookup[item.state] = item.value;
                    stateDataLookup[normalizeStateName(item.state)] = item.value;
                });
                
                // Create the GeoJSON layer
                geojsonLayer = L.geoJson(statesData, {
                    style: function(feature) {
                        // Get state name from GeoJSON (try different property names)
                        const stateName = feature.properties.NAME || feature.properties.name || 
                                         feature.properties.stateName || feature.properties.State;
                        
                        // Try to find the value for this state
                        let value = stateDataLookup[stateName];
                        
                        // If not found, try with normalized name
                        if (value === undefined) {
                            value = stateDataLookup[normalizeStateName(stateName)];
                        }
                        
                        return {
                            fillColor: value !== undefined ? getColor(value) : '#cccccc',
                            weight: 1,
                            opacity: 1,
                            color: 'white',
                            dashArray: '3',
                            fillOpacity: 0.7
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        // Get state name from GeoJSON
                        const stateName = feature.properties.NAME || feature.properties.name || 
                                         feature.properties.stateName || feature.properties.State;
                        
                        // Try to find the value for this state
                        let value = stateDataLookup[stateName];
                        
                        // If not found, try with normalized name
                        if (value === undefined) {
                            value = stateDataLookup[normalizeStateName(stateName)];
                        }
                        
                        // Add properties to the layer for the info box
                        layer.properties = {
                            name: stateName,
                            value: value
                        };
                        
                        // Add hover events
                        layer.on({
                            mouseover: function(e) {
                                const layer = e.target;
                                layer.setStyle({
                                    weight: 2,
                                    color: '#666',
                                    dashArray: '',
                                    fillOpacity: 0.9
                                });
                                
                                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                                    layer.bringToFront();
                                }
                                
                                info.update(layer.properties);
                            },
                            mouseout: function(e) {
                                geojsonLayer.resetStyle(e.target);
                                info.update();
                            }
                        });
                    }
                }).addTo(map);
                
                // Update summary statistics
                updateSummaryStats();
            }
            
            // Normalize state name for better matching
            function normalizeStateName(name) {
                if (!name) return '';
                return name.toLowerCase().trim().replace(/\s+/g, ' ');
            }
            
            // Update summary statistics
            function updateSummaryStats() {
                const summaryEl = document.getElementById('summaryStats');
                
                if (!processedMapData || processedMapData.length === 0) {
                    summaryEl.innerHTML = '<div class="text-center text-gray-500">No data available</div>';
                    return;
                }
                
                // Extract values
                const values = processedMapData.map(item => item.value).filter(v => v !== null);
                
                if (values.length === 0) {
                    summaryEl.innerHTML = '<div class="text-center text-gray-500">No numeric values found</div>';
                    return;
                }
                
                // Calculate statistics
                const avg = values.reduce((sum, val) => sum + val, 0) / values.length;
                const min = Math.min(...values);
                const max = Math.max(...values);
                
                // Determine market type
                const marketType = avg <= 40 ? "Buyer's Market" : avg <= 60 ? "Balanced Market" : "Seller's Market";
                
                // Count states by market type
                const buyerCount = values.filter(v => v <= 40).length;
                const balancedCount = values.filter(v => v > 40 && v <= 60).length;
                const sellerCount = values.filter(v => v > 60).length;
                
                // Generate HTML
                let html = `
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-bold text-blue-800 mb-2">Market Assessment</h3>
                    <p class="text-sm text-gray-600 mb-1">States Analyzed: ${values.length}</p>
                    <p class="text-sm text-gray-600 mb-1">Average Score: ${avg.toFixed(1)}</p>
                    <p class="text-sm text-gray-600 mb-1">Overall Market: ${marketType}</p>
                    <p class="text-sm text-gray-600 mb-1">Range: ${min.toFixed(1)} - ${max.toFixed(1)}</p>
                </div>
                
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h3 class="font-bold text-purple-800 mb-2">Market Breakdown</h3>
                    <p class="text-sm text-gray-600 mb-1">Buyer's Markets: ${buyerCount} states</p>
                    <p class="text-sm text-gray-600 mb-1">Balanced Markets: ${balancedCount} states</p>
                    <p class="text-sm text-gray-600 mb-1">Seller's Markets: ${sellerCount} states</p>
                    <div class="mt-2 h-4 bg-gray-200 rounded-full overflow-hidden">
                        <div class="flex h-full">
                            <div class="bg-blue-500" style="width: ${(buyerCount / values.length * 100).toFixed(1)}%"></div>
                            <div class="bg-green-500" style="width: ${(balancedCount / values.length * 100).toFixed(1)}%"></div>
                            <div class="bg-yellow-500" style="width: ${(sellerCount / values.length * 100).toFixed(1)}%"></div>
                        </div>
                    </div>
                    <div class="flex text-xs mt-1 justify-between">
                        <span>Buyer's</span>
                        <span>Balanced</span>
                        <span>Seller's</span>
                    </div>
                </div>
                `;
                
                summaryEl.innerHTML = html;
            }
            
            // Set up event listeners when document is loaded
            document.addEventListener('DOMContentLoaded', function() {
                // First, load the GeoJSON data (this will initialize the map when done)
                loadGeoJSON();
                
                // File upload handler
                document.getElementById('fileUpload').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    showStatus('Loading data...');
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const data = new Uint8Array(event.target.result);
                        
                        // Parse the Excel file
                        const parsedData = parseExcel(data);
                        
                        if (parsedData && parsedData.length > 0) {
                            rawExcelData = parsedData;
                            showStatus(`Excel file loaded successfully: ${parsedData.length} rows found.`, 'success');
                            showColumnSelection(parsedData);
                        } else {
                            showStatus('Error parsing the Excel file or no data found.', 'error');
                        }
                    };
                    
                    reader.onerror = function() {
                        showStatus('Error reading the file.', 'error');
                    };
                    
                    reader.readAsArrayBuffer(file);
                });
                
                // Apply mapping button
                document.getElementById('applyMapping').addEventListener('click', function() {
                    columnMapping.state = document.getElementById('stateColumn').value;
                    columnMapping.value = document.getElementById('valueColumn').value;
                    
                    if (!columnMapping.state || !columnMapping.value) {
                        showStatus('Please select both state and value columns.', 'error');
                        return;
                    }
                    
                    processData();
                });
            });
        </script>
</body>
</html>