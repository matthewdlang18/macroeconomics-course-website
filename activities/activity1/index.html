<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Housing Market Analysis - Principles of Macroeconomics</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js for data visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- SheetJS for Excel file handling -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  .banner-container {
    position: relative;
    width: 100%;
    height: 0;
    padding-bottom: 25%; /* This sets the aspect ratio of the container */
    min-height: 150px; /* Slightly taller minimum height to accommodate nav links */
    max-height: 320px; /* Maximum height on large screens */
    overflow: hidden;
    background-color: #1d4ed8; /* bg-blue-700 as fallback */
  }
  
  .banner-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.9; /* Make the image slightly transparent */
  }
  
  .banner-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 1.5rem;
  }
  
  .nav-links {
    display: flex;
    flex-direction: column;
    margin-bottom: 0.75rem;
  }
  
  .nav-link {
    color: #bfdbfe; /* text-blue-100 */
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }
  
  .nav-link:hover {
    color: white;
  }
  
  .activity-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
    line-height: 1.2;
  }
  
  .activity-date {
    font-size: 0.875rem;
    margin-top: 0.5rem;
    color: #bfdbfe; /* text-blue-100 */
  }
  
  /* Medium screens */
  @media (min-width: 640px) {
    .banner-overlay {
      padding: 1.5rem 2rem;
    }
    
    .nav-links {
      flex-direction: row;
      align-items: center;
    }
    
    .nav-link {
      font-size: 1rem;
      margin-bottom: 0;
    }
    
    .nav-link:not(:first-child) {
      margin-left: 1rem;
    }
    
    .activity-title {
      font-size: 2rem;
    }
    
    .activity-date {
      font-size: 1rem;
    }
  }
  
  /* Large screens */
  @media (min-width: 1024px) {
    .banner-overlay {
      padding: 1.5rem 3rem;
    }
    
    .activity-title {
      font-size: 2.25rem;
    }
  }
</style>
</head>
<body class="bg-gray-50">
<!-- Header -->
<header>
  <div class="banner-container">
    <img src="../../images/banner7.png" alt="Housing Market Analysis Banner" class="banner-image">
    <div class="banner-overlay">
      <div class="container mx-auto">
        <div class="nav-links">
          <a href="../index.html" class="nav-link">← Back to Course Home</a>
          <a href="../index.html" class="nav-link">← Back to Activities</a>
        </div>
        <h1 class="activity-title">Discussion Activity 1: Housing Market Analysis</h1>
        <p class="activity-date">April 1-4, 2025</p>
      </div>
    </div>
  </div>
</header>


    <!-- Main Content -->
    <main class="container mx-auto py-8 px-4">
        <!-- Step Navigation Update -->
        <div class="flex mb-8 border-b">
            <button id="nav-instructions" class="step-nav font-medium px-4 py-2 border-b-2 border-blue-600 text-blue-600">1. Instructions</button>
            <button id="nav-upload" class="step-nav font-medium px-4 py-2 border-b-2 border-transparent text-gray-500">2. Upload Data</button>
            <button id="nav-analysis" class="step-nav font-medium px-4 py-2 border-b-2 border-transparent text-gray-500">3. Analysis</button>
            <button id="nav-ai-response" class="step-nav font-medium px-4 py-2 border-b-2 border-transparent text-gray-500">4. AI Response</button>
        </div>


        <!-- Steps Content -->
        <div id="step-instructions" class="step-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold mb-4">Activity Instructions</h2>
                
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-medium">Objective</h3>
                        <p style="margin-bottom: 20px;">In this activity, you and your group (of 2 to 3) will identify whether the housing market in a U.S. state is healthy or not by analyzing recent housing metrics data.</p>
                        <p>After you form your group, claim your state on the Google Sheet provided by your TA.</p>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-medium">Housing Market Metrics</h3>
                        <p class="mb-2">You'll analyze these five key metrics to determine market health:</p>
                        <div class="mt-3 space-y-4">
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <h4 class="font-medium">Median Sale Price</h4>
                                <p>The middle value of all home sale prices for a given period.</p>
                                <p class="mt-1 italic text-sm">A balanced market has 3-5% growth in prices per year.</p>
                            </div>
                            
                            <div class="p-4 bg-green-50 rounded-lg">
                                <h4 class="font-medium">Months' Supply (Months of Inventory)</h4>
                                <p>Number of months it would take to sell all the homes on the market, given the current pace of sales.</p>
                                <p class="mt-1 italic text-sm">A balanced market has 4-6 months of supply.</p>
                            </div>
                            
                            <div class="p-4 bg-yellow-50 rounded-lg">
                                <h4 class="font-medium">Days on Market</h4>
                                <p>The average number of days a home is listed for sale before it goes under contract (sold).</p>
                                <p class="mt-1 italic text-sm">In a balanced market, homes usually sell within 30-60 days.</p>
                            </div>
                            
                            <div class="p-4 bg-purple-50 rounded-lg">
                                <h4 class="font-medium">Sale-to-List</h4>
                                <p>A measure of how close the sale price is to the asking price set by the seller. Specifically (Sale Price/List Price) × 100.</p>
                                <p class="mt-1 italic text-sm">A sale-to-list price ratio between 98% to 102% is consistent with a balanced market.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-medium">Accessing Housing Data</h3>
                        <p class="mb-2">To gather data for your assigned state, follow these steps:</p>
                        <ol class="list-decimal pl-5 space-y-2">
                            <li>Your TA will show a QR code that links to a Google Sheet</li>
                            <li>Claim your state by entering your group name next to the state (first come, first served)</li>
                            <li>Go to the <a href="https://www.redfin.com/news/data-center/" class="text-blue-600 underline" target="_blank">Redfin Data Center</a></li>
                            <li>Find the "Redfin Monthly Housing Market Data" section</li>
                            <li>Remove metro areas by clicking "Region Type" and unchecking "County", "Metro", and "Place/City"</li>
                            <li>Keep "National" and "State" checked</li>
                            <li>Click on "Region" and select your assigned state</li>
                            <li>Click "Apply" to see the data</li>
                            <li>Click on the "Download" button and the raw data will appear</li>
                            <li>Click the download button, then "Crosstab" button, and choose Excel</li>
                            <li>Save the file to upload in the next step of this activity</li>
                        </ol>
                    </div>
                    
                    <div class="flex justify-end">
                        <button id="next-upload" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Next: Upload Your Data</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="step-upload" class="step-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold mb-4">Upload Your Housing Data</h2>
                
                <p class="mb-4">Upload the housing data Excel file you downloaded from Redfin for your state.</p>
                
                <div class="p-4 bg-yellow-50 rounded-lg mb-6">
                    <h3 class="font-medium">Data Upload Instructions:</h3>
                    <ol class="list-decimal pl-5 space-y-1 mt-2">
                        <li>Make sure you've downloaded the Excel file (.xlsx) from Redfin Data Center</li>
                        <li>Click the "Upload File" button below to select your file</li>
                        <li>Once uploaded, we will generate visualizations to help with your analysis</li>
                    </ol>
                </div>
                
                <div class="border-2 border-dashed rounded-md p-6 flex flex-col items-center justify-center mb-6">
                    <div id="upload-area" class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p class="text-gray-500 mb-3">Drag & drop your Excel file here or click to browse</p>
                        <button id="upload-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Upload File</button>
                        <input type="file" id="file-input" class="hidden" accept=".xlsx,.xls">
                    </div>
                    <div id="file-uploaded" class="hidden">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span id="filename" class="text-green-700 font-medium">housing_data.xlsx</span>
                            <button id="remove-file" class="ml-3 text-red-500 text-sm underline">Remove</button>
                        </div>
                        <div class="text-gray-700 mt-2">
                            <p id="file-stats">File loaded successfully. Click "Next" to proceed to analysis.</p>
                        </div>
                    </div>
                </div>
                
                <div id="data-preview" class="hidden">
                    <h3 class="font-medium mb-3">Data Preview</h3>
                    <div class="overflow-x-auto mb-4">
                        <table id="preview-table" class="min-w-full border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100">
                                    <!-- Table headers will be inserted here -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <p class="text-sm text-gray-600">Showing preview of data that will be used for analysis.</p>
                </div>
                
                <div class="flex justify-between mt-6">
                    <button id="back-to-instructions" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">Back to Instructions</button>
                    <button id="next-to-analysis" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700" disabled>Next: Analyze Data</button>
                </div>
            </div>
        </div>
        
        <div id="step-analysis" class="step-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold mb-4">Housing Market Analysis</h2>
                
                <div class="bg-blue-50 p-4 rounded-lg mb-6">
                    <h3 class="font-medium">How to Complete the Analysis:</h3>
                    <ol class="list-decimal pl-5 space-y-1 mt-2">
                        <li><strong>Weight</strong>: Assign a weight to each metric based on importance (weights must sum to 100)
                            <ul class="list-disc pl-5 mt-1 text-sm">
                                <li>If all metrics are equally important: 25 per metric</li>
                                <li>If one metric matters more, give it a higher weight</li>
                            </ul>
                        </li>
                        <li><strong>Value</strong>: Assign a value from 1-100 for each metric:
                            <ul class="list-disc pl-5 mt-1 text-sm">
                                <li>Below 50: Market favors buyers</li>
                                <li>Above 50: Market favors sellers</li>
                                <li>Around 50: Balanced market</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <!-- Add this to the analysis section to show comparison controls -->
<div class="mb-6 flex items-center">
    <label for="time-range" class="mr-2 text-sm">Data Time Range:</label>
    <select id="time-range" class="border rounded p-1 text-sm">
        <option value="12">Last 12 months</option>
        <option value="24">Last 24 months</option>
        <option value="60" selected>Last 5 years</option>
        <option value="all">All data</option>
    </select>
    

</div>

<!-- Add this to the explanation section -->
<div class="bg-blue-50 p-4 rounded-lg mb-6">
    <h3 class="font-medium mb-2">Understanding the Comparison:</h3>
    <ul class="list-disc pl-5 space-y-1">
        <li>Your state data is shown as <span class="font-medium text-blue-600">solid blue lines</span></li>
        <li>Balanced market ranges are shown as <span class="font-medium text-green-600">green shaded areas</span></li>
    </ul>
</div>
                
                <div class="space-y-6">
                    <!-- Median Sale Price -->
                    <div class="bg-white p-4 border rounded-lg">
                        <h3 class="text-lg font-medium mb-3">Median Sale Price</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                            <!-- Metric Input -->
                            <div>
                                <div class="border p-4 rounded-lg bg-blue-50">
                                    <p class="text-sm mb-2">Balanced: 3-5% growth/year</p>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Weight:</label>
                                            <input type="number" class="weight-input w-full text-center border rounded p-1" data-metric="price" min="0" max="100" step="1" value="25">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Value:</label>
                                            <input type="number" class="value-input w-full text-center border rounded p-1" data-metric="price" min="1" max="100" step="1" value="50">
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <p class="text-sm">Weighted Value: <span class="font-medium weighted-value" data-metric="price">10.00</span></p>
                                    </div>
                                </div>
                            </div>
                            <!-- Chart -->
                            <div class="chart-container relative" style="height: 180px;">
                                <canvas id="priceChart"></canvas>
                                <div class="mt-2 text-xs text-gray-600">
                                    <p><span class="font-medium">Current Value:</span> $<span id="price-value">350,000</span></p>
                                    <p><span class="font-medium">Annual Growth:</span> <span id="price-growth">5.2%</span> (Balanced: 3-5%)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Months' Supply -->
                    <div class="bg-white p-4 border rounded-lg">
                        <h3 class="text-lg font-medium mb-3">Months' Supply</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                            <!-- Metric Input -->
                            <div>
                                <div class="border p-4 rounded-lg bg-green-50">
                                    <p class="text-sm mb-2">Balanced: 4-6 months</p>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Weight:</label>
                                            <input type="number" class="weight-input w-full text-center border rounded p-1" data-metric="supply" min="0" max="100" step="1" value="25">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Value:</label>
                                            <input type="number" class="value-input w-full text-center border rounded p-1" data-metric="supply" min="1" max="100" step="1" value="50">
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <p class="text-sm">Weighted Value: <span class="font-medium weighted-value" data-metric="supply">10.00</span></p>
                                    </div>
                                </div>
                            </div>
                            <!-- Chart -->
                            <div class="chart-container relative" style="height: 180px;">
                                <canvas id="supplyChart"></canvas>
                                <div class="mt-2 text-xs text-gray-600">
                                    <p><span class="font-medium">Current:</span> <span id="supply-value">2.1</span> months</p>
                                    <p><span class="font-medium">Balanced:</span> 4-6 months</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Days on Market -->
                    <div class="bg-white p-4 border rounded-lg">
                        <h3 class="text-lg font-medium mb-3">Days on Market</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                            <!-- Metric Input -->
                            <div>
                                <div class="border p-4 rounded-lg bg-yellow-50">
                                    <p class="text-sm mb-2">Balanced: 30-60 days</p>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Weight:</label>
                                            <input type="number" class="weight-input w-full text-center border rounded p-1" data-metric="days" min="0" max="100" step="1" value="25">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Value:</label>
                                            <input type="number" class="value-input w-full text-center border rounded p-1" data-metric="days" min="1" max="100" step="1" value="50">
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <p class="text-sm">Weighted Value: <span class="font-medium weighted-value" data-metric="days">10.00</span></p>
                                    </div>
                                </div>
                            </div>
                            <!-- Chart -->
                            <div class="chart-container relative" style="height: 180px;">
                                <canvas id="daysChart"></canvas>
                                <div class="mt-2 text-xs text-gray-600">
                                    <p><span class="font-medium">Current:</span> <span id="days-value">15</span> days</p>
                                    <p><span class="font-medium">Balanced:</span> 30-60 days</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sale-to-List -->
                    <div class="bg-white p-4 border rounded-lg">
                        <h3 class="text-lg font-medium mb-3">Sale-to-List Ratio</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                            <!-- Metric Input -->
                            <div>
                                <div class="border p-4 rounded-lg bg-purple-50">
                                    <p class="text-sm mb-2">Balanced: 98-102%</p>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Weight:</label>
                                            <input type="number" class="weight-input w-full text-center border rounded p-1" data-metric="saleToList" min="0" max="100" step="1" value="25">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Value:</label>
                                            <input type="number" class="value-input w-full text-center border rounded p-1" data-metric="saleToList" min="1" max="100" step="1" value="50">
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <p class="text-sm">Weighted Value: <span class="font-medium weighted-value" data-metric="saleToList">10.00</span></p>
                                    </div>
                                </div>
                            </div>
                            <!-- Chart -->
                            <div class="chart-container relative" style="height: 180px;">
                                <canvas id="saleToListChart"></canvas>
                                <div class="mt-2 text-xs text-gray-600">
                                    <p><span class="font-medium">Current:</span> <span id="sale-to-list-value">101.5%</span></p>
                                    <p><span class="font-medium">Balanced:</span> 98-102%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    
                    
                    <!-- Final Assessment Section -->
                    <div class="bg-white p-4 border rounded-lg">
                        <div id="weight-warning" class="hidden text-red-600 mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            Weights must sum to 100. Please adjust your weights.
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Totals -->
                            <div>
                                <h3 class="text-lg font-medium mb-3">Total Analysis</h3>
                                <table class="w-full border-collapse">
                                    <tr>
                                        <td class="border p-2 font-medium">Total Weight:</td>
                                        <td class="border p-2 font-bold text-center" id="total-weight">100</td>
                                    </tr>
                                    <tr>
                                        <td class="border p-2 font-medium">Final Score:</td>
                                        <td class="border p-2 font-bold text-center" id="total-weighted-value">50.00</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- Market Assessment -->
                            <div>
                                <h3 class="text-lg font-medium mb-3">Your Market Assessment:</h3>
                                <div class="p-4 border rounded-lg">
                                    <p class="text-lg mb-3">
                                        The housing market is a 
                                        <span id="market-type" class="font-bold">balanced</span> market with a score of 
                                        <span id="final-score" class="font-bold">50.00</span>.
                                    </p>
                                    <div class="relative pt-1">
                                        <div class="overflow-hidden h-6 text-xs flex rounded bg-gray-200">
                                            <div class="w-1/3 bg-blue-300 rounded-l"></div>
                                            <div class="w-1/3 bg-green-300"></div>
                                            <div class="w-1/3 bg-red-300 rounded-r"></div>
                                            <div id="score-marker" class="absolute h-full w-1 bg-black" style="left: 50%"></div>
                                        </div>
                                        <div class="flex justify-between text-xs mt-1">
                                            <span>0 - Buyers</span>
                                            <span>40</span>
                                            <span>60</span>
                                            <span>Sellers - 100</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-lg mt-6">
                    <p><strong>Important:</strong> After completing your analysis, one member of your group should enter your values in the Google Sheet provided by your TA. Your TA will use this data to create visual maps showing market assessments across all states.</p>
                </div>
                
                <div class="flex justify-between mt-6">
                    <button id="back-to-upload" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">Back to Data Upload</button>
                    <div class="flex space-x-3">
        
                        <button id="finish-activity" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">AI Analysis</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="step-ai-response" class="step-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold mb-4">AI Housing Market Analysis</h2>
                
                <div class="bg-blue-50 p-4 rounded-lg mb-6">
                    <h3 class="font-medium">How to Complete the AI Analysis:</h3>
                    <ol class="list-decimal pl-5 space-y-1 mt-2">
                        <li>Choose an AI platform from the list below</li>
                        <li>Click the "Copy Prompt" button to copy the standardized analysis prompt</li>
                        <li>Paste the prompt into your chosen AI tool</li>
                        <li>Upload your state's housing market data</li>
                        <li>The AI should complete the analysis table</li>
                        <li>Input the AI's numerical responses into the second class Google Sheet</li>
                    </ol>
                </div>
        
                <div class="mb-6">
                    <h3 class="font-medium mb-4">Select an AI Platform:</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <a href="https://chat.openai.com" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center p-4 border rounded-lg hover:bg-blue-50 transition-colors">
                            <span class="font-medium">ChatGPT</span>
                            <span class="text-xs text-gray-500 mt-1">OpenAI</span>
                        </a>
                        <a href="https://www.perplexity.ai" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center p-4 border rounded-lg hover:bg-blue-50 transition-colors">
                            <span class="font-medium">Perplexity</span>
                            <span class="text-xs text-gray-500 mt-1">perplexity.ai</span>
                        </a>
                        <a href="https://gemini.google.com" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center p-4 border rounded-lg hover:bg-blue-50 transition-colors">
                            <span class="font-medium">Google Gemini</span>
                            <span class="text-xs text-gray-500 mt-1">Google</span>
                        </a>
                        <a href="https://chat.mistral.ai" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center p-4 border rounded-lg hover:bg-blue-50 transition-colors">
                            <span class="font-medium">Mistral</span>
                            <span class="text-xs text-gray-500 mt-1">mistral.ai</span>
                        </a>
                        <a href="https://claude.ai" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center p-4 border rounded-lg hover:bg-blue-50 transition-colors">
                            <span class="font-medium">Claude</span>
                            <span class="text-xs text-gray-500 mt-1">Anthropic</span>
                        </a>
                        <a href="https://chat.deepseek.com" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center p-4 border rounded-lg hover:bg-blue-50 transition-colors">
                            <span class="font-medium">Deepseek</span>
                            <span class="text-xs text-gray-500 mt-1">www.deepseek.com</span>
                        </a>
                    </div>
                    <p class="text-sm text-gray-600 italic mt-2">Note: ChatGPT (non-Plus version) is limited in analysis capacity. Claude Pro may be needed for larger files.</p>
                </div>
                
                <div class="mb-6">
                    <h3 class="font-medium mb-2">AI Analysis Prompt:</h3>
                    <div class="bg-gray-100 p-4 rounded-lg mb-3">
                        <p class="italic text-gray-800">
                            Examine this data and assess the health of the <span id="ai-state-name">[State Name]</span> housing market. Fill out the table where 1 is a market where nothing is selling because there are literally no buyers and 100 is an overheated market, where homes are sold before they even hit the market, and it is hard to find a house to purchase. Give me your final total weighted value and provide a justification for your response.
                        </p>
                        <div class="mt-3">
                            <table class="w-full border">
                                <thead>
                                    <tr class="bg-gray-200">
                                        <th class="border p-2">Housing Metric</th>
                                        <th class="border p-2">Weight</th>
                                        <th class="border p-2">Value</th>
                                        <th class="border p-2">Weighted Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border p-2">Median Sale Price</td>
                                        <td class="border p-2"></td>
                                        <td class="border p-2"></td>
                                        <td class="border p-2"></td>
                                    </tr>
                                    <tr>
                                        <td class="border p-2">Months' Supply</td>
                                        <td class="border p-2"></td>
                                        <td class="border p-2"></td>
                                        <td class="border p-2"></td>
                                    </tr>
                                    <tr>
                                        <td class="border p-2">Days on Market</td>
                                        <td class="border p-2"></td>
                                        <td class="border p-2"></td>
                                        <td class="border p-2"></td>
                                    </tr>
                                    <tr>
                                        <td class="border p-2">Sale-to-List</td>
                                        <td class="border p-2"></td>
                                        <td class="border p-2"></td>
                                        <td class="border p-2"></td>
                                    </tr>
                                    <tr>
                                        <td class="border p-2 font-bold">Total</td>
                                        <td class="border p-2">Must Sum to 100</td>
                                        <td class="border p-2"></td>
                                        <td class="border p-2"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <button id="copy-ai-prompt" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        Copy Prompt to Clipboard
                    </button>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-lg mt-6">
                    <p><strong>Important:</strong> After completing your AI analysis:</p>
                    <ol class="list-decimal pl-5 mt-1">
                        <li>Discuss the AI's assessment with your group</li>
                        <li>Fill out the handout and turn it into the TA</li>
                        <li>Prepare for class discussion about your analysis</li>
                    </ol>
                </div>
                
                <div class="flex justify-between mt-6">
                    <button id="back-to-analysis" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">Back to Analysis</button>
                    <button id="submit-ai-response" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Submit Final Analysis</button>
                </div>
            </div>
        </div>

<!-- The Completion Modal (updated to match style) -->
<div id="completion-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full shadow-xl">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold">Activity Part 1 Completed!</h2>
            <button id="close-modal-x" class="text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <p class="mb-4">You have successfully completed Part 1 of the Housing Market Analysis activity.</p>
        <p class="mb-2">Your final assessment: The housing market is a <span id="modal-market-type" class="font-bold">balanced</span> market with a score of <span id="modal-score" class="font-bold">50.00</span>.</p>
        
        <hr class="my-4 border-gray-200">
        
        <h3 class="text-xl font-semibold mb-3">Part 2: AI Analysis of Housing Market</h3>
        <p class="mb-4">Now let's get feedback on your assessment using AI tools.</p>
        
        <div class="p-4 bg-blue-50 rounded-lg mb-4 border border-blue-100">
            <h4 class="font-medium mb-2">Step 1: Choose an AI Tool</h4>
            <p class="mb-3">Navigate to one of these AI platforms:</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-2">
                <a href="https://chatgpt.com" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center p-3 border rounded-lg hover:bg-white transition-colors">
                    <img src="/api/placeholder/24/24" alt="ChatGPT" class="mb-1 rounded">
                    <span class="font-medium">ChatGPT</span>
                    <span class="text-xs text-gray-500">OpenAI</span>
                </a>
                <a href="https://www.perplexity.ai" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center p-3 border rounded-lg hover:bg-white transition-colors">
                    <img src="/api/placeholder/24/24" alt="Perplexity" class="mb-1 rounded">
                    <span class="font-medium">Perplexity</span>
                    <span class="text-xs text-gray-500">perplexity.ai</span>
                </a>
                <a href="https://mistral.ai" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center p-3 border rounded-lg hover:bg-white transition-colors">
                    <img src="/api/placeholder/24/24" alt="Mistral" class="mb-1 rounded">
                    <span class="font-medium">Mistral</span>
                    <span class="text-xs text-gray-500">mistral.ai</span>
                </a>
                <a href="https://claude.ai" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center p-3 border rounded-lg hover:bg-white transition-colors">
                    <img src="/api/placeholder/24/24" alt="Claude" class="mb-1 rounded">
                    <span class="font-medium">Claude</span>
                    <span class="text-xs text-gray-500">Anthropic</span>
                </a>
            </div>
            <p class="text-sm text-gray-600 italic">Note: ChatGPT (non-Plus version) is limited in analysis capacity. Claude Pro may be needed for larger files.</p>
        </div>
        
        <div class="p-4 bg-blue-50 rounded-lg mb-4 border border-blue-100">
            <h4 class="font-medium mb-2">Step 2: Copy and Paste This Prompt</h4>
            <div class="bg-white p-3 rounded border mb-3">
                <p class="text-gray-800">
                    Examine this data and assess the health of the <span id="modal-state-name" class="font-medium">[your state]</span> housing market. Fill out the table where 1 is a market where nothing is selling because there are literally no buyers and 100 is an overheated market, where homes are sold before they even hit the market, and it is hard to find a house to purchase. Give me your final total weighted value and provide a justification for your response.
                </p>
                <p class="text-gray-800 mt-2">
                    Housing Metric | Weight | Value | Weighted Value<br/>
                    --------------|--------|-------|----------------<br/>
                    Median Sale Price | | | <br/>
                    Months' Supply | | | <br/>
                    Days on Market | | | <br/>
                    Sale-to-List | | | <br/>
                    Total | Must Sum to 100 | | 
                </p>
            </div>
            <button 
                id="modal-copy-prompt-btn"
                class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors flex items-center justify-center"
                onclick="copyModalPromptToClipboard()"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8z" />
                    <path d="M3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15v3a2 2 0 01-2 2H5a2 2 0 01-2-2V5zM15 11h2a1 1 0 110 2h-2v-2z" />
                </svg>
                Copy Prompt to Clipboard
            </button>
        </div>
        
        <div class="p-4 bg-blue-50 rounded-lg mb-4 border border-blue-100">
            <h4 class="font-medium mb-2">Step 3: Complete Your Analysis</h4>
            <ul class="list-disc pl-5 space-y-1">
                <li>Upload your Redfin data file if the AI tool requests it</li>
                <li>Record the AI's assessment values in Part 2 of your handout</li>
                <li>Input the AI values into the 2nd Google Sheet</li>
                <li>Answer the reflection questions on the back of your handout</li>
            </ul>
        </div>
        
        <div class="p-4 bg-yellow-50 rounded-lg mb-4 border border-yellow-100">
            <div class="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500 mr-2 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <div>
                    <p class="font-medium">Final Steps:</p>
                    <ol class="list-decimal pl-5 mt-1 space-y-1">
                        <li>One group member should enter your values in the TA's Google Sheet</li>
                        <li>Your TA will create visual maps showing all states' market assessments</li>
                        <li>Prepare to discuss your analysis with the class</li>
                    </ol>
                </div>
            </div>
        </div>
        
        <div class="flex justify-end space-x-3">
            <button id="close-modal" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors flex items-center">
                Return to Analysis
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- JavaScript to fix the Copy Prompt functionality -->
<script>
    // This script specifically fixes the copy functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Make sure this runs after the page has fully loaded
        setTimeout(function() {
            const copyButton = document.getElementById('copy-ai-prompt');
            
            if (copyButton) {
                // Remove any existing event listeners to avoid duplicates
                const newCopyButton = copyButton.cloneNode(true);
                copyButton.parentNode.replaceChild(newCopyButton, copyButton);
                
                // Add the event listener to the new button
                newCopyButton.addEventListener('click', function() {
                    // Get the state name
                    let stateName = document.getElementById('ai-state-name').textContent || '[Your State]';
                    
                    // Create the prompt text
                    const prompt = `Examine this data and assess the health of the ${stateName} housing market. Fill out the table where 1 is a market where nothing is selling because there are literally no buyers and 100 is an overheated market, where homes are sold before they even hit the market, and it is hard to find a house to purchase. Give me your final total weighted value and provide a justification for your response.
    
Housing Metric	Weight	Value	Weighted Value (Weight/100 x Value)
Median Sale Price	
Months’ Supply	
Days on Market	
Sale-to-List	
Total	
Must Sum to 100
`;
                    
                    // Simple approach first - create a textarea, copy from it, then remove it
                    const textArea = document.createElement('textarea');
                    textArea.value = prompt;
                    textArea.style.position = 'fixed';  // Avoid scrolling to bottom
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        const successful = document.execCommand('copy');
                        const msg = successful ? 'successful' : 'unsuccessful';
                        console.log('Fallback copying text command was ' + msg);
                        
                        // Visual feedback
                        const originalText = newCopyButton.textContent;
                        newCopyButton.textContent = "Copied!";
                        setTimeout(function() {
                            newCopyButton.textContent = originalText;
                        }, 2000);
                    } catch (err) {
                        console.error('Fallback: Unable to copy', err);
                        
                        // Try the Clipboard API as backup
                        try {
                            navigator.clipboard.writeText(prompt)
                                .then(function() {
                                    console.log('Async: Copying to clipboard was successful!');
                                    const originalText = newCopyButton.textContent;
                                    newCopyButton.textContent = "Copied!";
                                    setTimeout(function() {
                                        newCopyButton.textContent = originalText;
                                    }, 2000);
                                })
                                .catch(function(err) {
                                    console.error('Async: Could not copy text: ', err);
                                    alert('Failed to copy. Please manually copy the text from the prompt box.');
                                });
                        } catch (clipboardErr) {
                            console.error('Both clipboard methods failed:', clipboardErr);
                            alert('Failed to copy. Please manually copy the text from the prompt box.');
                        }
                    }
                    
                    document.body.removeChild(textArea);
                });
                
                console.log('Copy button event listener attached');
            } else {
                console.error('Copy button not found in the DOM');
            }
        }, 500); // Short delay to ensure DOM is fully processed
    });
    </script>
        
        <!-- Chart Modal for enlarged view -->
        <div id="chart-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-4 w-11/12 h-5/6 max-w-6xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modal-chart-title" class="text-xl font-bold">Chart Details</h2>
                    <button id="close-chart-modal" class="text-gray-600 hover:text-gray-900">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="h-5/6 w-full">
                    <canvas id="modal-chart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-100 border-t mt-12 py-6 px-4">
        <div class="container mx-auto">
            <p class="text-gray-600">© 2025 Economics Department</p>
        </div>
    </footer>

<!-- JavaScript for functionality -->
    <script>

// Update the initCharts function to set state name
function initCharts() {
    const timeRangeSelect = document.getElementById('time-range');
    timeRangeMonths = parseInt(timeRangeSelect.value);
    
    // If we have data, process it and try to set state name
    if (housingData) {
        processHousingData();
        
        // Try to extract state name from data
        try {
            if (housingData.length > 0) {
                // Look for state name in the data
                for (const key in housingData[0]) {
                    if ((key.toLowerCase().includes('state') || 
                         key.toLowerCase().includes('region')) && 
                        housingData[0][key]) {
                        const stateName = housingData[0][key];
                        // Update state name in UI
                        document.getElementById('state-name').textContent = stateName;
                        document.getElementById('ai-state-name').textContent = stateName;
                        break;
                    }
                }
            }
        } catch (e) {
            console.error('Could not determine state name:', e);
        }
    } else {
        // Otherwise use sample data
        useSampleData();
    }
    
    // Add event listener for time range changes
    timeRangeSelect.addEventListener('change', function() {
        timeRangeMonths = parseInt(this.value);
        if (housingData) {
            processHousingData();
        } else {
            useSampleData();
        }
    });
    
    // Add maximize buttons to all charts
    addMaximizeButtonsToCharts();
}

        document.addEventListener('DOMContentLoaded', function() {
            // Step navigation
            const navButtons = document.querySelectorAll('.step-nav');
            const stepContents = document.querySelectorAll('.step-content');
            
            function showStep(stepId) {
                // Hide all step contents
                stepContents.forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Remove active class from all nav buttons
                navButtons.forEach(btn => {
                    btn.classList.remove('border-blue-600', 'text-blue-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                
                // Show the selected step content
                document.getElementById('step-' + stepId).classList.remove('hidden');
                
                // Add active class to the clicked nav button
                document.getElementById('nav-' + stepId).classList.add('border-blue-600', 'text-blue-600');
                document.getElementById('nav-' + stepId).classList.remove('border-transparent', 'text-gray-500');
            }
            
            // Add click event to nav buttons
            navButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const stepId = this.id.replace('nav-', '');
                    showStep(stepId);
                });
            });
            
            // Navigation button events
            document.getElementById('next-upload').addEventListener('click', function() {
                showStep('upload');
            });
            
            document.getElementById('back-to-instructions').addEventListener('click', function() {
                showStep('instructions');
            });
            
            document.getElementById('next-to-analysis').addEventListener('click', function() {
                showStep('analysis');
                initCharts(); // Initialize charts when showing the analysis step
            });
            
            document.getElementById('back-to-upload').addEventListener('click', function() {
                showStep('upload');
            });
            
            document.getElementById('finish-activity').addEventListener('click', function() {
            showStep('ai-response');
            });
            
            document.getElementById('close-modal').addEventListener('click', function() {
                document.getElementById('completion-modal').classList.add('hidden');
                window.location.href = 'index.html';
            });

            // Add this handler for the submit button in step 4
            document.getElementById('submit-ai-response').addEventListener('click', function() {
                // Handle submission without showing modal
                alert('Analysis submitted successfully! Thank you for completing the activity.');
                // Redirect if needed
                // window.location.href = 'index.html';
            });
            
            // Add modal close functionality
            document.getElementById('close-chart-modal').addEventListener('click', function() {
                document.getElementById('chart-modal').classList.add('hidden');
            });

            document.getElementById('back-to-analysis').addEventListener('click', function() {
            showStep('analysis');
            });
            
            // File upload handling
            let housingData = null;
            
            document.getElementById('upload-btn').addEventListener('click', function() {
                document.getElementById('file-input').click();
            });
            
            document.getElementById('file-input').addEventListener('change', async function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    try {
                        // Display file as uploaded
                        document.getElementById('upload-area').classList.add('hidden');
                        document.getElementById('file-uploaded').classList.remove('hidden');
                        document.getElementById('filename').textContent = file.name;
                        document.getElementById('file-stats').textContent = 'Loading data...';
                        
                        // Read the file
                        const arrayBuffer = await file.arrayBuffer();
                        const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                        
                        // Get the first sheet
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        housingData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        // Update file stats
                        document.getElementById('file-stats').textContent = 
                            `File loaded successfully: ${housingData.length} rows of data. Click "Next" to analyze the data.`;
                        
                        // Show data preview
                        document.getElementById('data-preview').classList.remove('hidden');
                        createDataPreview(housingData);
                        
                        // Enable the next button
                        document.getElementById('next-to-analysis').disabled = false;
                        
                    } catch (error) {
                        console.error('Error processing file:', error);
                        document.getElementById('file-stats').textContent = 
                            'Error processing file. Please make sure it is a valid Excel file from Redfin.';
                    }
                }
            });
            
            document.getElementById('remove-file').addEventListener('click', function() {
                document.getElementById('file-input').value = '';
                document.getElementById('upload-area').classList.remove('hidden');
                document.getElementById('file-uploaded').classList.add('hidden');
                document.getElementById('data-preview').classList.add('hidden');
                housingData = null;
                document.getElementById('next-to-analysis').disabled = true;
            });
            
            // Create data preview table
            function createDataPreview(data) {
                if (!data || data.length === 0) return;
                
                const previewTable = document.getElementById('preview-table');
                const headerRow = previewTable.querySelector('thead tr');
                const tbody = previewTable.querySelector('tbody');
                
                // Clear existing table
                headerRow.innerHTML = '';
                tbody.innerHTML = '';
                
                // Get the column names from the first row
                const columns = Object.keys(data[0]);
                
                // Add headers
                columns.forEach(column => {
                    const th = document.createElement('th');
                    th.textContent = column;
                    th.className = 'p-2 border text-left';
                    headerRow.appendChild(th);
                });
                
                // Add rows (just first 3 for preview)
                for (let i = 0; i < Math.min(3, data.length); i++) {
                    const tr = document.createElement('tr');
                    columns.forEach(column => {
                        const td = document.createElement('td');
                        td.textContent = data[i][column];
                        td.className = 'p-2 border';
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                }
            }
            
            // Analysis calculations
            const weightInputs = document.querySelectorAll('.weight-input');
            const valueInputs = document.querySelectorAll('.value-input');
            
            // Add validation for weight and value inputs
            weightInputs.forEach(input => {
                input.addEventListener('change', function() {
                    // Enforce min and max values
                    const min = parseInt(this.min) || 0;
                    const max = parseInt(this.max) || 100;
                    
                    if (this.value === '' || isNaN(this.value)) {
                        this.value = 0;
                    } else {
                        const value = parseInt(this.value);
                        if (value < min) this.value = min;
                        if (value > max) this.value = max;
                    }
                    
                    updateWeightedValues();
                });
            });

            valueInputs.forEach(input => {
                input.addEventListener('change', function() {
                    // Enforce min and max values
                    const min = parseInt(this.min) || 1;
                    const max = parseInt(this.max) || 100;
                    
                    if (this.value === '' || isNaN(this.value)) {
                        this.value = min;
                    } else {
                        const value = parseInt(this.value);
                        if (value < min) this.value = min;
                        if (value > max) this.value = max;
                    }
                    
                    updateWeightedValues();
                });
            });
            
            function updateWeightedValues() {
                let totalWeight = 0;
                let totalWeightedValue = 0;
                
                weightInputs.forEach(input => {
                    const metric = input.dataset.metric;
                    // Enforce min/max values during calculation
                    let weight = parseFloat(input.value) || 0;
                    weight = Math.max(0, Math.min(100, weight)); // Ensure weight is between 0-100
                    
                    const valueInput = document.querySelector(`.value-input[data-metric="${metric}"]`);
                    let value = parseFloat(valueInput.value) || 0;
                    value = Math.max(1, Math.min(100, value)); // Ensure value is between 1-100
                    
                    const weightedValue = (weight / 100) * value;
                    
                    // Update all weighted value displays for this metric
                    document.querySelectorAll(`.weighted-value[data-metric="${metric}"]`).forEach(el => {
                        el.textContent = weightedValue.toFixed(2);
                    });
                    
                    totalWeight += weight;
                    totalWeightedValue += weightedValue;
                });
                
                // Update totals
                document.getElementById('total-weight').textContent = totalWeight;
                document.getElementById('total-weighted-value').textContent = totalWeightedValue.toFixed(2);
                document.getElementById('final-score').textContent = totalWeightedValue.toFixed(2);
                document.getElementById('modal-score').textContent = totalWeightedValue.toFixed(2);
                
                // Update score marker position (0-100%)
                document.getElementById('score-marker').style.left = `${totalWeightedValue}%`;
                
                // Show/hide weight warning
                if (totalWeight !== 100) {
                    document.getElementById('weight-warning').classList.remove('hidden');
                } else {
                    document.getElementById('weight-warning').classList.add('hidden');
                }
                
                // Update market type
                const marketType = totalWeightedValue < 40 ? 'buyers' : totalWeightedValue > 60 ? 'sellers' : 'balanced';
                document.getElementById('market-type').textContent = marketType;
                document.getElementById('modal-market-type').textContent = marketType;
            }
            
            // Initialize charts
            let priceChart, supplyChart, daysChart, saleToListChart, priceDropsChart;
            let selectedState = '';
            let timeRangeMonths = 60; // Default time range (5 years)
            
            function initCharts() {
                const timeRangeSelect = document.getElementById('time-range');
                timeRangeMonths = parseInt(timeRangeSelect.value);
                
                // If we have data, process it
                if (housingData) {
                    processHousingData();
                } else {
                    // Otherwise use sample data
                    useSampleData();
                }
                
                // Add event listener for time range changes
                timeRangeSelect.addEventListener('change', function() {
                    timeRangeMonths = parseInt(this.value);
                    if (housingData) {
                        processHousingData();
                    } else {
                        useSampleData();
                    }
                });
                
                // Add maximize buttons to all charts
                addMaximizeButtonsToCharts();
            }
            
            // Function to add maximize buttons to charts
            function addMaximizeButtonsToCharts() {
                const chartContainers = document.querySelectorAll('.chart-container');
                chartContainers.forEach(container => {
                    const canvas = container.querySelector('canvas');
                    if (!canvas) return;
                    
                    // Add maximize button if not already present
                    if (!container.querySelector('.maximize-btn')) {
                        const btn = document.createElement('button');
                        btn.className = 'maximize-btn absolute top-2 right-2 bg-gray-200 hover:bg-gray-300 rounded-full p-1 z-10';
                        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3h6m0 0v6m0-6L9 15M5 21h6m0 0v-6m0 6L3 9" /></svg>';
                        btn.setAttribute('data-chart-id', canvas.id);
                        btn.onclick = function() { maximizeChart(this.getAttribute('data-chart-id')); };
                        container.appendChild(btn);
                    }
                });
            }
            
            // Function to maximize a chart
            function maximizeChart(chartId) {
                const modal = document.getElementById('chart-modal');
                const modalTitle = document.getElementById('modal-chart-title');
                const modalCanvas = document.getElementById('modal-chart');
                
                // Set title based on chart type
                const titleMap = {
                    'priceChart': 'Median Sale Price',
                    'supplyChart': 'Months\' Supply',
                    'daysChart': 'Days on Market',
                    'saleToListChart': 'Sale-to-List Ratio',
                    'priceDropsChart': 'Price Drops'
                };
                
                modalTitle.textContent = titleMap[chartId] || 'Chart Details';
                
                // Clone the chart data and options
                const sourceChart = Chart.getChart(chartId);
                if (!sourceChart) {
                    console.error(`Chart not found with id: ${chartId}`);
                    return;
                }
                
                // Clear any existing chart in the modal
                if (Chart.getChart('modal-chart')) {
                    Chart.getChart('modal-chart').destroy();
                }
                
                // Create new chart in the modal
                new Chart(modalCanvas, {
                    type: sourceChart.config.type,
                    data: JSON.parse(JSON.stringify(sourceChart.data)),
                    options: {
                        ...JSON.parse(JSON.stringify(sourceChart.options)),
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                enabled: true,
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
                
                // Show the modal
                modal.classList.remove('hidden');
            }
            
            function processHousingData() {
                console.log("Processing housing data:", housingData);
                
                try {
                    // Step 1: Identify column names in the data
                    if (!housingData || housingData.length === 0) {
                        console.error("No housing data available");
                        useSampleData();
                        return;
                    }
                    
                    // Get the first row to examine columns
                    const firstRow = housingData[0];
                    console.log("First data row:", firstRow);
                    
                    // Map standard column names to whatever is in the file
                    const columnMap = {
                        date: findColumn(firstRow, ['Period Begin', 'Month of Period End', 'Date', 'Period End']),
                        price: findColumn(firstRow, ['Median Sale Price', 'median_sale_price', 'MedianSalePrice']),
                        days: findColumn(firstRow, ['Days on Market (Median)', 'Days on Market', 'median_days_on_market', 'DaysOnMarket']),
                        saleToList: findColumn(firstRow, ['Average Sale To List', 'Sale-to-List', 'sale_to_list_ratio', 'SaleToList']),
                        monthsSupply: findColumn(firstRow, ['Months of Supply', 'months_of_supply', 'MonthsSupply']),
                        inventory: findColumn(firstRow, ['Inventory', 'inventory']),
                        homesSold: findColumn(firstRow, ['Homes Sold', 'homes_sold', 'HomesSold']),
                        priceDrops: findColumn(firstRow, ['Price Drops', 'price_drops_pct', 'Price Reduced', 'PriceDrops'])
                    };
                    
                    console.log("Column mapping:", columnMap);
                    
                    // Step 2: Make sure we have at least date and price columns
                    if (!columnMap.date || !columnMap.price) {
                        console.error("Required columns not found in data");
                        useSampleData();
                        return;
                    }
                    
                    // Step 3: Sort the data by date
                    housingData.sort((a, b) => {
                        const dateA = new Date(a[columnMap.date]);
                        const dateB = new Date(b[columnMap.date]);
                        return dateA - dateB;
                    });
                    
                    // Step 4: Filter by time range if needed
                    let filteredData = [...housingData];
                    if (timeRangeMonths !== 'all' && filteredData.length > timeRangeMonths) {
                        filteredData = filteredData.slice(-timeRangeMonths);
                    }
                    
                    console.log("Filtered data:", filteredData);
                    
                    // Step 5: Extract data series for charts
                    const dates = filteredData.map(row => formatDate(row[columnMap.date]));
                    const prices = filteredData.map(row => parseFloat(row[columnMap.price]) || 0);
                    
                    const daysOnMarket = filteredData.map(row => {
                        return columnMap.days ? parseFloat(row[columnMap.days]) || 0 : null;
                    });
                    
                    const saleToList = filteredData.map(row => {
                        if (!columnMap.saleToList) return null;
                        const value = parseFloat(row[columnMap.saleToList]) || 0;
                        // Convert to percentage if needed
                        return value < 5 ? value * 100 : value;
                    });
                    
                    const monthsSupply = filteredData.map(row => {
                        if (columnMap.monthsSupply) {
                            return parseFloat(row[columnMap.monthsSupply]) || 0;
                        } else if (columnMap.inventory && columnMap.homesSold) {
                            const inventory = parseFloat(row[columnMap.inventory]) || 0;
                            const homesSold = parseFloat(row[columnMap.homesSold]) || 1; // Avoid division by zero
                            return inventory / homesSold;
                        }
                        return null;
                    });
                    
                    const priceDrops = filteredData.map(row => {
                        if (columnMap.priceDrops) {
                            return parseFloat(row[columnMap.priceDrops]) || 0;
                        }
                        return null;
                    });
                    
                    console.log("Extracted data series:", {
                        dates,
                        prices,
                        daysOnMarket,
                        saleToList,
                        monthsSupply,
                        priceDrops
                    });
                    
                    // Step 6: Create or update charts
                    updateMedianPriceChart(dates, prices);
                    
                    if (monthsSupply.some(value => value !== null)) {
                        updateMonthsSupplyChart(dates, monthsSupply);
                    }
                    
                    if (daysOnMarket.some(value => value !== null)) {
                        updateDaysOnMarketChart(dates, daysOnMarket);
                    }
                    
                    if (saleToList.some(value => value !== null)) {
                        updateSaleToListChart(dates, saleToList);
                    }
                    
                    if (priceDrops.some(value => value !== null)) {
                        updatePriceDropsChart(dates, priceDrops);
                    }
                    
                    // Step 7: Update the current value displays
                    if (filteredData.length > 0) {
                        const latestData = filteredData[filteredData.length - 1];
                        
                        // Price
                        const currentPrice = parseFloat(latestData[columnMap.price]) || 0;
                        document.getElementById('price-value').textContent = formatCurrency(currentPrice);
                        
                        // Growth rate calculation
                        if (filteredData.length > 12) {
                            const yearAgoIndex = Math.max(0, filteredData.length - 13);
                            const yearAgoPrice = parseFloat(filteredData[yearAgoIndex][columnMap.price]) || 0;
                            if (yearAgoPrice > 0) {
                                const growthRate = ((currentPrice / yearAgoPrice) - 1) * 100;
                                document.getElementById('price-growth').textContent = growthRate.toFixed(1) + '%';
                            }
                        }
                        
                        // Days on market
                        if (columnMap.days) {
                            const daysValue = parseFloat(latestData[columnMap.days]) || 0;
                            document.getElementById('days-value').textContent = daysValue.toFixed(0);
                        }
                        
                        // Sale to list
                        if (columnMap.saleToList) {
                            let saleToListValue = parseFloat(latestData[columnMap.saleToList]) || 0;
                            if (saleToListValue < 5) saleToListValue *= 100; // Convert to percentage if needed
                            document.getElementById('sale-to-list-value').textContent = saleToListValue.toFixed(1) + '%';
                        }
                        
                        // Months supply
                        let supplyValue = 0;
                        if (columnMap.monthsSupply) {
                            supplyValue = parseFloat(latestData[columnMap.monthsSupply]) || 0;
                        } else if (columnMap.inventory && columnMap.homesSold) {
                            const inventory = parseFloat(latestData[columnMap.inventory]) || 0;
                            const homesSold = parseFloat(latestData[columnMap.homesSold]) || 1; // Avoid division by zero
                            supplyValue = inventory / homesSold;
                        }
                        document.getElementById('supply-value').textContent = supplyValue.toFixed(1);
                        
                        // Price drops
                        if (columnMap.priceDrops) {
                            const dropValue = parseFloat(latestData[columnMap.priceDrops]) || 0;
                            document.getElementById('price-drops-value').textContent = dropValue.toFixed(1) + '%';
                        }
                    }
                    
                } catch (error) {
                    console.error('Error processing housing data:', error);
                    useSampleData();
                }
            }
            
            // Helper function to find a column name from possible alternatives
            function findColumn(row, possibleNames) {
                for (const name of possibleNames) {
                    if (row.hasOwnProperty(name)) {
                        return name;
                    }
                }
                return null;
            }
            
            // Helper function to format dates consistently
            function formatDate(dateString) {
                try {
                    const date = new Date(dateString);
                    const options = { year: 'numeric', month: 'short' };
                    return date.toLocaleDateString('en-US', options);
                } catch (e) {
                    return dateString; // Return as-is if parsing fails
                }
            }
            
            // Helper function to format currency
            function formatCurrency(value) {
                return new Intl.NumberFormat('en-US').format(value);
            }
            
            function updateMedianPriceChart(dates, prices) {
                console.log("Updating median price chart with:", { dates, prices });
                
                const ctx = document.getElementById('priceChart');
                if (!ctx) {
                    console.error("Price chart canvas element not found");
                    return;
                }
                
                // Verify we have data to show
                if (!dates.length || !prices.length) {
                    console.error("No data available for price chart");
                    return;
                }
                
                // Clear any existing chart
                if (priceChart) {
                    priceChart.destroy();
                }
                
                // Make sure data is numeric
                const numericPrices = prices.map(p => typeof p === 'number' ? p : parseFloat(p) || 0);
                
                // Create balanced market reference lines
                const balancedGrowthMin = []; // 3% growth line
                const balancedGrowthMax = []; // 5% growth line
                
                if (numericPrices.length > 0 && numericPrices[0] > 0) {
                    // Use the first price as the starting point
                    const startPrice = numericPrices[0];
                    for (let i = 0; i < dates.length; i++) {
                        // Calculate 3% annual growth (0.25% monthly compound)
                        balancedGrowthMin.push(startPrice * Math.pow(1.0025, i));
                        // Calculate 5% annual growth (0.4% monthly compound)
                        balancedGrowthMax.push(startPrice * Math.pow(1.004, i));
                    }
                }
                
                // Fill area between balanced min and max with a color
                const balancedAreaData = numericPrices.map((_, i) => {
                    if (i < balancedGrowthMin.length && i < balancedGrowthMax.length) {
                        return balancedGrowthMax[i];
                    }
                    return null;
                });
                
                // Create new chart
                try {
                    priceChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [
                            {
                                label: 'Balanced Range (3-5% Growth)',
                                data: balancedAreaData,
                                borderColor: 'rgba(34, 197, 94, 0)',
                                backgroundColor: 'rgba(34, 197, 94, 0.2)',
                                pointRadius: 0,
                                fill: '+1',
                                order: 3
                            },
                            {
                                label: 'Balanced Min (3% Growth)',
                                data: balancedGrowthMin,
                                borderColor: 'rgba(34, 197, 94, 0.7)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: false,
                                order: 2
                            },
                            {
                                label: 'Balanced Max (5% Growth)',
                                data: balancedGrowthMax,
                                borderColor: 'rgba(34, 197, 94, 0.7)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: '-1', // Fill to the previous dataset
                                order: 1
                            },
                            {
                                label: `Median Sale Price ($)`,
                                data: numericPrices,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                borderWidth: 2,
                                tension: 0.1,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                                order: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    display: false,
                                    position: 'top'
                                },
                                tooltip: {
                                    enabled: true,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += new Intl.NumberFormat('en-US', { 
                                                    style: 'currency', 
                                                    currency: 'USD',
                                                    maximumFractionDigits: 0
                                                }).format(context.parsed.y);
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value.toLocaleString();
                                        }
                                    }
                                }
                            }
                        }
                    });
                    console.log("Price chart created successfully");
                } catch (error) {
                    console.error("Error creating price chart:", error);
                }
            }
            
            function updateMonthsSupplyChart(dates, monthsSupply) {
                const ctx = document.getElementById('supplyChart');
                if (!ctx) {
                    console.error("Supply chart canvas element not found");
                    return;
                }
                
                // Verify we have data to show
                if (!dates.length || !monthsSupply.some(value => value !== null)) {
                    console.error("No data available for months supply chart");
                    return;
                }
                
                // Clear any existing chart
                if (supplyChart) {
                    supplyChart.destroy();
                }
                
                // Make sure data is numeric
                const numericData = monthsSupply.map(p => typeof p === 'number' ? p : parseFloat(p) || 0);
                
                // Create balanced market reference area data
                const balancedMin = Array(dates.length).fill(4);
                const balancedMax = Array(dates.length).fill(6);
                const balancedAreaData = balancedMax.slice(); // Copy max for filling
                
                // Create new chart
                try {
                    supplyChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [
                            {
                                label: 'Balanced Range (4-6 months)',
                                data: balancedAreaData,
                                borderColor: 'rgba(34, 197, 94, 0)',
                                backgroundColor: 'rgba(34, 197, 94, 0.2)',
                                pointRadius: 0,
                                fill: '+1',
                                order: 3
                            },
                            {
                                label: 'Balanced Min (4 months)',
                                data: balancedMin,
                                borderColor: 'rgba(34, 197, 94, 0.7)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: false,
                                order: 2
                            },
                            {
                                label: 'Balanced Max (6 months)',
                                data: balancedMax,
                                borderColor: 'rgba(34, 197, 94, 0.7)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: '-1',
                                order: 1
                            },
                            {
                                label: 'Months of Supply',
                                data: numericData,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                borderWidth: 2,
                                tension: 0.1,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                                order: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    display: false,
                                    position: 'top'
                                },
                                tooltip: {
                                    enabled: true,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += context.parsed.y.toFixed(1) + ' months';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Months'
                                    }
                                }
                            }
                        }
                    });
                    console.log("Months supply chart created successfully");
                } catch (error) {
                    console.error("Error creating months supply chart:", error);
                }
            }
            
            function updateDaysOnMarketChart(dates, daysOnMarket) {
                const ctx = document.getElementById('daysChart');
                if (!ctx) {
                    console.error("Days chart canvas element not found");
                    return;
                }
                
                // Verify we have data to show
                if (!dates.length || !daysOnMarket.some(value => value !== null)) {
                    console.error("No data available for days on market chart");
                    return;
                }
                
                // Clear any existing chart
                if (daysChart) {
                    daysChart.destroy();
                }
                
                // Make sure data is numeric
                const numericData = daysOnMarket.map(p => typeof p === 'number' ? p : parseFloat(p) || 0);
                
                // Create balanced market reference lines
                const balancedMin = Array(dates.length).fill(30);
                const balancedMax = Array(dates.length).fill(60);
                const balancedAreaData = balancedMax.slice(); // Copy max for filling
                
                // Create new chart
                try {
                    daysChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [
                            {
                                label: 'Balanced Range (30-60 days)',
                                data: balancedAreaData,
                                borderColor: 'rgba(34, 197, 94, 0)',
                                backgroundColor: 'rgba(34, 197, 94, 0.2)',
                                pointRadius: 0,
                                fill: '+1',
                                order: 3
                            },
                            {
                                label: 'Balanced Min (30 days)',
                                data: balancedMin,
                                borderColor: 'rgba(34, 197, 94, 0.7)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: false,
                                order: 2
                            },
                            {
                                label: 'Balanced Max (60 days)',
                                data: balancedMax,
                                borderColor: 'rgba(34, 197, 94, 0.7)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: '-1',
                                order: 1
                            },
                            {
                                label: 'Days on Market',
                                data: numericData,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                borderWidth: 2,
                                tension: 0.1,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                                order: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    display: false,
                                    position: 'top'
                                },
                                tooltip: {
                                    enabled: true,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += context.parsed.y.toFixed(0) + ' days';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Days'
                                    }
                                }
                            }
                        }
                    });
                    console.log("Days on market chart created successfully");
                } catch (error) {
                    console.error("Error creating days on market chart:", error);
                }
            }
            
            function updateSaleToListChart(dates, saleToList) {
                const ctx = document.getElementById('saleToListChart');
                if (!ctx) {
                    console.error("Sale-to-list chart canvas element not found");
                    return;
                }
                
                // Verify we have data to show
                if (!dates.length || !saleToList.some(value => value !== null)) {
                    console.error("No data available for sale-to-list chart");
                    return;
                }
                
                // Clear any existing chart
                if (saleToListChart) {
                    saleToListChart.destroy();
                }
                
                // Make sure data is numeric
                const numericData = saleToList.map(p => typeof p === 'number' ? p : parseFloat(p) || 0);
                
                // Create balanced market reference lines
                const balancedMin = Array(dates.length).fill(98);
                const balancedMax = Array(dates.length).fill(102);
                const balancedAreaData = balancedMax.slice(); // Copy max for filling
                
                // Create new chart
                try {
                    saleToListChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [
                            {
                                label: 'Balanced Range (98-102%)',
                                data: balancedAreaData,
                                borderColor: 'rgba(34, 197, 94, 0)',
                                backgroundColor: 'rgba(34, 197, 94, 0.2)',
                                pointRadius: 0,
                                fill: '+1',
                                order: 3
                            },
                            {
                                label: 'Balanced Min (98%)',
                                data: balancedMin,
                                borderColor: 'rgba(34, 197, 94, 0.7)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: false,
                                order: 2
                            },
                            {
                                label: 'Balanced Max (102%)',
                                data: balancedMax,
                                borderColor: 'rgba(34, 197, 94, 0.7)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: '-1',
                                order: 1
                            },
                            {
                                label: 'Sale-to-List Ratio',
                                data: numericData,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                borderWidth: 2,
                                tension: 0.1,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                                order: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    display: false,
                                    position: 'top'
                                },
                                tooltip: {
                                    enabled: true,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += context.parsed.y.toFixed(1) + '%';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    title: {
                                        display: true,
                                        text: 'Percentage'
                                    }
                                }
                            }
                        }
                    });
                    console.log("Sale-to-list chart created successfully");
                } catch (error) {
                    console.error("Error creating sale-to-list chart:", error);
                }
            }
            
            function updatePriceDropsChart(dates, priceDrops) {
                const ctx = document.getElementById('priceDropsChart');
                if (!ctx) {
                    console.error("Price drops chart canvas element not found");
                    return;
                }
                
                // Verify we have data to show
                if (!dates.length || !priceDrops.some(value => value !== null)) {
                    console.error("No data available for price drops chart");
                    return;
                }
                
                // Clear any existing chart
                if (priceDropsChart) {
                    priceDropsChart.destroy();
                }
                
                // Make sure data is numeric
                const numericData = priceDrops.map(p => typeof p === 'number' ? p : parseFloat(p) || 0);
                
                // Create balanced market reference lines
                const balancedMin = Array(dates.length).fill(10);
                const balancedMax = Array(dates.length).fill(20);
                const balancedAreaData = balancedMax.slice(); // Copy max for filling
                
                // Create new chart
                try {
                    priceDropsChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [
                            {
                                label: 'Balanced Range (10-20%)',
                                data: balancedAreaData,
                                borderColor: 'rgba(34, 197, 94, 0)',
                                backgroundColor: 'rgba(34, 197, 94, 0.2)',
                                pointRadius: 0,
                                fill: '+1',
                                order: 3
                            },
                            {
                                label: 'Balanced Min (10%)',
                                data: balancedMin,
                                borderColor: 'rgba(34, 197, 94, 0.7)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: false,
                                order: 2
                            },
                            {
                                label: 'Balanced Max (20%)',
                                data: balancedMax,
                                borderColor: 'rgba(34, 197, 94, 0.7)',
                                borderWidth: 1,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: '-1',
                                order: 1
                            },
                            {
                                label: 'Price Drops',
                                data: numericData,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                borderWidth: 2,
                                tension: 0.1,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                                order: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    display: false,
                                    position: 'top'
                                },
                                tooltip: {
                                    enabled: true,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += context.parsed.y.toFixed(1) + '%';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Percentage'
                                    }
                                }
                            }
                        }
                    });
                    console.log("Price drops chart created successfully");
                } catch (error) {
                    console.error("Error creating price drops chart:", error);
                }
            }
            
            function useSampleData() {
                // Sample data for charts if real data loading fails
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const currentYear = new Date().getFullYear();
                const lastYear = currentYear - 1;
                
                const dates = [
                    ...months.map(m => `${m} ${lastYear}`),
                    ...months.map(m => `${m} ${currentYear}`).slice(0, 6)
                ];
                
                const prices = [350000, 355000, 360000, 365000, 370000, 380000, 385000, 390000, 395000, 400000, 405000, 410000, 412000, 415000, 420000, 425000, 430000, 432000];
                const monthsSupply = [3.2, 3.0, 2.8, 2.5, 2.2, 2.0, 1.8, 1.7, 1.5, 1.4, 1.3, 1.2, 1.1, 1.0, 0.9, 0.8, 0.7, 0.6];
                const daysOnMarket = [25, 23, 20, 18, 15, 14, 13, 12, 11, 10, 9, 8, 7, 7, 6, 6, 5, 5];
                const saleToList = [100.5, 101.2, 102.0, 101.8, 101.0, 100.7, 100.5, 101.0, 101.5, 102.0, 102.5, 103.0, 103.5, 104.0, 104.5, 105.0, 105.5, 106.0];
                const priceDrops = [12, 11, 9, 8, 7, 6, 5, 4, 3, 3, 2, 2, 2, 1, 1, 1, 1, 0];
                
                updateMedianPriceChart(dates, prices);
                updateMonthsSupplyChart(dates, monthsSupply);
                updateDaysOnMarketChart(dates, daysOnMarket);
                updateSaleToListChart(dates, saleToList);
                updatePriceDropsChart(dates, priceDrops);
                
                // Format price with commas
                const formatter = new Intl.NumberFormat('en-US');
                document.getElementById('price-value').textContent = formatter.format(432000);
                
                // Update current value displays with sample data
                document.getElementById('price-growth').textContent = '+6.2%';
                document.getElementById('supply-value').textContent = '0.6';
                document.getElementById('days-value').textContent = '5';
                document.getElementById('sale-to-list-value').textContent = '106.0%';
                document.getElementById('price-drops-value').textContent = '0%';
            }
            
            // Initialize weighted values on page load
            updateWeightedValues();
        });
        // Add this debugging code at the bottom of your script section
document.addEventListener('DOMContentLoaded', function() {
  // Wait a bit for everything to load
  setTimeout(function() {
    console.log("DEBUG: Checking chart visibility");
    
    // Check if chart canvases exist
    const chartCanvases = ['priceChart', 'supplyChart', 'daysChart', 'saleToListChart'];
    chartCanvases.forEach(id => {
      const canvas = document.getElementById(id);
      console.log(`Chart canvas ${id} exists:`, !!canvas);
      if (canvas) {
        // Check dimensions
        const width = canvas.width;
        const height = canvas.height;
        console.log(`Chart ${id} dimensions:`, width, 'x', height);
        
        // Check if parent container is visible
        const container = canvas.closest('.chart-container');
        if (container) {
          const style = window.getComputedStyle(container);
          console.log(`Chart container visible:`, style.display !== 'none', style.visibility !== 'hidden');
          console.log(`Chart container dimensions:`, container.offsetWidth, 'x', container.offsetHeight);
        }
      }
    });
    
    // Attempt to force chart updates
    if (typeof priceChart !== 'undefined' && priceChart) {
      console.log("Attempting to force update price chart");
      priceChart.update();
    }
  }, 1000);
});

    </script>
</body>
</html>