<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Odyssey - Database Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="../../styles.css">
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header>
        <div class="banner-container">
            <img src="../../images/banner15.png" alt="Investment Odyssey Banner" class="banner-image">
            <div class="banner-overlay">
                <div class="container mx-auto">
                    <div class="nav-links">
                        <div class="nav-links-left">
                            <a href="../../index.html" class="nav-link">Home</a>
                            <a href="../../games.html" class="nav-link">Games</a>
                            <a href="index.html" class="nav-link">Play Game</a>
                            <a href="leaderboard.html" class="nav-link">Leaderboard</a>
                        </div>
                    </div>
                    <h1 class="activity-title">Investment Odyssey</h1>
                    <p class="activity-date">Database Setup</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container my-5">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">Investment Odyssey Database Setup</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h4>Database Setup Tool</h4>
                            <p>This tool will set up the necessary database tables for the Investment Odyssey game. It will:</p>
                            <ul>
                                <li>Create the game_sessions table</li>
                                <li>Create the game_states table</li>
                                <li>Create the player_states table</li>
                                <li>Create the game_participants table</li>
                                <li>Set up necessary indexes and functions</li>
                            </ul>
                            <p>Click the button below to start the setup process.</p>
                        </div>

                        <div class="text-center mb-4">
                            <button id="setup-btn" class="btn btn-primary btn-lg">
                                <i class="fas fa-database mr-2"></i> Set Up Database
                            </button>
                        </div>

                        <div id="results" class="mt-4">
                            <!-- Results will be displayed here -->
                        </div>
                    </div>
                    <div class="card-footer">
                        <a href="index.html" class="btn btn-secondary">Back to Game</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="js/supabase.js?v=6"></script>

    <!-- Setup Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const setupBtn = document.getElementById('setup-btn');
            const resultsDiv = document.getElementById('results');

            setupBtn.addEventListener('click', async function() {
                setupBtn.disabled = true;
                setupBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Setting Up Database...';
                resultsDiv.innerHTML = '<div class="alert alert-info">Setting up database tables...</div>';

                try {
                    // Initialize Supabase client
                    if (!window.supabase) {
                        throw new Error('Supabase client not available');
                    }

                    // Read the SQL file
                    const response = await fetch('db-setup.sql');
                    if (!response.ok) {
                        throw new Error(`Failed to load SQL file: ${response.status} ${response.statusText}`);
                    }
                    
                    const sqlContent = await response.text();
                    
                    // Split the SQL into statements
                    const statements = sqlContent.split(';').filter(stmt => stmt.trim().length > 0);
                    
                    resultsDiv.innerHTML += `<div class="alert alert-info">Found ${statements.length} SQL statements to execute.</div>`;
                    
                    // Execute each statement
                    for (let i = 0; i < statements.length; i++) {
                        const stmt = statements[i].trim();
                        if (!stmt) continue;
                        
                        try {
                            resultsDiv.innerHTML += `<div class="alert alert-secondary">Executing statement ${i+1}/${statements.length}...</div>`;
                            
                            // Execute the SQL statement
                            const { error } = await window.supabase.rpc('execute_sql', {
                                sql_statement: stmt
                            });
                            
                            if (error) {
                                // If the execute_sql function doesn't exist yet, we need to create it first
                                if (error.message.includes('function execute_sql') && error.message.includes('does not exist')) {
                                    resultsDiv.innerHTML += `<div class="alert alert-warning">The execute_sql function doesn't exist yet. Creating it...</div>`;
                                    
                                    // Create the execute_sql function
                                    const createFunctionSQL = `
                                        CREATE OR REPLACE FUNCTION execute_sql(sql_statement TEXT)
                                        RETURNS VOID AS $$
                                        BEGIN
                                            EXECUTE sql_statement;
                                            RETURN;
                                        END;
                                        $$ LANGUAGE plpgsql;
                                    `;
                                    
                                    // Execute the create function statement directly
                                    const { error: createError } = await window.supabase.rpc('execute_sql', {
                                        sql_statement: createFunctionSQL
                                    });
                                    
                                    if (createError) {
                                        // If we can't create the function, we'll need to use a different approach
                                        resultsDiv.innerHTML += `<div class="alert alert-danger">Failed to create execute_sql function: ${createError.message}</div>`;
                                        resultsDiv.innerHTML += `<div class="alert alert-info">Trying to execute statements directly...</div>`;
                                        
                                        // Try to execute the statement directly
                                        const { error: directError } = await window.supabase.rpc('execute_sql', {
                                            sql_statement: stmt
                                        });
                                        
                                        if (directError) {
                                            resultsDiv.innerHTML += `<div class="alert alert-danger">Failed to execute statement ${i+1}: ${directError.message}</div>`;
                                            continue;
                                        }
                                    } else {
                                        // Now try to execute the original statement again
                                        const { error: retryError } = await window.supabase.rpc('execute_sql', {
                                            sql_statement: stmt
                                        });
                                        
                                        if (retryError) {
                                            resultsDiv.innerHTML += `<div class="alert alert-danger">Failed to execute statement ${i+1}: ${retryError.message}</div>`;
                                            continue;
                                        }
                                    }
                                } else {
                                    resultsDiv.innerHTML += `<div class="alert alert-danger">Failed to execute statement ${i+1}: ${error.message}</div>`;
                                    continue;
                                }
                            }
                            
                            resultsDiv.innerHTML += `<div class="alert alert-success">Successfully executed statement ${i+1}.</div>`;
                        } catch (stmtError) {
                            resultsDiv.innerHTML += `<div class="alert alert-danger">Exception executing statement ${i+1}: ${stmtError.message}</div>`;
                        }
                    }
                    
                    resultsDiv.innerHTML += `<div class="alert alert-success">
                        <h4><i class="fas fa-check-circle mr-2"></i> Database Setup Complete</h4>
                        <p>The database tables have been set up successfully. You can now use the Investment Odyssey game.</p>
                    </div>`;
                } catch (error) {
                    resultsDiv.innerHTML += `<div class="alert alert-danger">
                        <h4><i class="fas fa-exclamation-circle mr-2"></i> Setup Failed</h4>
                        <p>${error.message}</p>
                    </div>`;
                } finally {
                    setupBtn.disabled = false;
                    setupBtn.innerHTML = '<i class="fas fa-database mr-2"></i> Set Up Database';
                }
            });
        });
    </script>
</body>
</html>
