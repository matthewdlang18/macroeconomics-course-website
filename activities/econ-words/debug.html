<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Econ Words Supabase Debug</title>
    <link rel="stylesheet" href="../../styles.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .debug-panel {
            background-color: #f4f4f4;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        button.warning {
            background-color: #ff9800;
        }
        button.danger {
            background-color: #f44336;
        }
        button.info {
            background-color: #2196F3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        code {
            font-family: Consolas, monospace;
            background-color: #e0e0e0;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .code-block {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: Consolas, monospace;
            white-space: pre;
        }
        .results {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .error { color: #f44336; }
        .success { color: #4CAF50; }
        .warning { color: #ff9800; }
        .hidden { display: none; }
        .auth-form {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        input {
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 250px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status-authenticated {
            background-color: #4CAF50;
            color: white;
        }
        .status-guest {
            background-color: #ff9800;
            color: white;
        }
        .status-none {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Econ Words Supabase Debug Tool</h1>
    <div class="debug-panel">
        <h2>Authentication Status <span id="auth-status-badge" class="status-badge status-none">Not Checked</span></h2>
        <p>Current authentication status will appear here after checking.</p>
        
        <h3>Quick Fix: Create Test User</h3>
        <div class="auth-form">
            <p>Create a test user or sign in with existing credentials:</p>
            <input type="email" id="test-email" placeholder="Email (default: test@example.com)" value="test@example.com"><br>
            <input type="password" id="test-password" placeholder="Password (default: password123)" value="password123"><br>
            <button id="create-test-user" class="warning">Create Test User</button>
            <button id="sign-in-test-user" class="info">Sign in Test User</button>
        </div>
    </div>
    
    <div class="debug-panel">
        <h2>Supabase Connection Status</h2>
        <button id="check-connection" title="Check if Supabase client is properly initialized">Check Connection</button>
        <button id="run-diagnostics" title="Run a comprehensive diagnostic check on all Supabase components">Run Full Diagnostics</button>
        <div id="connection-results" class="results hidden">Loading...</div>
    </div>
    
    <div class="debug-panel">
        <h2>Authentication</h2>
        <button id="check-auth" title="Check current authentication status">Check Auth Status</button>
        <button id="refresh-token" title="Force refresh the auth token">Refresh Token</button>
        <button id="test-auth" title="Test authentication">Test Authentication</button>
        <button id="test-auth-methods" title="Test available authentication methods">Test Auth Methods</button>
        <button id="sign-out" class="warning" title="Sign out current user">Sign Out</button>
        <div id="auth-results" class="results hidden">Loading...</div>
    </div>
    
    <div class="debug-panel">
        <h2>Database Operations</h2>
        <button id="test-select" title="Test a SELECT operation on the leaderboard table">Test SELECT</button>
        <button id="test-insert" title="Test an INSERT operation on the leaderboard table">Test INSERT</button>
        <button id="recover-failed-scores" title="Try to recover scores saved in localStorage">Recover Failed Scores</button>
        <div id="db-results" class="results hidden">Loading...</div>
    </div>
    
    <div class="debug-panel">
        <h2>RLS Policy Tests</h2>
        <button id="test-rls" title="Test if RLS policies are working correctly">Test RLS Policies</button>
        <button id="fix-rls-issues" class="warning" title="Try to fix common RLS permission issues">Fix RLS Issues</button>
        <div id="rls-results" class="results hidden">Loading...</div>
    </div>
    
    <div class="debug-panel">
        <h2>LocalStorage Data</h2>
        <button id="view-localstorage" title="View all Econ Words data in localStorage">View LocalStorage</button>
        <button id="clear-localstorage" class="danger" title="Clear all Econ Words data from localStorage">Clear LocalStorage</button>
        <div id="storage-results" class="results hidden">Loading...</div>
    </div>

    <!-- Include required scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/env.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/database.js"></script>
    <script src="js/supabase-diagnostics.js"></script>
    
    <script>
        // Wait for all scripts to load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Debug tool initialized');
            
            // Update auth status badge when page loads
            updateAuthStatusBadge();
            
            // Helper function to show results
            function showResults(elementId, content, isError = false) {
                const element = document.getElementById(elementId);
                element.classList.remove('hidden');
                
                if (typeof content === 'object') {
                    // Format JSON nicely
                    element.innerHTML = `<pre>${JSON.stringify(content, null, 2)}</pre>`;
                } else {
                    element.innerHTML = content;
                }
                
                if (isError) {
                    element.classList.add('error');
                } else {
                    element.classList.remove('error');
                }
            }
            
            // Update the authentication status badge
            async function updateAuthStatusBadge() {
                const badge = document.getElementById('auth-status-badge');
                badge.textContent = 'Checking...';
                badge.className = 'status-badge';
                
                if (!window.supabaseClient) {
                    badge.textContent = 'No Supabase Client';
                    badge.className = 'status-badge status-none';
                    return;
                }
                
                try {
                    const { data, error } = await supabaseClient.auth.getSession();
                    
                    if (error || !data?.session) {
                        // Try to check EconWordsAuth
                        if (window.EconWordsAuth && window.EconWordsAuth.isGuest) {
                            badge.textContent = 'Guest Mode';
                            badge.className = 'status-badge status-guest';
                        } else {
                            badge.textContent = 'Not Authenticated';
                            badge.className = 'status-badge status-none';
                        }
                    } else {
                        // Successfully authenticated
                        badge.textContent = 'Authenticated';
                        badge.className = 'status-badge status-authenticated';
                    }
                } catch (e) {
                    badge.textContent = 'Error Checking';
                    badge.className = 'status-badge status-none';
                }
            }
            
            // Check connection button
            document.getElementById('check-connection').addEventListener('click', function() {
                try {
                    const results = {
                        supabaseJSLoaded: typeof supabase !== 'undefined',
                        supabaseUrlDefined: !!window.supabaseUrl,
                        supabaseKeyDefined: !!window.supabaseKey,
                        clientInitialized: !!window.supabaseClient
                    };
                    
                    showResults('connection-results', results);
                } catch (error) {
                    showResults('connection-results', { error: error.message }, true);
                }
            });
            
            // Run full diagnostics
            document.getElementById('run-diagnostics').addEventListener('click', async function() {
                if (!window.SupabaseDiagnostics) {
                    showResults('connection-results', { error: 'Supabase diagnostics module not loaded' }, true);
                    return;
                }
                
                showResults('connection-results', 'Running diagnostics, please wait...');
                try {
                    const results = await window.SupabaseDiagnostics.runFullDiagnostics();
                    showResults('connection-results', results);
                    
                    // Update auth badge
                    updateAuthStatusBadge();
                } catch (error) {
                    showResults('connection-results', { error: error.message }, true);
                }
            });
            
            // Check auth status
            document.getElementById('check-auth').addEventListener('click', async function() {
                showResults('auth-results', 'Checking authentication status...');
                
                try {
                    if (!window.supabaseClient) {
                        throw new Error('Supabase client not initialized');
                    }
                    
                    const { data, error } = await supabaseClient.auth.getSession();
                    
                    if (error) {
                        showResults('auth-results', { error: error.message }, true);
                        return;
                    }
                    
                    // Get user info from EconWordsAuth if available
                    let userInfo = { fromAuthModule: 'Not available' };
                    if (window.EconWordsAuth) {
                        const currentUser = window.EconWordsAuth.getCurrentUser();
                        if (currentUser) {
                            userInfo = {
                                id: currentUser.id,
                                name: currentUser.name,
                                isGuest: currentUser.isGuest,
                                email: currentUser.email,
                                sectionId: currentUser.sectionId
                            };
                        }
                    }
                    
                    const results = {
                        fromSupabase: {
                            hasSession: !!data?.session,
                            userId: data?.session?.user?.id || 'None',
                            email: data?.session?.user?.email || 'None',
                            expiresAt: data?.session ? new Date(data.session.expires_at * 1000).toISOString() : 'N/A'
                        },
                        fromAuthModule: userInfo
                    };
                    
                    showResults('auth-results', results);
                    updateAuthStatusBadge();
                } catch (error) {
                    showResults('auth-results', { error: error.message }, true);
                }
            });
            
            // Refresh token
            document.getElementById('refresh-token').addEventListener('click', async function() {
                showResults('auth-results', 'Refreshing auth token...');
                
                try {
                    if (!window.supabaseClient) {
                        throw new Error('Supabase client not initialized');
                    }
                    
                    const { data, error } = await supabaseClient.auth.refreshSession();
                    
                    if (error) {
                        showResults('auth-results', { error: error.message }, true);
                        return;
                    }
                    
                    showResults('auth-results', {
                        success: !!data?.session,
                        newExpiresAt: data?.session ? new Date(data.session.expires_at * 1000).toISOString() : 'N/A'
                    });
                } catch (error) {
                    showResults('auth-results', { error: error.message }, true);
                }
            });
            
            // Test authentication
            document.getElementById('test-auth').addEventListener('click', async function() {
                showResults('auth-results', 'Testing authentication...');
                
                try {
                    if (!window.SupabaseDiagnostics) {
                        throw new Error('Supabase diagnostics module not loaded');
                    }
                    
                    const results = await window.SupabaseDiagnostics.testAuthentication();
                    showResults('auth-results', results);
                    updateAuthStatusBadge();
                } catch (error) {
                    showResults('auth-results', { error: error.message }, true);
                }
            });
            
            // Test auth methods
            document.getElementById('test-auth-methods').addEventListener('click', async function() {
                showResults('auth-results', 'Testing available authentication methods...');
                
                try {
                    if (!window.SupabaseDiagnostics) {
                        throw new Error('Supabase diagnostics module not loaded');
                    }
                    
                    const results = window.SupabaseDiagnostics.testAuthMethods();
                    showResults('auth-results', results);
                } catch (error) {
                    showResults('auth-results', { error: error.message }, true);
                }
            });
            
            // Create test user
            document.getElementById('create-test-user').addEventListener('click', async function() {
                const email = document.getElementById('test-email').value.trim() || 'test@example.com';
                const password = document.getElementById('test-password').value.trim() || 'password123';
                
                showResults('auth-results', `Creating test user with email: ${email}...`);
                
                try {
                    if (!window.SupabaseDiagnostics) {
                        throw new Error('Supabase diagnostics module not loaded');
                    }
                    
                    const results = await window.SupabaseDiagnostics.createTestUser(email, password);
                    showResults('auth-results', results);
                    updateAuthStatusBadge();
                    
                    // If user was created successfully, update EconWordsAuth
                    if (results.success && window.EconWordsAuth && typeof window.EconWordsAuth.init === 'function') {
                        console.log('Reinitializing EconWordsAuth module...');
                        await window.EconWordsAuth.init();
                    }
                } catch (error) {
                    showResults('auth-results', { error: error.message }, true);
                }
            });
            
            // Sign in test user
            document.getElementById('sign-in-test-user').addEventListener('click', async function() {
                const email = document.getElementById('test-email').value.trim() || 'test@example.com';
                const password = document.getElementById('test-password').value.trim() || 'password123';
                
                showResults('auth-results', `Signing in with email: ${email}...`);
                
                try {
                    if (!window.SupabaseDiagnostics) {
                        throw new Error('Supabase diagnostics module not loaded');
                    }
                    
                    const results = await window.SupabaseDiagnostics.signInTestUser(email, password);
                    showResults('auth-results', results);
                    updateAuthStatusBadge();
                    
                    // If sign in was successful, update EconWordsAuth
                    if (results.success && window.EconWordsAuth && typeof window.EconWordsAuth.init === 'function') {
                        console.log('Reinitializing EconWordsAuth module...');
                        await window.EconWordsAuth.init();
                    }
                } catch (error) {
                    showResults('auth-results', { error: error.message }, true);
                }
            });
            
            // Sign out
            document.getElementById('sign-out').addEventListener('click', async function() {
                showResults('auth-results', 'Signing out...');
                
                try {
                    if (!window.supabaseClient) {
                        throw new Error('Supabase client not initialized');
                    }
                    
                    const { error } = await supabaseClient.auth.signOut();
                    
                    if (error) {
                        showResults('auth-results', { 
                            success: false,
                            error: error.message 
                        }, true);
                    } else {
                        showResults('auth-results', { 
                            success: true,
                            message: 'Signed out successfully' 
                        });
                        
                        // Update EconWordsAuth if available
                        if (window.EconWordsAuth && typeof window.EconWordsAuth.init === 'function') {
                            console.log('Reinitializing EconWordsAuth module after sign out...');
                            await window.EconWordsAuth.init();
                        }
                    }
                    
                    updateAuthStatusBadge();
                } catch (error) {
                    showResults('auth-results', { error: error.message }, true);
                }
            });
            
            // Test select
            document.getElementById('test-select').addEventListener('click', async function() {
                showResults('db-results', 'Testing SELECT operation...');
                
                try {
                    if (!window.supabaseClient) {
                        throw new Error('Supabase client not initialized');
                    }
                    
                    // First check auth status
                    const { data: sessionData } = await supabaseClient.auth.getSession();
                    
                    // Try the query
                    const { data, error, count } = await supabaseClient
                        .from('econ_terms_leaderboard')
                        .select('*', { count: 'exact' })
                        .limit(5);
                    
                    if (error) {
                        showResults('db-results', {
                            success: false,
                            error: error.message,
                            errorCode: error.code,
                            authenticated: !!sessionData?.session,
                            isRLSError: error.code === '42501' || error.message.includes('policy') || error.message.includes('permission')
                        }, true);
                    } else {
                        showResults('db-results', {
                            success: true,
                            authenticated: !!sessionData?.session,
                            recordCount: count || 0,
                            sampleRecords: data.length > 0 ? data.slice(0, 2) : [] // Show up to 2 records
                        });
                    }
                } catch (error) {
                    showResults('db-results', { error: error.message }, true);
                }
            });
            
            // Test insert
            document.getElementById('test-insert').addEventListener('click', async function() {
                showResults('db-results', 'Testing INSERT operation...');
                
                try {
                    if (!window.supabaseClient) {
                        throw new Error('Supabase client not initialized');
                    }
                    
                    // First check auth status
                    const { data: sessionData, error: sessionError } = await supabaseClient.auth.getSession();
                    
                    if (sessionError || !sessionData?.session) {
                        showResults('db-results', {
                            success: false,
                            error: 'Not authenticated - please sign in first',
                            authenticated: false
                        }, true);
                        return;
                    }
                    
                    // Create test data
                    const testRecord = {
                        user_id: sessionData.session.user.id,
                        user_name: 'Test User',
                        score: 10,
                        term: 'TEST-DEBUG',
                        attempts: 1,
                        won: true,
                        time_taken: 5000
                    };
                    
                    // Try the insert
                    const { data, error } = await supabaseClient
                        .from('econ_terms_leaderboard')
                        .insert(testRecord)
                        .select()
                        .single();
                    
                    if (error) {
                        showResults('db-results', {
                            success: false,
                            error: error.message,
                            errorCode: error.code,
                            authenticated: true,
                            isRLSError: error.code === '42501' || error.message.includes('policy') || error.message.includes('permission'),
                            attemptedRecord: testRecord
                        }, true);
                    } else {
                        showResults('db-results', {
                            success: true,
                            message: 'Record inserted successfully',
                            insertedRecord: data,
                            notes: "Test record created. This will appear in the actual leaderboard."
                        });
                    }
                } catch (error) {
                    showResults('db-results', { error: error.message }, true);
                }
            });
            
            // Recover failed scores
            document.getElementById('recover-failed-scores').addEventListener('click', async function() {
                showResults('db-results', 'Attempting to recover failed scores...');
                
                try {
                    if (!window.EconWordsDB || typeof window.EconWordsDB.recoverFailedScores !== 'function') {
                        throw new Error('EconWordsDB module not available or missing recoverFailedScores method');
                    }
                    
                    const result = await window.EconWordsDB.recoverFailedScores();
                    showResults('db-results', result);
                } catch (error) {
                    showResults('db-results', { error: error.message }, true);
                }
            });
            
            // Test RLS policies
            document.getElementById('test-rls').addEventListener('click', async function() {
                showResults('rls-results', 'Testing RLS policies...');
                
                try {
                    if (!window.SupabaseDiagnostics) {
                        throw new Error('Supabase diagnostics module not loaded');
                    }
                    
                    // First check auth status
                    const { data: sessionData } = await supabaseClient.auth.getSession();
                    
                    // Get estimated RLS policies
                    const policies = window.SupabaseDiagnostics.checkRLSPolicies();
                    
                    // Test policy effects for authenticated operation
                    let policyTests = {};
                    
                    if (sessionData?.session) {
                        try {
                            // Test self-selection (should work if RLS allows user to see own data)
                            const { data: selectData, error: selectError } = await supabaseClient
                                .from('econ_terms_leaderboard')
                                .select('*')
                                .eq('user_id', sessionData.session.user.id)
                                .limit(1);
                                
                            policyTests.canSelectOwnRecords = !selectError;
                            
                            // Test insertion with matching user_id (should work)
                            const testRecord = {
                                user_id: sessionData.session.user.id,
                                user_name: 'RLS Test',
                                score: 1,
                                term: 'RLS-TEST',
                                attempts: 1,
                                won: true,
                                time_taken: 1000
                            };
                            
                            const { data: insertData, error: insertError } = await supabaseClient
                                .from('econ_terms_leaderboard')
                                .insert(testRecord)
                                .select()
                                .single();
                                
                            policyTests.canInsertWithOwnUserId = !insertError;
                            
                            if (!insertError && insertData.id) {
                                policyTests.insertedRecordId = insertData.id;
                                
                                // Clean up test record
                                await supabaseClient
                                    .from('econ_terms_leaderboard')
                                    .delete()
                                    .eq('id', insertData.id);
                            }
                        } catch (error) {
                            policyTests.error = error.message;
                        }
                    }
                    
                    showResults('rls-results', {
                        authenticated: !!sessionData?.session,
                        estimatedPolicies: policies,
                        policyTests: policyTests,
                        recommendedPolicies: [
                            "Enable row-level security on all tables",
                            "Create policy: Allow users to read only their own records (user_id = auth.uid())",
                            "Create policy: Allow users to insert only if user_id in the record matches auth.uid()",
                            "Create policy: Allow users to update only their own records (user_id = auth.uid())"
                        ],
                        note: "These are estimated policies. Actual RLS configuration must be done in the Supabase dashboard."
                    });
                } catch (error) {
                    showResults('rls-results', { error: error.message }, true);
                }
            });
            
            // Fix RLS issues
            document.getElementById('fix-rls-issues').addEventListener('click', function() {
                showResults('rls-results', {
                    title: "RLS Policy Fixes",
                    note: "RLS policies can only be modified in the Supabase dashboard. Here are the SQL statements you need to run in the Supabase SQL Editor:",
                    sql: `-- 1. Enable RLS on leaderboard table
ALTER TABLE econ_terms_leaderboard ENABLE ROW LEVEL SECURITY;

-- 2. Enable RLS on user stats table
ALTER TABLE econ_terms_user_stats ENABLE ROW LEVEL SECURITY;

-- 3. Create policy to allow users to view their own scores
CREATE POLICY "Users can view their own scores" ON econ_terms_leaderboard
  FOR SELECT USING (auth.uid() = user_id);

-- 4. Create policy to allow users to insert their own scores
CREATE POLICY "Users can insert their own scores" ON econ_terms_leaderboard
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- 5. Create policy to allow users to view their own stats
CREATE POLICY "Users can view their own stats" ON econ_terms_user_stats
  FOR SELECT USING (auth.uid() = user_id);

-- 6. Create policy to allow users to update their own stats
CREATE POLICY "Users can update their own stats" ON econ_terms_user_stats
  FOR UPDATE USING (auth.uid() = user_id);

-- 7. Create policy to allow users to insert their own stats
CREATE POLICY "Users can insert their own stats" ON econ_terms_user_stats
  FOR INSERT WITH CHECK (auth.uid() = user_id);`,
                    instructions: "Copy the SQL above and run it in your Supabase SQL Editor. These policies will ensure proper Row Level Security for your application."
                });
            });
            
            // View localStorage
            document.getElementById('view-localstorage').addEventListener('click', function() {
                try {
                    // Get all keys from localStorage
                    const keys = Object.keys(localStorage);
                    
                    // Filter for Econ Words related keys
                    const econWordsKeys = keys.filter(key => {
                        return key.toLowerCase().includes('econ') || 
                               key.includes('supabase') ||
                               key.includes('score') ||
                               key.includes('guest');
                    });
                    
                    // Create result object
                    const storageData = {};
                    
                    // Get values for each key
                    econWordsKeys.forEach(key => {
                        try {
                            // Try to parse JSON values
                            const value = localStorage.getItem(key);
                            try {
                                storageData[key] = JSON.parse(value);
                            } catch {
                                storageData[key] = value;
                            }
                        } catch {
                            storageData[key] = '[Error reading value]';
                        }
                    });
                    
                    showResults('storage-results', {
                        totalKeys: keys.length,
                        econWordsKeys: econWordsKeys.length,
                        data: storageData
                    });
                } catch (error) {
                    showResults('storage-results', { error: error.message }, true);
                }
            });
            
            // Clear localStorage
            document.getElementById('clear-localstorage').addEventListener('click', function() {
                try {
                    // Get all keys from localStorage
                    const keys = Object.keys(localStorage);
                    
                    // Filter for Econ Words related keys
                    const econWordsKeys = keys.filter(key => {
                        return key.toLowerCase().includes('econ') || 
                               key.includes('supabase') ||
                               key.includes('score') ||
                               key.includes('guest');
                    });
                    
                    // Remove each key
                    const removedKeys = [];
                    econWordsKeys.forEach(key => {
                        try {
                            localStorage.removeItem(key);
                            removedKeys.push(key);
                        } catch (e) {
                            console.error(`Error removing key ${key}:`, e);
                        }
                    });
                    
                    showResults('storage-results', {
                        success: true,
                        removedKeysCount: removedKeys.length,
                        removedKeys: removedKeys
                    });
                } catch (error) {
                    showResults('storage-results', { error: error.message }, true);
                }
            });
        });
    </script>
</body>
</html>
